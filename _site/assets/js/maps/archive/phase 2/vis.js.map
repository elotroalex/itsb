{"version":3,"sources":["archive/phase 2/vis.js"],"names":["String","prototype","replaceAll","search","replacement","this","replace","RegExp","DataManager","[object Object]","func","self","loading","data","idx","compiled","authors","author_names","places","datasets","q","d3","queue","forEach","d","filepath","defer","json","await","error","i","arguments","length","darg","invoke","call","keys","author_ids","k","split","trim","join","toLowerCase","PlaceName","buildAuthors","buildPlaces","date","itineraries","entry","place","PlaceID","placename","ID","Author","AuthorID","Place","StartCitation","StartDate","EndCitation","EndDate","Notes","FullEntry","lunr","id","ref","field","add","term","results","Search","html","result","push","Visualization","mode","continents","classkey","initialized","width","window","innerWidth","height","innerHeight","ttime","dm","getData","focus","process_data","setup","generate","intialized","select","style","_d","intersections","key","_key","tear_down","DateMapController","super","range","Date","date_start","date_end","init","Trajectories","trajectories","active_authors_t","map","ui","dom","view","append","attr","list","generateAuthorList","on","event","stopPropagation","unfocus","display_results","selectAll","each","elem","classed","index","indexOf","splice","update","sliderwidth","dateslider","offsetWidth","scale","time","domain","scale_axis","svg","axis","orient","ticks","tickSize","tickPadding","slide","slider","value","scale_value_converter","orientation","margin","animate","evt","v_1","v_2","update_datebar","_val","s","nice","month","invert","intersections_unique","trajectories_unique","points_target","points_g","points_backs","points_03","points_02","points_01","lines_target","lines_g","lines","projection","geo","mercator","translate","offsetHeight","path","features","topojson","feature","objects","filter_data","holder","entries","filter","n","author","b","__d","figures","Likelihood","info","lists","Object","toString","values","t","__key","tier","j","PlaceID_End","Likelihood_End","generate_lines","enter","exit","remove","source","target","p_1","p_2","Long","Lat","dx","dy","dr","Math","sqrt","generate_points","r_scale","linear","p","text","tooltip","transition","duration","rect","getBoundingClientRect","top","pageYOffset","left","pageXOffset","bottom","right","animation-direction","animaiton-play-state","animation-fill-mode","delay","_01","_02","_03","r_tot","o_scale","title","items","items_date","f","format","datestart","dateend","opp","Intersections","vetted","city","iucity","point","parentNode","__data__","Itineraries","selectedauthors","routes","visHeight","selectionsw","selections","node","console","log","akey","max","merge","header","concat","starts","ends","min","earliest_date","latest_date","cheight","route_scale","axisScale","yAxis","tickFormat","generate_route","author_id","route","w","l","route_g","route_stops","_side","curr_svg","author_name","property","left_svg","right_svg","visH","route_line_background","route_labels","route_line","route_points","route_point_labels","t1","t2","tabs","hasOwnProperty","indexData","searchfield","searchresults","DisplaySearchResults","selection","first","last","size"],"mappings":"AAQAA,OAAOC,UAAUC,WAAa,SAASC,EAAQC,GAE3C,OADaC,KACCC,QAAQ,IAAIC,OAAOJ,EAAQ,KAAMC,UAU7CI,YACJC,YAAYC,GACV,IAAIC,EAAON,KACXA,KAAKO,WACLP,KAAKQ,QACLR,KAAKS,IACLT,KAAKU,YAELV,KAAKW,WACLX,KAAKY,gBACLZ,KAAKa,UAEL,IAAIC,GAAY,aAAa,gBAAgB,cAAc,SAAS,cAIlEC,EAAIC,GAAGC,QAEXH,EAASI,QAAQ,SAASC,GACxB,IAAIC,EAAW,cAAgBD,EAAG,QAClCJ,EAAEM,MAAML,GAAGM,KAAKF,KAGlBL,EAAEQ,MAAM,SAASC,GACf,GAAIA,EAAO,MAAMA,EAIjB,IAAI,IAAIC,EAAE,EAAEA,EAAIC,UAAUC,OAAQF,IAAK,CACrC,IAAIG,EAAOH,EAAE,EACbnB,EAAKE,KAAKM,EAASc,IAASF,UAAUD,GAGxC,IAAII,EAASxB,EAAKyB,KAAKD,KAMzBzB,eACE,IAAIE,EAAON,KAEbgB,GAAGe,KAAKzB,EAAKE,KAAKwB,YAAYd,QAAQ,SAASe,GAC9C3B,EAAKK,QAAQL,EAAKE,KAAKwB,WAAWC,IAAMA,EACrC3B,EAAKM,aAAaqB,GAAK3B,EAAKE,KAAKwB,WAAWC,KAIhD7B,cACE,IAAIE,EAAON,KAKbgB,GAAGe,KAAKzB,EAAKE,KAAKK,QAAQK,QAAQ,SAASC,GAC1C,IAAIc,EAAId,EAAEe,MAAM,KAChBD,EAAE,GAAKA,EAAE,GAAGE,OAAOD,MAAM,KAAKE,KAAK,KACnCH,EAAE,GAAKA,EAAE,GAAGE,OAAOD,MAAM,KAAKE,KAAK,KACnCH,EAAIA,EAAEG,KAAK,KAAKC,cAAcxC,WAAW,IAAI,KAC7CS,EAAKO,OAAOoB,GAAK3B,EAAKE,KAAKK,OAAOM,GAClCb,EAAKO,OAAOoB,GAAGK,UAAYnB,IAM5Bf,YAEE,IAAIE,EAAON,KAEXA,KAAKuC,eACLvC,KAAKwC,cACL,IAAIf,EAAE,EAEN,IAAI,IAAIgB,KAAQzC,KAAKQ,KAAKkC,YACxB1C,KAAKQ,KAAKkC,YAAYD,GAAMvB,QAAQ,SAASyB,GAG3C,IAAIC,EAAQtC,EAAKO,OAAO8B,EAAME,QAAQhD,WAAW,IAAK,MAClDiD,EAAY,QAGI,IAATF,IACTE,EAAYF,EAAMN,WAGpBhC,EAAKI,SAASe,IACZsB,GAAOtB,EACPuB,OAAW1C,EAAKK,QAAQgC,EAAMM,UAC9BA,SAAaN,EAAMM,SACnBC,MAAUJ,EACVK,cAAmBR,EAAMQ,cACzBC,UAAeT,EAAMS,UACrBC,YAAiBV,EAAMU,YACvBC,QAAYX,EAAMW,QAClBC,MAAUZ,EAAMY,MAChBC,UAAcb,GAGhBlB,MAIJzB,KAAKS,IAAMgD,KAAK,WAWd,IAAK,IAAIC,KART1D,KAAK2D,IAAI,MAET3D,KAAK4D,MAAM,UACX5D,KAAK4D,MAAM,SACX5D,KAAK4D,MAAM,iBACX5D,KAAK4D,MAAM,eACX5D,KAAK4D,MAAM,SAEItD,EAAKI,SAVLV,KAWJ6D,IAAIvD,EAAKI,SAASgD,MAKjCtD,OAAO0D,GACL,OAAO9D,KAAKS,IAAIX,OAAOgE,GAGzB1D,qBAAqB0D,GACnB,IAAIC,EAAU/D,KAAKgE,OAAOF,GAE1B,GAAsB,GAAlBC,EAAQpC,OACV,MAAO,kCAKT,IAFA,IAAIsC,KAEIxC,EAAE,EAAEA,EAAEsC,EAAQpC,OAAOF,IAAK,CAChC,IAAIyC,EAASlE,KAAKU,SAASqD,EAAQtC,GAAGkC,KAElClB,KAEoB,IAApByB,EAAOd,WACTX,EAAK0B,KAAKD,EAAOd,WAGG,IAAlBc,EAAOZ,SACTb,EAAK0B,KAAKD,EAAOZ,SAGnBW,EAAKE,KACH,gDACyBD,EAAOlB,OAAS,8BACbkB,EAAOhB,MAAQ,KAAOT,EAAKL,KAAK,OAAS,WAClD,IAAhB8B,EAAOX,MAAc,4BAA8BW,EAAOX,MAAQ,SAAW,IAChF,UAIJ,OAAOU,EAAK7B,KAAK,MAGnBhC,UACE,OAAOJ,KAAKQ,YAMV4D,cAELhE,cAECJ,KAAKQ,QACLR,KAAKqE,KAAO,EACZrE,KAAKa,UACLb,KAAKW,WACHX,KAAKY,gBACPZ,KAAKsE,cACLtE,KAAKuE,SAAW,gBAChBvE,KAAKwE,aAAc,EAInBxE,KAAKyE,MAAQC,OAAOC,WACpB3E,KAAK4E,OAASF,OAAOG,YACrB7E,KAAK8E,MAAQ,GAId1E,OAEEJ,KAAKQ,KAAOuE,GAAGC,UACdhF,KAAKiF,QACLjF,KAAKkF,eACPlF,KAAKmF,QACLnF,KAAKoF,WACLpF,KAAKqF,YAAa,EAGnBjF,QACGY,GAAGsE,OAAO,QAAQC,MAAM,WAAW,YACrCvE,GAAGsE,OAAO,QAAQC,MAAM,SAAS,KACjCvF,KAAKyE,MAAQC,OAAOC,WACpB3E,KAAK4E,OAASF,OAAOG,YAGtBzE,eACC,IAAIE,EAAON,KACXM,EAAKgE,WAAahE,EAAKE,KAAK8D,WAI5BS,GAAGvC,cACHlC,EAAKO,OAASkE,GAAGlE,OAGjBG,GAAGe,KAAKzB,EAAKE,KAAKwB,YAAYd,QAAQ,SAASe,GAC9C3B,EAAKK,QAAQL,EAAKE,KAAKwB,WAAWC,IAAMA,EACrC3B,EAAKM,aAAaqB,GAAK3B,EAAKE,KAAKwB,WAAWC,KAIhD3B,EAAKoC,eACL1B,GAAGe,KAAKzB,EAAKK,SAASO,QAAQ,SAASC,GAClCb,EAAKoC,YAAYvB,KAAKb,EAAKoC,YAAYvB,SAE5CH,GAAGe,KAAKzB,EAAKE,KAAKkC,aAAaxB,QAAQ,SAASC,GAC/Cb,EAAKE,KAAKkC,YAAYvB,GAAGD,QAAQ,SAASsE,GAExCA,EAAG3C,QAAU2C,EAAG3C,QAAQhD,WAAW,IAAI,KACxCS,EAAKoC,YAAY8C,EAAGvC,UAAUkB,KAAKqB,OAMrClF,EAAKmF,iBAMLzE,GAAGe,KAAK/B,KAAKQ,KAAKiF,eAAevE,QAAQ,SAASwE,GAChDpF,EAAKmF,cAAcC,MACnB1E,GAAGe,KAAKzB,EAAKE,KAAKiF,cAAcC,IAAMxE,QAAQ,SAASyE,GACnDrF,EAAKmF,cAAcC,GAAKC,EAAK9F,WAAW,IAAI,MAAQS,EAAKE,KAAKiF,cAAcC,GAAKC,OAMxFvF,SAIAA,WACGJ,KAAK4F,YAGRxF,oBAgBKyF,0BAA0BzB,cAC9BhE,cACE0F,QAEF9F,KAAK+F,OACJ,IAAIC,KAAK,KAAK,EAAE,GAChB,IAAIA,KAAK,KAAK,EAAE,IAGjBhG,KAAKiG,WAAajG,KAAK+F,MAAM,GAC7B/F,KAAKkG,SAAWlG,KAAK+F,MAAM,GAG3B3F,OACE0F,MAAMK,OAGR/F,QACE0F,MAAMX,QAGR/E,eACE0F,MAAMZ,eAGR9E,WACE0F,MAAMV,WAGRhF,YACE0F,MAAMF,mBAMJQ,qBAAqBP,kBACzBzF,cACE0F,QACA9F,KAAKyF,iBACLzF,KAAKqG,gBACLrG,KAAKqE,KAAO,EACZrE,KAAKuE,SAAW,eAClBvE,KAAKsG,oBAGLlG,OACE0F,MAAMK,OAGR/F,QAEA0F,MAAMX,QAMNnF,KAAKqG,aAAaE,IAAMvF,GAAGsE,OAAOkB,GAAGC,IAAIJ,aAAaE,IAAIG,MACvDC,OAAO,OACPC,KAAK,QAAQ,QAEd5F,GAAGsE,OAAOkB,GAAGC,IAAIJ,aAAa1F,QAAQkG,MACnC5C,KAAKuC,GAAGM,mBAAmB9G,OAGhCI,eACE0F,MAAMZ,eAGRlF,KAAKqG,gBASLjG,WACE0F,MAAMV,WAER,IAAI9E,EAAON,KACPiF,GAAQ,EAEZjF,KAAKA,KAAKuE,UAAUgC,IAAIK,KAAK,SAAS5G,KAAK4E,QAG3C5E,KAAKA,KAAKuE,UAAUgC,IAAIQ,GAAG,QAAQ,WAClC/F,GAAGgG,MAAMC,kBACTC,IACAC,MAKCnG,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU5D,QAAQkG,MACrCO,UAAU,WAAWC,KAAK,WACzBrG,GAAGsE,OAAOtF,MAAM+G,GAAG,QAAQ,WACzB,IAAIO,EAAOtG,GAAGsE,OAAOtF,MACrB,GAAIsH,EAAKC,QAAQ,YAAa,CAC5BD,EAAKC,QAAQ,YAAW,GACxB,IAAIC,EAAQlH,EAAKgG,iBAAiBmB,QAAQH,EAAKV,KAAK,aAChDY,GAAS,GACXlH,EAAKgG,iBAAiBoB,OAAOF,EAAM,QAGrCF,EAAKC,QAAQ,YAAW,GACxBjH,EAAKgG,iBAAiBnC,KAAKmD,EAAKV,KAAK,aAGvCe,QAMR,IAAIC,EAAcpB,GAAGC,IAAIzG,KAAKuE,UAAUsD,WAAWC,YAE/CC,EAAQ/G,GAAGgH,KAAKD,QAClBE,OAAOjI,KAAK+F,OAEVmC,EAAalH,GAAGmH,IAAIC,OACtBC,OAAO,SACPC,MAAM,IACNC,SAASX,EAAc,GACvBY,YAAY,IAEVC,EAAQzH,GAAG0H,SACbX,MAAMA,GACNK,KAAKF,GACLS,OACAC,EAAsB5I,KAAK+F,MAAM,IACjC6C,EAAsB5I,KAAK+F,MAAM,MAEjC8C,YAAY,YACZC,OAAO,GACPC,SAAQ,GACRhC,GAAG,QAAQ,SAASiC,EAAIL,GACxB,IAAIM,EAAMN,EAAM,aAAc3C,KAAO2C,EAAM,GAAK,IAAI3C,KAAK2C,EAAM,IAC7DO,EAAMP,EAAM,aAAc3C,KAAO2C,EAAM,GAAK,IAAI3C,KAAK2C,EAAM,IAE7DrI,EAAK2F,WAAa2C,EAAsBK,GACxC3I,EAAK4F,SAAW0C,EAAsBM,GAGtCC,IACAxB,MAEAZ,GAAG,WAAW,SAASiC,EAAIL,GAC3BhB,MAMF,SAASiB,EAAsBQ,GAC9B,IAAIC,EAAIrI,GAAGgH,KAAKD,QACdE,OAAOF,EAAME,UACblC,OAAO,EAAEzF,EAAKsE,SACd0E,KAAKtI,GAAGgH,KAAKuB,OAEf,OAAOF,EAAEG,OAAOlJ,EAAKsE,OAAQyE,EAAED,IAGnBpI,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUsD,YAAY/F,KAAK2G,GAE9DzH,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUsD,YAAYT,UAAU,QAAQR,KAAK,YAAa,cAAgBgB,EAAc,QAE9GuB,IAGA,IAOI1D,EACFgE,EACApD,EACAqD,EACEC,EACFC,EACAC,EACAC,EACAC,EACAC,EAEAC,EACAC,EACAC,EAGE5D,EAvBA6D,EAAapJ,GAAGqJ,IAAIC,WACtBvC,MAAM,KACNwC,WAAwD,GAA7C/D,GAAGC,IAAIzG,KAAKuE,UAAUgC,IAAIG,KAAKoB,YAAgE,GAA9CtB,GAAGC,IAAIzG,KAAKuE,UAAUgC,IAAIG,KAAK8D,eAEzFC,EAAOzJ,GAAGqJ,IAAII,OAAOL,WAAWA,GAEhCM,EAAWC,SAASC,QAAQtK,EAAKgE,WAAWhE,EAAKgE,WAAWuG,QAAQvG,YA0BxE,SAASwG,IAGRrF,KACAgE,KACApD,KACAqD,KAKA,IAAIqB,EAAS/J,GAAGgK,QAAQ1K,EAAKmF,eAAewF,OAAO,SAAS9J,GAC3D,IAAI+J,EAAI,IAAIlF,KAAK7E,EAAEuE,KACnB,OAAOwF,GAAK5K,EAAK2F,YAAciF,GAAI5K,EAAK4F,WA6EtC,IAAK,IAAIiF,KAvEZJ,EAAO7J,QAAQ,SAASC,GACpBH,GAAGe,KAAKZ,EAAEwH,OAAOhH,OAAQ,GAC3BX,GAAGe,KAAKZ,EAAEwH,OAAOzH,QAAQ,SAASsE,GAGhC,IAAI4F,EAAI,EAEHjK,EAAEwH,MAAMnD,GAAItE,QAAQ,SAASmK,GACvB/K,EAAKgG,iBAAiBmB,QAAQ4D,EAAIpI,WAAa,GACjDmI,MAIG,GAAHA,IAIN3F,EAAcD,KACjBC,EAAcD,MACdC,EAAcD,GAAI8F,YAKnBnK,EAAEwH,MAAMnD,GAAItE,QAAQ,SAASmK,KACvB5F,EAAcD,GAAI8F,QAAQD,EAAIpI,WAAawC,EAAcD,GAAI8F,QAAQD,EAAIpI,UAAWoI,EAAIE,aAAejL,EAAKgG,iBAAiBmB,QAAQ4D,EAAIpI,WAAa,IAC1JwC,EAAcD,GAAI8F,QAAQD,EAAIpI,UAAYoI,EAAIE,WAC9C9F,EAAcD,GAAIgG,KAAOrK,EAAEwH,MAAMnD,WAWtCxE,GAAGe,KAAK0D,GAAevE,QAAQ,SAASC,GACvCsE,EAActE,GAAGsK,SAChB,IAAI,IAAIhK,EAAE,EAAEA,GAAKiK,OAAO3J,KAAKzB,EAAKK,SAASgB,OAAQF,IAAK,CACvD,IAAIiE,EAAM,KAAOjE,EAAEkK,WACnBlG,EAActE,GAAGsK,MAAM/F,GAAO1E,GAAG4K,OAAOnG,EAActE,GAAGmK,SAASL,OAAO,SAASzF,GAAK,OAAOA,IAAO/D,OAKxGsJ,EAAO7J,QAAQ,SAASC,GACvBH,GAAGe,KAAKZ,EAAEwH,OAAOzH,QAAQ,SAASsE,GAC7BiE,EAAqBjE,KAAMiE,EAAqBjE,OACpDrE,EAAEwH,MAAMnD,GAAItE,QAAQ,SAASmK,GACmG,IAA5H5B,EAAqBjE,GAAIyF,OAAO,SAASY,GAAI,OAAOA,EAAE5I,WAAaoI,EAAIpI,UAAY4I,EAAEvI,UAAY+H,EAAI/H,UAAY3B,QACnH8H,EAAqBjE,GAAIrB,KAAKkH,SAQlCN,EAAO7J,QAAQ,SAASC,GACvBH,GAAGe,KAAKZ,EAAEwH,OAAOzH,QAAQ,SAASsE,GACjCrE,EAAEwH,MAAMnD,GAAItE,QAAQ,SAASmK,GACxBhF,EAAagF,EAAIpI,YAAYoD,EAAagF,EAAIpI,cAC6E,IAA5HoD,EAAagF,EAAIpI,UAAUgI,OAAO,SAASY,GAAI,OAAOA,EAAEhJ,UAAYwI,EAAIxI,SAAWgJ,EAAEvI,UAAY+H,EAAI/H,UAAY3B,QACnH0E,EAAagF,EAAIpI,UAAUkB,KAAKkH,SAMdhF,GAC4B,GAA1C/F,EAAKgG,iBAAiBmB,QAAQ0D,WACzB9E,EAAa8E,GAMvBnK,GAAGe,KAAKsE,GAAcnF,QAAQ,SAASwE,GACrC1E,GAAGe,KAAKsE,EAAaX,IAAMxE,QAAQ,SAAS4K,GAC1CzF,EAAaX,GAAKoG,GAAOjJ,QAAUwD,EAAaX,GAAKoG,GAAOjJ,QAAQhD,WAAW,IAAI,SAM1F,IADA,IAAIkM,EAAO,EACHtK,EAAE,EAAGA,EAAET,GAAGe,KAAKsE,GAAc1E,OAAQF,IAC5C,IAAI,IAAIuK,EAAE,EAAGA,EAAE3F,EAAarF,GAAGe,KAAKsE,GAAc5E,IAAIE,OAAQ,EAAGqK,IAChE3F,EAAarF,GAAGe,KAAKsE,GAAc5E,IAAIuK,GAAGC,YAAc5F,EAAarF,GAAGe,KAAKsE,GAAc5E,IAAIuK,EAAE,GAAGnJ,QACpGwD,EAAarF,GAAGe,KAAKsE,GAAc5E,IAAIuK,GAAGE,eAAiB7F,EAAarF,GAAGe,KAAKsE,GAAc5E,IAAIuK,EAAE,GAAGT,WACvGlF,EAAarF,GAAGe,KAAKsE,GAAc5E,IAAIuK,GAAGD,KAAOA,EACjDA,EAAMC,EAAE,EAAG,GAKbhL,GAAGe,KAAK0D,GAAevE,QAAQ,SAASC,GACnCuI,EAAoBvI,KAAKuI,EAAoBvI,SAGlDH,GAAG4K,OAAOvF,GAAcnF,QAAQ,SAASC,GACxCA,EAAED,QAAQ,SAASsE,GACdkE,EAAoBlE,EAAG3C,WAAW6G,EAAoBlE,EAAG3C,aACzD6G,EAAoBlE,EAAGyG,eAAevC,EAAoBlE,EAAGyG,iBACjEvC,EAAoBlE,EAAG3C,SAASsB,KAAKqB,GAClCA,EAAGyG,aAAcvC,EAAoBlE,EAAGyG,aAAa9H,KAAKqB,OAMhE,SAAS2G,KAERlC,EAAe3J,EAAKA,EAAKiE,UAAUgC,IAAIa,UAAU,kBAC/C5G,MAAMF,KACK8L,QAAQzF,OAAO,KAC1BY,QAAQ,gBAAe,GACzB0C,EAAaoC,OAAOC,UAEpBpC,EAAUD,EAAa7C,UAAU,aAC/B5G,KAAKQ,GAAGgK,QAAQ3E,KACV+F,QAAQzF,OAAO,KACrBY,QAAQ,WAAU,GACpB2C,EACEtD,KAAK,QAAQ,SAASzF,GACtB,MAAO,cAAeH,GAAGe,KAAKzB,EAAKK,SAAS8G,QAAQtG,EAAEuE,OAExDwE,EAAQmC,OAAOC,UAEfnC,EAAQD,EAAQ9C,UAAU,aACxB5G,KAAK,SAASW,GAAI,OAAOA,EAAEwH,MAAMsC,OAAO,SAASzF,GAAK,OAAOA,EAAGyG,iBAC5DG,QAAQzF,OAAO,QACnBY,QAAQ,QAAO,GACjB4C,EACEvD,KAAK,IAAI,SAASzF,GAClB,IAAIoL,EACFC,EACEC,EAAMtL,EAAE0B,SAAW1B,EAAE8K,YACvBS,EAAMvL,EAAE8K,aAAe9K,EAAE0B,QAI3B0J,EAASnC,GACR9J,EAAKO,OAAO4L,GAAKE,KACjBrM,EAAKO,OAAO4L,GAAKG,MAWlB,IAAIC,GAPJL,EAASpC,GACR9J,EAAKO,OAAO6L,GAAKC,KACjBrM,EAAKO,OAAO6L,GAAKE,OAKF,GAAIL,EAAO,GACzBO,EAAKN,EAAO,GAAID,EAAO,GACvBQ,EAAKC,KAAKC,MAAMJ,EAAI1L,EAAE4K,OAASc,EAAI1L,EAAE4K,OAASe,EAAI3L,EAAE4K,OAASe,EAAI3L,EAAE4K,OACrE,MAAO,IAAMQ,EAAO,GAAK,IAAMA,EAAO,GAAK,IAAMQ,EAAK,IAAMA,EAAK,UAAYP,EAAO,GAAK,IAAMA,EAAO,KAExGrC,EAAMkC,OAAOC,SAGd,SAASY,IAGR,IAAIC,EAAUnM,GAAG+G,MAAMqF,SACrBnF,QAAQ,EAAE,KACVlC,OAAO,EAAE,MAEX4D,EAAgBrJ,EAAKA,EAAKiE,UAAUgC,IAAIa,UAAU,mBAChD5G,MAAMF,KACM8L,QAAQzF,OAAO,KAC3BY,QAAQ,iBAAgB,GAC1BoC,EAAc0C,OAAOC,UAErB1C,EAAWtJ,EAAKA,EAAKiE,UAAUgC,IAAIa,UAAU,cAC3C5G,KAAKQ,GAAGgK,QAAQvF,KACT2G,QAAQzF,OAAO,KACtBY,QAAQ,YAAW,GACrBqC,EACEhD,KAAK,YAAY,SAASzF,GAC1B,IAAIkM,EAAKjD,GACN9J,EAAKO,OAAOM,EAAEuE,KAAKiH,KACnBrM,EAAKO,OAAOM,EAAEuE,KAAKkH,MAItB,MAAO,aAFAS,EAAE,GAEgB,IADlBA,EAAE,GACyB,MAElC1G,OAAO,QACPC,KAAK,QAAS,OACd0G,KAAK,SAASnM,GACb,IAAIoM,KACJA,EAAQpJ,KAAK7D,EAAKO,OAAOM,EAAEuE,KAAKpD,WAGhC,IAAI,IAAIb,EAAE,EAAEA,EAAGN,EAAEwH,MAAM6C,KAAK7J,OAAOF,IAAK,CACtC,IAAI+J,KACJA,EAAKrH,KAAK7D,EAAKK,QAAQQ,EAAEwH,MAAM6C,KAAK/J,GAAGwB,WAEN,IAA7B9B,EAAEwH,MAAM6C,KAAK/J,GAAG2B,WAClBoI,EAAKrH,KAAK,YAAchD,EAAEwH,MAAM6C,KAAK/J,GAAG2B,UAAUuI,YAGZ,IAAjCxK,EAAEwH,MAAM6C,KAAK/J,GAAG0B,eACjBqI,EAAKrH,KAAK,KAAOhD,EAAEwH,MAAM6C,KAAK/J,GAAG0B,cAAcwI,WAAa,KAEnC,IAA3BxK,EAAEwH,MAAM6C,KAAK/J,GAAG6B,SAClBkI,EAAKrH,KAAK,YAAchD,EAAEwH,MAAM6C,KAAK/J,GAAG6B,SAGX,IAA3BnC,EAAEwH,MAAM6C,KAAK/J,GAAG6B,SACdkI,EAAKrH,KAAK,KAAOhD,EAAEwH,MAAM6C,KAAK/J,GAAG0B,cAAcwI,WAAa,KAGlE4B,EAAQpJ,KAAKqH,EAAKpJ,KAAK,KAGzB,OAAOmL,EAAQnL,KAAK,YAEvBwH,EACE7C,GAAG,YAAY,SAAS5F,GACxBH,GAAGsE,OAAOtF,MACRwN,aACAC,SAASnN,EAAKwE,OACd8B,KAAK,YAAY,SAASpB,GAC1B,IAAI6H,EAAKjD,GACN9J,EAAKO,OAAO2E,EAAGE,KAAKiH,KACpBrM,EAAKO,OAAO2E,EAAGE,KAAKkH,MAIvB,MAAO,aAFAS,EAAE,GAEgB,IADlBA,EAAE,GACyB,kBAGpCtG,GAAG,WAAW,SAAS5F,GACvBH,GAAGsE,OAAOtF,MACRwN,aACAC,SAASnN,EAAKwE,MAAM,GACpB8B,KAAK,YAAY,SAASpB,GAC1B,IAAI6H,EAAKjD,GACN9J,EAAKO,OAAO2E,EAAGE,KAAKiH,KACpBrM,EAAKO,OAAO2E,EAAGE,KAAKkH,MAIvB,MAAO,aAFAS,EAAE,GAEgB,IADlBA,EAAE,GACyB,gBAGpCtG,GAAG,QAAQ,SAAS5F,GACpBH,GAAGgG,MAAMC,kBACTC,IACG/F,EAAEuE,MAAQT,EAAMS,MAClBT,EAAQ9D,EACRH,GAAGsE,OAAOtF,MAAMuH,QAAQ,eAAc,IAO/BvG,GAAGsE,OAAOtF,MAAlB,IACI6L,EAAI7K,GAAGsE,OAAOtF,MAAMsF,OAAO,QAAQgI,OAKnCI,EAAO1N,KAAK2N,wBACZC,EAAMF,EAAKE,IAAMlJ,OAAOmJ,YAAc,GACtCC,EAAOJ,EAAKI,KAAOpJ,OAAOqJ,YAAc,GAI3C/M,GAAGsE,OAAO,YAAYgH,SAIvBtL,GAAGsE,OAAOkB,GAAGC,IAAIJ,aAAaiB,MAC3BX,OAAO,OACPC,KAAK,QAAQ,WACRrB,OACJqI,IAAOA,EAAM,KACbE,KAAQA,EAAO,KACfE,OAAW,OACXC,MAAU,SAEXhK,KAAK4H,GACL9E,GAAG,QAAQ,WAWV/F,GAAGsE,OAAOtF,MACNuF,OACC2I,sBAAsB,UACtBC,uBAAwB,UACxBC,sBAAuB,cAExBZ,aACAa,MAAM,KACN/B,WAGRnF,MAGFyC,EAASyC,OAAOC,UAGhBzC,EAAeD,EAASxC,UAAU,qBAChC5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM6C,QAC7BlC,QAAQzF,OAAO,UAC1BY,QAAQ,cAAa,GACvBsC,EACEjD,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,OAAOgM,EAAQ,KAEjBtD,EAAawC,OAAOC,UAGpBtC,EAAYJ,EAASxC,UAAU,mBAC7B5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM6C,QAChClC,QAAQzF,OAAO,UACvBY,QAAQ,YAAW,GACrByC,EACEzC,QAAQ,SAAQ,GAChBX,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,OAAOgM,EAAQ,KAEjBnD,EAAUqC,OAAOC,UAGjBvC,EAAYH,EAASxC,UAAU,mBAC7B5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM8C,QAChCnC,QAAQzF,OAAO,UACvBY,QAAQ,YAAW,GACrBwC,EACExC,QAAQ,SAAQ,GAChBX,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,OAAOgM,EAAQ,KAEjBpD,EAAUsC,OAAOC,UAGjBxC,EAAYF,EAASxC,UAAU,mBAC7B5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM+C,QAChCpC,QAAQzF,OAAO,UACvBY,QAAQ,YAAW,GACrBuC,EACEvC,QAAQ,SAAQ,GAChBX,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,IAAIsN,EAAQtN,EAAEQ,OACd,OAAOwL,EAAQsB,KAEjB3E,EAAUuC,OAAOC,SAGlB,SAASnF,IACR,IAAIuH,EAAU1N,GAAG+G,MAAMqF,SACrBnF,QAAQ,EAAE,IACVlC,OAAO,GAAI,IAEb,GAAGd,EAAM,CACRjE,GAAGsE,OAAOkB,GAAGC,IAAIhB,cAAc1B,QAAQ4K,OAAO1K,KAAK3D,EAAKO,OAAOoE,EAAMS,KAAKpD,WAG1E,IAEIsM,EACFC,EAHErO,EAAOiJ,EAAqBxE,EAAMS,UAKtCkJ,EAJmB5N,GAAGsE,OAAOkB,GAAGC,IAAIhB,cAAc1B,QAAQ2C,MAIrCU,UAAU,SAC7B5G,KAAKA,IACD4L,QAAQzF,OAAO,OACnBY,QAAQ,QAAO,GACjBqH,EACEhI,KAAK,QAAQ,SAASzF,GAEtB,MAAO,WADGH,GAAGe,KAAKzB,EAAKK,SAAS8G,QAAQtG,EAAE8B,YAG1CsC,MAAM,UAAU,SAASpE,GACzB,OAAOuN,EAAQvN,EAAEoK,cAEjBtH,KAAK,SAAS9C,GACd,OAAOb,EAAKK,QAAQQ,EAAE8B,YAExB2L,EAAMvC,OAAOC,UAEbuC,EAAaD,EAAMxH,UAAU,iBAC3B5G,KAAK,SAASW,GAAI,OAAQA,MACjBiL,QAAQzF,OAAO,OACxBY,QAAQ,aAAY,GACtBsH,EACE5K,KAAK,SAAS9C,GAWd,OATMA,EAAEiC,WAAajC,EAAEmC,QAAUnC,EAAEiC,UAAW,sBAAuBjC,EAAEmC,QAAUnC,EAAEiC,UAAYjC,EAAEiC,UAAW,gBAAkBjC,EAAEmC,QAAU,gBAAiBnC,EAAEmC,QAAU,KAWzKuL,EAAWxC,OAAOC,cAGlBtL,GAAGsE,OAAO,kBAAkBrB,KAAK,IACjCjD,GAAGsE,OAAO,kBAAkBrB,KAAK,IAInC,SAASkF,IACR,IAAI2F,EAAI9N,GAAGgH,KAAK+G,OAAO,SACvB/N,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAUyK,WAAW/K,KAAK6K,EAAExO,EAAK2F,aACvDjF,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAU0K,SAAShL,KAAK6K,EAAExO,EAAK4F,WAGtD,SAASyB,IACRmD,IACAqB,IACAe,IACA/F,IAGD,SAASD,IACRjC,GAAQ,EACRjE,GAAGoG,UAAU,gBAAgBG,QAAQ,eAAc,IAxdpDhB,EAAMjG,EAAKN,KAAKuE,UAAUgC,IAAIa,UAAU,YACtC5G,MAAMkK,KACJ0B,QAAQzF,OAAQ,QAClBY,QAAQ,OAAM,GAChBhB,EACEK,KAAK,IAAI6D,GACXlE,EAAI8F,OAAOC,SAqdXxB,IACAqB,IACAe,IACA/F,IAGA/G,YACC0F,MAAMF,YACL,IAAIsJ,EAAoB,IAAdlP,KAAKqE,KAAa,EAAI,EAElCrD,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUsD,YAAYT,UAAU,KAAKkF,SAE3DtL,GAAGoG,UAAU,yBAAyBG,QAAQ,YAAW,GACzDvG,GAAGsE,OAAO,2BAA2BiC,QAAQ,YAAW,GAExDvG,GAAGoG,UAAU,MAAO8H,GAAK3J,MAAM,UAAU,QACzCvE,GAAGoG,UAAU,MAAOpH,KAAKqE,MAAMkB,MAAM,UAAU,SAE/CvF,KAAKiG,WAAajG,KAAK+F,MAAM,GAC7B/F,KAAKkG,SAAWlG,KAAK+F,MAAM,UAMvBoJ,sBAAsBtJ,kBAC1BzF,cACE0F,QACA9F,KAAKqE,KAAO,EACZrE,KAAKuE,SAAW,gBAChBvE,KAAKyF,iBACLzF,KAAKqG,gBAGPjG,OACE0F,MAAMK,OAGR/F,QAEA0F,MAAMX,QAMNnF,KAAKA,KAAKuE,UAAUgC,IAAMvF,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUgC,IAAIG,MAC3DC,OAAO,OACPC,KAAK,QAAQ,QAEhB5G,KAAKmI,IAAMnH,GAAGsE,OAAO,cACnBqB,OAAO,OACPC,KAAK,QAAQ5G,KAAKyE,OAIpBrE,eACE0F,MAAMZ,eAGRlF,KAAKqG,gBAMNjG,WACE0F,MAAMV,WAEP,IAAI9E,EAAON,KACPiF,GAAQ,EAEZjF,KAAKA,KAAKuE,UAAUgC,IAAIK,KAAK,SAAS5G,KAAK4E,QAG3C5E,KAAKA,KAAKuE,UAAUgC,IAAIQ,GAAG,QAAQ,WAClC/F,GAAGgG,MAAMC,kBACTC,IACAC,MAKD,IAAIS,EAAcpB,GAAGC,IAAIzG,KAAKuE,UAAUsD,WAAWC,YAE/CC,EAAQ/G,GAAGgH,KAAKD,QAClBE,OAAOjI,KAAK+F,OAEVmC,EAAalH,GAAGmH,IAAIC,OACtBC,OAAO,SACPC,MAAM,IACNC,SAASX,EAAc,GACvBY,YAAY,IAEVC,EAAQzH,GAAG0H,SACbX,MAAMA,GACNK,KAAKF,GACLS,OACAC,EAAsB5I,KAAK+F,MAAM,IACjC6C,EAAsB5I,KAAK+F,MAAM,MAEjC8C,YAAY,YACZC,OAAO,GACPC,SAAQ,GACRhC,GAAG,QAAQ,SAASiC,EAAIL,GACxB,IAAIM,EAAMN,EAAM,aAAc3C,KAAO2C,EAAM,GAAK,IAAI3C,KAAK2C,EAAM,IAC7DO,EAAMP,EAAM,aAAc3C,KAAO2C,EAAM,GAAK,IAAI3C,KAAK2C,EAAM,IAE7DrI,EAAK2F,WAAa2C,EAAsBK,GACxC3I,EAAK4F,SAAW0C,EAAsBM,GAGtCC,IACAxB,MAEAZ,GAAG,WAAW,SAASiC,EAAIL,GAC3BhB,MAMF,SAASiB,EAAsBQ,GAC9B,IAAIC,EAAIrI,GAAGgH,KAAKD,QACdE,OAAOF,EAAME,UACblC,OAAO,EAAEzF,EAAKsE,SACd0E,KAAKtI,GAAGgH,KAAKuB,OACf,OAAOF,EAAEG,OAAOlJ,EAAKsE,OAAQyE,EAAED,IAGnBpI,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUsD,YAAY/F,KAAK2G,GAE9DzH,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUsD,YAAYT,UAAU,QAAQR,KAAK,YAAa,cAAgBgB,EAAc,QAAQ0F,KAAK,SAASnM,GAClI,OAAOH,GAAGsE,OAAOtF,MAAMsN,OAAS,MAGlCnE,IAIA,IAOI1D,EACFgE,EACEE,EACFC,EACAC,EACAC,EACAC,EACAC,EAGEzD,EAjBA6D,EAAapJ,GAAGqJ,IAAIC,WACtBvC,MAAM,KACNwC,WAAwD,GAA7C/D,GAAGC,IAAIzG,KAAKuE,UAAUgC,IAAIG,KAAKoB,YAAgE,GAA9CtB,GAAGC,IAAIzG,KAAKuE,UAAUgC,IAAIG,KAAK8D,eAEzFC,EAAOzJ,GAAGqJ,IAAII,OAAOL,WAAWA,GAEhCM,EAAWC,SAASC,QAAQtK,EAAKgE,WAAWhE,EAAKgE,WAAWuG,QAAQvG,YAoBxE,SAASwG,IAGRrF,KACAgE,KAIA,IAAIsB,EAAS/J,GAAGgK,QAAQ1K,EAAKmF,eAAewF,OAAO,SAAS9J,GAC3D,IAAI+J,EAAI,IAAIlF,KAAK7E,EAAEuE,KACnB,OAAOwF,GAAI5K,EAAK2F,YAAciF,GAAI5K,EAAK4F,WAMxC6E,EAAO7J,QAAQ,SAASC,GACpBH,GAAGe,KAAKZ,EAAEwH,OAAOhH,OAAQ,GAC3BX,GAAGe,KAAKZ,EAAEwH,OAAOzH,QAAQ,SAASsE,GAC7BC,EAAcD,KACjBC,EAAcD,MACdC,EAAcD,GAAI8F,YAEnBnK,EAAEwH,MAAMnD,GAAItE,QAAQ,SAASmK,KACxB5F,EAAcD,GAAI8F,QAAQD,EAAIpI,WAAawC,EAAcD,GAAI8F,QAAQD,EAAIpI,UAAWoI,EAAIE,cAC3F9F,EAAcD,GAAI8F,QAAQD,EAAIpI,UAAYoI,EAAIE,kBAUnDvK,GAAGe,KAAK0D,GAAevE,QAAQ,SAASC,GACvCsE,EAActE,GAAGsK,SAChB,IAAI,IAAIhK,EAAE,EAAEA,GAAKiK,OAAO3J,KAAKzB,EAAKK,SAASgB,OAAQF,IAAK,CACvD,IAAIiE,EAAM,KAAOjE,EAAEkK,WACnBlG,EAActE,GAAGsK,MAAM/F,GAAO1E,GAAG4K,OAAOnG,EAActE,GAAGmK,SAASL,OAAO,SAASzF,GAAK,OAAOA,IAAO/D,OAKxGsJ,EAAO7J,QAAQ,SAASC,GACvBH,GAAGe,KAAKZ,EAAEwH,OAAOzH,QAAQ,SAASsE,GAC7BiE,EAAqBjE,KAAMiE,EAAqBjE,OACpDrE,EAAEwH,MAAMnD,GAAItE,QAAQ,SAASmK,GACmG,IAA5H5B,EAAqBjE,GAAIyF,OAAO,SAASY,GAAI,OAAOA,EAAE5I,WAAaoI,EAAIpI,UAAY4I,EAAEvI,UAAY+H,EAAI/H,UAAY3B,QACnH8H,EAAqBjE,GAAIrB,KAAKkH,SASlC,IAAI+D,KAEJ,IAAI,IAAIC,KAAQ5J,EACXiG,OAAO3J,KAAK0D,EAAc4J,GAAM/D,SAAS3J,OAAS,IACnDyN,EAAOjL,KAAKkL,UACF5J,EAAc4J,IAI5B,IAAI,IAAIC,KAAU7F,EACb2F,EAAO3H,QAAQ6H,IAAW,UACpB7F,EAAqB6F,GAMjC,SAASpC,IAGR,IAAIC,EAAUnM,GAAG+G,MAAMqF,SACrBnF,QAAQ,EAAE,KACVlC,OAAO,EAAE,MAEX4D,EAAgBrJ,EAAKmF,cAAcc,IAAIa,UAAU,mBAC/C5G,MAAMF,KACM8L,QAAQzF,OAAO,KAC3BY,QAAQ,iBAAgB,GAC1BoC,EAAc0C,OAAOC,UAErB1C,EAAWtJ,EAAKmF,cAAcc,IAAIa,UAAU,cAC1C5G,KAAKQ,GAAGgK,QAAQvF,KACT2G,QAAQzF,OAAO,KACtBY,QAAQ,YAAW,GACrBqC,EACEhD,KAAK,YAAY,SAASzF,GAE1B,IAAIkM,EAAKjD,GACN9J,EAAKO,OAAOM,EAAEuE,KAAKiH,KACnBrM,EAAKO,OAAOM,EAAEuE,KAAKkH,MAItB,MAAO,aAFAS,EAAE,GAEgB,IADlBA,EAAE,GACyB,MAElC1G,OAAO,SACP2G,KAAK,SAASnM,GACb,OAAOb,EAAKO,OAAOM,EAAEuE,KAAKpD,YAE7BsH,EACE7C,GAAG,QAAQ,SAAS5F,GACpBH,GAAGgG,MAAMC,kBAER,IAAIsI,EAAQvO,GAAGsE,OAAOtF,MAOtB4J,EAAS1I,QAAQ,SAASC,GACxBH,GAAGsE,OAAOtF,MACPuH,QAAQ,YAAW,GACrBiG,aACAC,SAASnN,EAAKwE,OACd8B,KAAK,YAAY,SAASpB,GAC1B,IAAI6H,EAAKjD,GACN9J,EAAKO,OAAO2E,EAAGE,KAAKiH,KACpBrM,EAAKO,OAAO2E,EAAGE,KAAKkH,MAIvB,MAAO,aAFAS,EAAE,GAEgB,IADlBA,EAAE,GACyB,gBAItCkC,EACGhI,QAAQ,YAAW,GACpBiG,aACAC,SAASnN,EAAKwE,OACd8B,KAAK,YAAY,SAASpB,GAC1B,IAAI6H,EAAKjD,GACN9J,EAAKO,OAAO2E,EAAGE,KAAKiH,KACpBrM,EAAKO,OAAO2E,EAAGE,KAAKkH,MAIvB,MAAO,aAFAS,EAAE,GAEgB,IADlBA,EAAE,GACyB,gBAKpCnG,IACG/F,EAAEuE,MAAQT,EAAMS,MAClBT,EAAQ9D,EACRH,GAAGsE,OAAOtF,MAAMuH,QAAQ,eAAc,IAErCJ,MAEJyC,EAASyC,OAAOC,UAGhBzC,EAAeD,EAASxC,UAAU,qBAChC5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM6C,QAC7BlC,QAAQzF,OAAO,UAC1BY,QAAQ,cAAa,GACvBsC,EACEjD,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,IAAIsN,EAAQtN,EAAEQ,OAAQ3B,KAAKwP,WAAWC,SAAS9G,MAAM8C,MAAM8C,IAAI5M,OAAQ3B,KAAKwP,WAAWC,SAAS9G,MAAM8C,MAAM+C,IAAI7M,OAChH,OAAOwL,EAAQsB,KAEjB5E,EAAawC,OAAOC,UAGpBtC,EAAYJ,EAASxC,UAAU,mBAC7B5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM6C,QAChClC,QAAQzF,OAAO,UACvBY,QAAQ,YAAW,GACrByC,EACEzC,QAAQ,SAAQ,GAChBX,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,IAAIsN,EAAQtN,EAAEQ,OAAQ3B,KAAKwP,WAAWC,SAAS9G,MAAM8C,MAAM8C,IAAI5M,OAAQ3B,KAAKwP,WAAWC,SAAS9G,MAAM8C,MAAM+C,IAAI7M,OAChH,OAAOwL,EAAQsB,KAEjBzE,EAAUqC,OAAOC,UAGjBvC,EAAYH,EAASxC,UAAU,mBAC7B5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM8C,QAChCnC,QAAQzF,OAAO,UACvBY,QAAQ,YAAW,GACrBwC,EACExC,QAAQ,SAAQ,GAChBX,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,IAAIsN,EAAQtN,EAAEQ,OAAQ3B,KAAKwP,WAAWC,SAAS9G,MAAM8C,MAAM+C,IAAI7M,OAC/D,OAAOwL,EAAQsB,KAEjB1E,EAAUsC,OAAOC,UAGjBxC,EAAYF,EAASxC,UAAU,mBAC7B5G,KAAK,SAASW,GAAI,OAAQA,EAAEwH,MAAM8C,MAAM+C,QAChCpC,QAAQzF,OAAO,UACvBY,QAAQ,YAAW,GACrBuC,EACEvC,QAAQ,SAAQ,GAChBX,KAAK,KAAK,GACVA,KAAK,KAAK,GACVA,KAAK,IAAI,SAASzF,GAClB,IAAIsN,EAAQtN,EAAEQ,OACd,OAAOwL,EAAQsB,KAEjB3E,EAAUuC,OAAOC,SAGlB,SAASnF,IACR,IAAIuH,EAAU1N,GAAG+G,MAAMqF,SACrBnF,QAAQ,EAAE,IACVlC,OAAO,GAAI,IAEb,GAAGd,EAAM,CACRjE,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAUR,QAAQ4K,OAAO1K,KAAK3D,EAAKO,OAAOoE,EAAMS,KAAKpD,WAG3E,IAEIsM,EACFC,EAHErO,EAAOiJ,EAAqBxE,EAAMS,UAKtCkJ,EAJmB5N,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAUR,QAAQ2C,MAItCU,UAAU,SAC7B5G,KAAKA,IACD4L,QAAQzF,OAAO,OACnBY,QAAQ,QAAO,GACjBqH,EACEhI,KAAK,QAAQ,SAASzF,GAEtB,MAAO,WADGH,GAAGe,KAAKzB,EAAKK,SAAS8G,QAAQtG,EAAE8B,YAG1CsC,MAAM,UAAU,SAASpE,GACzB,OAAOuN,EAAQvN,EAAEoK,cAEjBtH,KAAK,SAAS9C,GACd,OAAOb,EAAKK,QAAQQ,EAAE8B,YAExB2L,EAAMvC,OAAOC,UAEbuC,EAAaD,EAAMxH,UAAU,iBAC3B5G,KAAK,SAASW,GAAI,OAAQA,MACjBiL,QAAQzF,OAAO,OACxBY,QAAQ,aAAY,GACtBsH,EACE5K,KAAK,SAAS9C,GAGd,OADMA,EAAEiC,WAAajC,EAAEmC,QAAUnC,EAAEiC,UAAW,sBAAuBjC,EAAEmC,QAAUnC,EAAEiC,UAAYjC,EAAEiC,UAAW,gBAAkBjC,EAAEmC,QAAU,gBAAiBnC,EAAEmC,QAAU,KAGzKuL,EAAWxC,OAAOC,cAElBtL,GAAGsE,OAAO,kBAAkBrB,KAAK,IACjCjD,GAAGsE,OAAO,kBAAkBrB,KAAK,IAInC,SAASkF,IACR,IAAI2F,EAAI9N,GAAGgH,KAAK+G,OAAO,SACvB/N,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAUyK,WAAW/K,KAAK6K,EAAExO,EAAK2F,aACvDjF,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAU0K,SAAShL,KAAK6K,EAAExO,EAAK4F,WAGtD,SAASyB,IACRmD,IACAoC,IACA/F,IAGD,SAASD,IACRjC,GAAQ,EACRjE,GAAGoG,UAAU,gBAAgBG,QAAQ,eAAc,IAjSpDhB,EAAMjG,EAAKA,EAAKiE,UAAUgC,IAAIa,UAAU,YACtC5G,MAAMkK,KACJ0B,QAAQzF,OAAQ,QAClBY,QAAQ,OAAM,GAChBhB,EACEK,KAAK,IAAI6D,GACXlE,EAAI8F,OAAOC,SA8RXxB,IACAoC,IACA/F,IAGA/G,YACC0F,MAAMF,YACL,IAAIsJ,EAAoB,IAAdlP,KAAKqE,KAAa,EAAI,EAElCrE,KAAKyF,cAAcc,IAAIa,UAAU,KAAKkF,SACtCtL,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUsD,YAAYT,UAAU,KAAKkF,SAE3DtL,GAAGoG,UAAU,yBAAyBG,QAAQ,YAAW,GACzDvG,GAAGsE,OAAO,2BAA2BiC,QAAQ,YAAW,GAExDvG,GAAGoG,UAAU,MAAO8H,GAAK3J,MAAM,UAAU,QACzCvE,GAAGoG,UAAU,MAAOpH,KAAKqE,MAAMkB,MAAM,UAAU,SAE/CvF,KAAKiG,WAAajG,KAAK+F,MAAM,GAC7B/F,KAAKkG,SAAWlG,KAAK+F,MAAM,UAOvB2J,oBAAoBtL,cACxBhE,cACE0F,QACA9F,KAAKuE,SAAW,cAChBvE,KAAK2P,iBAAmB,KAAK,MAC7B3P,KAAK4P,UACL5P,KAAK6P,UAA0B,EAAd7P,KAAK4E,OACtB5E,KAAK8P,YAAc9O,GAAGsE,OAAOkB,GAAGC,IAAI/D,YAAY/B,QAAQoP,YAAYC,OAAOrC,wBAAwBlJ,MACnGwL,QAAQC,IAAI,gBAAkBlQ,KAAK6P,WAGrCzP,OACE0F,MAAMK,OAGR/F,QACEY,GAAGsE,OAAO,QAAQC,MAAM,WAAW,WACnCvE,GAAGsE,OAAO,QAAQC,MAAM,SAAS,QAGnCnF,QACE,IAAIE,EAAON,KAIXgB,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU5D,QAAQkG,MACrC5C,KAAKuC,GAAGM,mBAAmB9G,OAE9BgB,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU5D,QAAQkG,MACrCO,UAAU,WAAWC,KAAK,WACzBrG,GAAGsE,OAAOtF,MAAM+G,GAAG,QAAQ,WACzB,IAAIO,EAAOtG,GAAGsE,OAAOtF,MACjBmQ,EAAO7I,EAAKV,KAAK,YACjBwJ,EAAMpP,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAU5D,QAAQkG,MAAMO,UAAU,cAAc,GAAGzF,QAAUrB,EAAKqP,gBAAgBhO,OAE/G2F,EAAKC,QAAQ,aACdD,EAAKC,QAAQ,YAAW,GACxBjH,EAAKqP,gBAAgBrP,EAAKqP,gBAAgBlI,QAAQ0I,IAAS,MAEtDC,IACH9I,EAAKC,QAAQ,YAAW,GACxBjH,EAAKqP,gBAAgBrP,EAAKqP,gBAAgBlI,QAAQ,OAAS0I,GAI/D7P,EAAK8E,eAObhF,WACE0F,MAAMV,WAEN,IAAI9E,EAAON,KAMX,GAJAA,KAAK4F,YAIkF,GAAnF5E,GAAGsE,OAAOkB,GAAGC,IAAInG,EAAKiE,UAAU5D,QAAQkG,MAAMO,UAAU,cAAc,GAAGzF,OAA7E,CAMA,IAFA,IAAI0O,KAEI5O,EAAE,EAAGA,EAAEzB,KAAK2P,gBAAgBhO,OAAQF,IAAK,CAC/C,IACI0O,EAAOnQ,KAAK2P,gBAAgBlO,GAC5B6O,EAAS9J,GAAGC,IAAIzG,KAAKuE,UAAUwL,WAAWtO,GAAG6O,OACtC9J,GAAGC,IAAIzG,KAAKuE,UAAUwL,WAAWtO,GAAGiF,KAEnC,MAARyJ,GACFnP,GAAGsE,OAAOgL,GAAQrM,KAAKjE,KAAKW,QAAQwP,IACpCnQ,KAAK4P,OAAOnO,GAAKzB,KAAK0C,YAAYyN,GAClCE,EAAQA,EAAME,OAAOvQ,KAAK0C,YAAYyN,IACtCnP,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUwL,WAAWtO,GAAGiF,MAAMC,OAAO,SAE3D3F,GAAGsE,OAAOgL,GAAQrM,KAAK,oBACvBjE,KAAK4P,OAAOnO,GAAK,MAKrB,IAAI+O,KAAaC,KACjBzP,GAAGe,KAAKzB,EAAKoC,aAAaxB,QACxB,SAASC,GACPqP,EAAOrM,KAAKnD,GAAG0P,IAAIpQ,EAAKoC,YAAYvB,GAAI,SAASqE,GAAK,OAAO,IAAIQ,KAAKR,EAAGpC,cACzEqN,EAAKtM,KAAKnD,GAAGoP,IAAI9P,EAAKoC,YAAYvB,GAAI,SAASqE,GAAK,OAAO,IAAIQ,KAAKR,EAAGlC,cAG3E,IAAIqN,EAAgB3P,GAAG0P,IAAIF,GACvBI,EAAc5P,GAAGoP,IAAIK,GAEzBR,QAAQC,IAAI,oBAAsBlQ,KAAK6P,WAIvC,IAAIgB,EAAU7Q,KAAK6P,UACD,GACA7O,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU5D,QAAQ2P,QAAQN,OAAOrC,wBAAwB/I,OAC/E5D,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUwL,WAAW,GAAGO,QAAQN,OAAOrC,wBAAwB/I,OAEvGqL,QAAQC,IAAI,qBAAuBW,GAEnC7P,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU5D,QAAQoP,YAAYxK,MAAM,SAASsL,EAAU,MAC7E7P,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU+C,MAAM/B,MAAM,SAASsL,EAAU,MAC/D7P,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAU5D,QAAQkG,MAAMtB,MAAM,SAASsL,EAAU,MAiBvE,IAbA,IAAIC,EAAc9P,GAAGgH,KAAKD,QAAQE,QAAQ0I,EAAeC,IAAc7K,OAAO,EAAG/F,KAAK6P,YAIlFkB,EAAY/P,GAAGgH,KAAKD,QAAQE,QAAQ0I,EAAeC,IAAc7K,OAAO,EAAE/F,KAAK6P,YAC/EmB,EAAQhQ,GAAGmH,IAAIC,OACJL,MAAMgJ,GACN1I,OAAO,QACPE,SAA4B,IAAnBvI,KAAK8P,YAAmB,GACjCtH,aAAa,IACbyI,WAAWjQ,GAAGgH,KAAK+G,OAAO,OAGjC/C,EAAE,EAAGA,EAAEhM,KAAK2P,gBAAgBhO,OAAQqK,IAC1ChM,KAAKkR,eAAelF,EAAE8E,EAAYE,IAKtC5Q,eAAeoH,EAAMsJ,EAAYE,GAC/B,IAAI1Q,EAAON,KACPmR,EAAYnR,KAAK2P,gBAAgBnI,GACjC4J,EAAQpR,KAAK4P,OAAOpI,GACpBd,EAAOF,GAAGC,IAAIzG,KAAKuE,UAAUwL,WAAWvI,GAAOd,KAEnD,GAAa,MAAT0K,EAAJ,CAIA,IAAIjJ,EAAMnH,GAAGsE,OAAOoB,GAAMpB,OAAO,OAEjC6C,EAAIvB,KAAK,SAAU5G,KAAK6P,WACxB7O,GAAGsE,OAAOoB,GAAMnB,MAAM,SAASvF,KAAK6P,WAGpC,IAAIwB,EAAsB,IAAlBrR,KAAK8P,YAAmB,GAAI,GAEzB,GAAPtI,GACFW,EAAIxB,OAAO,KACRC,KAAK,KAAK,kBACV9E,KAAKkP,GACLlP,KAAK,SAASwP,GACbA,EAAE/L,MAAM,YAAY,cAAgB8L,EAAI,OACxCC,EAAElK,UAAU,QAAQR,KAAK,IAAI,MAMnC,IAAI2K,EAAUpJ,EAAIf,UAAU,aAAa5G,MAAM2Q,IAE/CI,EAAQnF,QAAQzF,OAAO,KAAKY,QAAQ,WAAU,GAE9CgK,EACK3K,KAAK,QAAS,kBAAoBY,GAClCZ,KAAK,YAAa,SAASzF,EAAEM,GAG1B,MAAO,mBAGf8P,EAAQlF,OAAOC,SAGf,IACIkF,EAAcD,EAAQnK,UAAU,sBAAsB5G,KAAK4Q,GAC/DI,EAAYpF,QAAQzF,OAAO,UAAUY,QAAQ,eAAc,GAC3DiK,EACK5K,KAAK,KAAK,IACVA,KAAK,KAAK,SAASzF,EAAEM,GAClB,OAAON,EAAEiC,UAAY0N,EAAY,IAAI9K,KAAK7E,EAAEiC,YAAc0N,EAAY,IAAI9K,KAAK7E,EAAEmC,YAEpFsD,KAAK,IARM,GASXD,OAAO,QACLC,KAAK,QAAQ,OACb0G,KAAK,SAASnM,GACjB,IAAIoM,KAEJ,QAAoC,IAA1BjN,EAAKO,OAAOM,EAAE0B,SAAxB,CAGA0K,EAAQpJ,KAAK7D,EAAKO,OAAOM,EAAE0B,SAASP,WAEpC,IAAIkJ,KAmBF,MAjBiB,IAAfrK,EAAEiC,WACJoI,EAAKrH,KAAK,YAAchD,EAAEiC,UAAUuI,YAGZ,IAAnBxK,EAAEgC,eACHqI,EAAKrH,KAAK,KAAOhD,EAAEgC,cAAcwI,WAAa,KAEnC,IAAbxK,EAAEmC,SACJkI,EAAKrH,KAAK,YAAchD,EAAEmC,SAGX,IAAbnC,EAAEmC,SACAkI,EAAKrH,KAAK,KAAOhD,EAAEgC,cAAcwI,WAAa,KAGpD4B,EAAQpJ,KAAKqH,EAAKpJ,KAAK,KAEdmL,EAAQnL,KAAK,aAEtBoP,EACGzK,GAAG,QAAQ,WAMP/F,GAAGsE,OAAOtF,MAAlB,IACI6L,EAAI7K,GAAGsE,OAAOtF,MAAMsF,OAAO,QAAQgI,OAEnCI,EAAO1N,KAAK2N,wBACZC,EAAMF,EAAKE,IAAMlJ,OAAOmJ,YAAc,GACtCC,EAAOJ,EAAKI,KAAOpJ,OAAOqJ,YAAc,GAE3C/M,GAAGsE,OAAO,YAAYgH,SAEzBtL,GAAGsE,OAAOkB,GAAGC,IAAI/D,YAAY4E,MAC1BX,OAAO,OACPC,KAAK,QAAQ,WACRrB,OACJqI,IAAOA,EAAM,KACbE,KAAQA,EAAO,KACfE,OAAW,OACXC,MAAU,SAEXhK,KAAK4H,GACL9E,GAAG,QAAQ,WAIV/F,GAAGsE,OAAOtF,MACNuF,OACC2I,sBAAsB,UACtBC,uBAAwB,UACxBC,sBAAuB,cAExBZ,aACAa,MAAM,KACN/B,aAKTkF,EAAYnF,OAAOC,UAMrBlM,aAAaqR,GACT,IAGIC,EAHAC,EAAc3Q,GAAGsE,OAAO,IAAImM,EAAM,WAAWG,SAAS,SACtDT,EAAYnR,KAAKY,aAAa+Q,GAGbD,EAAT,QAATD,EAA6BzR,KAAK6R,SACnB7R,KAAK8R,UAEvB,IAAIxR,EAAON,KACP+R,EAAmB,GAAZ/R,KAAK4E,OAChB8M,EAAS9K,KAAK,SAAUmL,GAGxB,IAAIvB,KAAaC,KACjBzP,GAAGe,KAAKzB,EAAKoC,aAAaxB,QACtB,SAASC,GACLqP,EAAOrM,KAAKnD,GAAG0P,IAAIpQ,EAAKoC,YAAYvB,GAAI,SAASqE,GAAK,OAAO,IAAIQ,KAAKR,EAAGpC,cACzEqN,EAAKtM,KAAKnD,GAAGoP,IAAI9P,EAAKoC,YAAYvB,GAAI,SAASqE,GAAK,OAAO,IAAIQ,KAAKR,EAAGlC,cAG/E,IAAIqN,EAAgB3P,GAAG0P,IAAIF,GACvBI,EAAc5P,GAAGoP,IAAIK,GAGrBK,EAAc9P,GAAGgH,KAAKD,QAAQE,QAAQ0I,EAAeC,IAAc7K,OAAO,EAAGgM,EAAM,IAAK,KAGxFR,EAAUG,EAAStK,UAAU,aAAa5G,KAAK2Q,GACnDI,EAAQnF,QAAQzF,OAAO,KAAKY,QAAQ,WAAU,GAC9CgK,EACK3K,KAAK,QAAS,kBAAoB6K,GAClC7K,KAAK,YAAa,SAASzF,EAAEM,GAG1B,MAAO,aAFCA,GAAGnB,EAAKmE,MAAM,GAEG,SAEjC8M,EAAQlF,OAAOC,SAGf,IAAI0F,EAAwBT,EAAQnK,UAAU,8BACzC5G,KAAKF,EAAKoC,YAAYyO,IAC3Ba,EAAsB5F,QAAQzF,OAAO,QAAQY,QAAQ,yBAAwB,GAC7EyK,EACKpL,KAAK,KAAKtG,EAAKmE,MAAM,GACrBmC,KAAK,KAAK,SAASzF,EAAEM,GAAI,OAAOqP,EAAYA,EAAY7I,SAAS,MACjErB,KAAK,KAAKtG,EAAKmE,MAAM,GACrBmC,KAAK,KAAK,SAASzF,EAAEM,GAAI,OAAOqP,EAAYA,EAAY7I,SAAS,MACtE+J,EAAsB3F,OAAOC,SAG7B,IAAI2F,EAAeV,EAAQnK,UAAU,oBAAoB5G,KAAK2Q,GAC9Dc,EAAa7F,QAAQzF,OAAO,QAAQY,QAAQ,eAAc,GAC1D0K,EACKrL,KAAK,IAAItG,EAAKmE,MAAM,GACpBmC,KAAK,KAAK,IACV0G,KAAKqE,GACVM,EAAa5F,OAAOC,SAGpB,IAAI4F,EAAaX,EAAQnK,UAAU,mBAAmB5G,KAAKF,EAAKoC,YAAYyO,IAC5Ee,EAAW9F,QAAQzF,OAAO,QAAQY,QAAQ,cAAa,GACvD2K,EACKtL,KAAK,QAAS,qBAAuB6K,GACrC7K,KAAK,KAAKtG,EAAKmE,MAAM,GACrBmC,KAAK,KAAK,SAASzF,EAAGM,GACnB,OAAON,EAAEiC,UAAY0N,EAAY,IAAI9K,KAAK7E,EAAEiC,YAAc0N,EAAY,IAAI9K,KAAK7E,EAAEmC,YAEpFsD,KAAK,KAAKtG,EAAKmE,MAAM,GACrBmC,KAAK,KAAK,SAASzF,EAAGM,GACnB,OAAON,EAAEmC,QAAUwN,EAAY,IAAI9K,KAAK7E,EAAEmC,UAAYwN,EAAY,IAAI9K,KAAK7E,EAAEiC,cAErF8O,EAAW7F,OAAOC,SAGlB,IAAI6F,EAAeZ,EAAQnK,UAAU,qBAAqB5G,KAAKF,EAAKoC,YAAYyO,IAChFgB,EAAa/F,QAAQzF,OAAO,QAAQY,QAAQ,gBAAe,GAC3D4K,EACKvL,KAAK,KAAKtG,EAAKmE,MAAM,EAAG,IACxBmC,KAAK,KAAK,SAASzF,EAAEM,GAClB,OAAON,EAAEiC,UAAY0N,EAAY,IAAI9K,KAAK7E,EAAEiC,YAAc0N,EAAY,IAAI9K,KAAK7E,EAAEmC,YAEpFsD,KAAK,KAAKtG,EAAKmE,MAAM,EAAG,IACxBmC,KAAK,KAAK,SAASzF,EAAEM,GAClB,OAAON,EAAEiC,UAAY0N,EAAY,IAAI9K,KAAK7E,EAAEiC,YAAc0N,EAAY,IAAI9K,KAAK7E,EAAEmC,YAEzF6O,EAAa9F,OAAOC,SAGpB,IACIkF,EAAcD,EAAQnK,UAAU,sBAAsB5G,KAAKF,EAAKoC,YAAYyO,IAChFK,EAAYpF,QAAQzF,OAAO,UAAUY,QAAQ,eAAc,GAC3DiK,EACK5K,KAAK,KAAKtG,EAAKmE,MAAM,EAAG,IACxBmC,KAAK,KAAK,SAASzF,EAAEM,GAClB,OAAON,EAAEiC,UAAY0N,EAAY,IAAI9K,KAAK7E,EAAEiC,YAAc0N,EAAY,IAAI9K,KAAK7E,EAAEmC,YAEpFsD,KAAK,IARM,GAShB4K,EAAYnF,OAAOC,SAGnB,IAAI8F,EAAqBb,EAAQnK,UAAU,2BAA2B5G,KAAKF,EAAKoC,YAAYyO,IAC5FiB,EAAmBhG,QAAQzF,OAAO,QAAQY,QAAQ,sBAAqB,GACvE6K,EACKxL,KAAK,IAAItG,EAAKmE,MAAM,EAAG,IACvBmC,KAAK,IAAI,SAASzF,EAAEM,GACjB,OAAQN,EAAEiC,UAAY0N,EAAY,IAAI9K,KAAK7E,EAAEiC,YAAc0N,EAAY,IAAI9K,KAAK7E,EAAEmC,WAAY,IAEjGgK,KAAK,SAASnM,GACX,IAAIkR,EAAKlR,EAAEiC,WAAa,UACpBkP,EAAKnR,EAAEmC,SAAW,UACtB,OAAOhD,EAAKO,OAAOM,EAAE0B,SAASP,UAAY,KAAM+P,EAAI,OAAQC,EAAI,MAExEF,EAAmB/F,OAAOC,SAI9BlM,kBACI,IAAI2R,EAAmB,EAAZ/R,KAAK4E,OAChB5E,KAAKmI,IAAIvB,KAAK,SAAUmL,GAK5B3R,YACE0F,MAAMF,YACN,IAAI,IAAInE,EAAE,EAAEA,EAAEzB,KAAK2P,gBAAgBhO,OAAOF,IACxCT,GAAGsE,OAAOkB,GAAGC,IAAIzG,KAAKuE,UAAUwL,WAAWtO,GAAGiF,MAAMU,UAAU,KAAKkF,UAiBzE,IAAI7G,cAAgB,IAAIiG,OACpBrF,aAAe,IAAIqF,OACnBhJ,YAAc,IAAIgJ,OAEtB1K,GAAGsE,OAAO,QAAQC,MAAM,UAAU,IAIlC,IAAIR,GAAK,IAAI5E,YAAY,WAEvBa,GAAGoG,UAAUZ,GAAGC,IAAI8L,MAAMlL,KAAK,WAC9BrG,GAAGsE,OAAOtF,MAAM+G,GAAG,QAAQ,WAKzB,OAFD/F,GAAGsE,OAAO,YAAYgH,SAEdtL,GAAGsE,OAAOtF,MAAM4G,KAAK,cAC1B,IAAK,IACF5F,GAAGsE,OAAO,QAAQC,MAAM,WAAW,WACrCvE,GAAGsE,OAAO,QAAQC,MAAM,SAAS,QAClC,MACA,IAAK,IACGE,cAAc+M,eAAe,eAIhC/M,cAAcR,SAHdQ,cAAgB,IAAI0J,eACNhJ,OAIhB,MACF,IAAK,IAGEE,aAAamM,eAAe,eAI/BnM,aAAapB,SAHboB,aAAe,IAAID,cACND,OAKhB,MACF,IAAK,IACGzD,YAAY8P,eAAe,eAI9B9P,YAAYuC,SAHZvC,YAAc,IAAIgN,aACNvJ,OAKf,MACD,IAAK,IAGLpB,GAAG0N,YAIHzR,GAAGsE,OAAOkB,GAAGC,IAAIiM,aAAa3L,GAAG,QAAQ,WACpC/G,KAAK2I,MAAMhH,OAAO,GAClBX,GAAGsE,OAAOkB,GAAGC,IAAIkM,eAAe1O,KAAKc,GAAG6N,qBAAqB5S,KAAK2I,eAU7E3H,GAAGsE,OAAO,QAAQkI,WAAW,KAAKjI,MAAM,UAAU,KAMpDvE,GAAG6R,UAAUjT,UAAUkT,MAAQ,WAC7B,OAAO9R,GAAGsE,OAAOtF,KAAK,GAAG,KAE3BgB,GAAG6R,UAAUjT,UAAUmT,KAAO,WAC5B,IAAIA,EAAO/S,KAAKgT,OAAS,EACzB,OAAOhS,GAAGsE,OAAOtF,KAAK,GAAG+S","file":"../../../archive/phase 2/vis.js","sourcesContent":["/* global d3 */\r\n/* global ui */\r\n/* global dm */\r\n/* global topojson */\r\n/* global lunr */\r\n\r\n// Used in some instances for String.replace()\r\n\r\nString.prototype.replaceAll = function(search, replacement) {\r\n    var target = this;\r\n    return target.replace(new RegExp(search, 'g'), replacement);\r\n};\r\n\r\n\r\n\r\n// The DataManager object is designed to load JSON files once then make the data available to all visualizations.\r\n// Special handling is required to compensate for asynchronous load (the d3.json method does not have a\r\n// synchronous loading method). We could consider jQuery’s ajax method here, but the queue.js library\r\n// is more lightweight.\r\n\r\nclass DataManager {\r\n  constructor(func) {\r\n    var self = this;\r\n    this.loading = [];\r\n    this.data = {};\r\n    this.idx;\r\n    this.compiled = {};\r\n    \r\n    this.authors = {};\r\n    this.author_names = {};\r\n    this.places = {};\r\n    \r\n    var datasets = ['author_ids','intersections','itineraries','places','continents'];    \r\n\t\t\r\n\t\t// d3-queue.js manages deferred processing\r\n\t\t\r\n\t\tvar q = d3.queue();\r\n\t\t\r\n\t\tdatasets.forEach(function(d){\r\n  \t\tvar filepath = 'data/three_' + d +'.json';\r\n  \t\tq.defer(d3.json,filepath)\r\n\t\t});\t\r\n\t\t\r\n\t\tq.await(function(error){\r\n  \t\tif (error) throw error;\r\n  \t\t\r\n  \t\t// the first argument is an error object, the subsequent ones correspond to the json datasets\r\n  \t\t\r\n  \t\tfor(var i=1;i < arguments.length; i++) {\r\n    \t\tvar darg = i-1;\r\n    \t\tself.data[datasets[darg]] = arguments[i];\r\n  \t\t}\r\n  \t\t\r\n  \t\tvar invoke = func.call(invoke);\r\n  \t\t\r\n\t\t});\r\n\t\t\t\t\t\r\n  }\r\n  \r\n  buildAuthors() {\r\n    var self = this;\r\n\t\t//authors\r\n\t\td3.keys(self.data.author_ids).forEach(function(k){\r\n\t\t\tself.authors[self.data.author_ids[k]] = k;\r\n      self.author_names[k] = self.data.author_ids[k];\r\n\t\t});\r\n  }\r\n  \r\n  buildPlaces() {\r\n    var self = this;\r\n    //places\r\n  \r\n  // Places Hack: Replaces dashes with underscores to enforce consistency\r\n  \r\n\t\td3.keys(self.data.places).forEach(function(d){\r\n\t\t\tvar k = d.split(',');\r\n\t\t\tk[0] = k[0].trim().split(' ').join('_');\r\n\t\t\tk[1] = k[1].trim().split(' ').join('_');\r\n\t\t\tk = k.join('_').toLowerCase().replaceAll('-','_');\r\n\t\t\tself.places[k] = self.data.places[d];\r\n\t\t\tself.places[k].PlaceName = d;\r\n\t\t});\r\n\t\t\r\n  }\r\n  \r\n  \r\n  indexData() {\r\n    \r\n    var self = this;\r\n    \r\n    this.buildAuthors();\r\n    this.buildPlaces();\r\n    var i=0;\r\n    \r\n    for(var date in this.data.itineraries) { \r\n      this.data.itineraries[date].forEach(function(entry){\r\n        \r\n        // Places Hack: Replaces dashes with underscores to enforce consistency\r\n        var place = self.places[entry.PlaceID.replaceAll('-', '_')]; \r\n        var placename = '';\r\n        \r\n        \r\n        if (typeof place != 'undefined') {\r\n          placename = place.PlaceName;\r\n        }\r\n        \r\n        self.compiled[i] = {\r\n          'ID' : i,\r\n          'Author' : self.authors[entry.AuthorID],\r\n          'AuthorID' : entry.AuthorID,\r\n          'Place' : placename,\r\n          'StartCitation' :  entry.StartCitation,\r\n          'StartDate' :  entry.StartDate,\r\n          'EndCitation' :  entry.EndCitation,\r\n          'EndDate' : entry.EndDate,\r\n          'Notes' : entry.Notes,\r\n          'FullEntry' : entry\r\n        };\r\n        \r\n        i++;\r\n      });     \r\n    }\r\n\r\n    this.idx = lunr(function(){\r\n      var thislunr = this;\r\n      \r\n      this.ref('ID'); \r\n            \r\n      this.field('Author');\r\n      this.field('Place');\r\n      this.field('StartCitation');\r\n      this.field('EndCitation');\r\n      this.field('Notes');\r\n      \r\n      for (var id in self.compiled) {\r\n        thislunr.add(self.compiled[id]);\r\n      }\r\n    });    \r\n  }\r\n  \r\n  Search(term) {\r\n    return this.idx.search(term);\r\n  }\r\n  \r\n  DisplaySearchResults(term) {\r\n    var results = this.Search(term);\r\n    \r\n    if (results.length == 0) {\r\n      return \"<p>No search results found.</p>\";\r\n    }\r\n    \r\n    var html = [];\r\n    \r\n    for(var i=0;i<results.length;i++) {\r\n      var result = this.compiled[results[i].ref];\r\n      \r\n      var date = [];\r\n      \r\n      if (result.StartDate != '') {\r\n        date.push(result.StartDate);\r\n      }\r\n      \r\n      if (result.EndDate != '') {\r\n        date.push(result.EndDate);\r\n      }\r\n      \r\n      html.push(\r\n        \"<div class='search-result'>\" +\r\n          \"<div class='term'>\" + result.Author + \"</div>\" +\r\n          \"<div class='subhead'>\" + result.Place + \" (\" + date.join(' – ') + \")</div>\" +\r\n          (result.Notes != '' ? \"<div class='description'>\" + result.Notes + \"</div>\" : '') + \r\n        \"</div>\"\r\n      );\r\n    }\r\n    \r\n    return html.join(\"\\n\");\r\n  }\r\n  \r\n  getData() {\r\n    return this.data;\r\n  }\r\n}\r\n\r\n/* !VISUALIZATION CLASS */\r\n\r\nclass Visualization {\r\n\t\r\n\tconstructor(){\r\n  \tvar self = this;\r\n\t\tthis.data = {};\r\n\t\tthis.mode = 0;\r\n\t\tthis.places = {};\r\n\t\tthis.authors = {};  // {author_id: author_name}\r\n    this.author_names = {}; // {author_name: author_id}\r\n\t\tthis.continents = {};\r\n\t\tthis.classkey = 'visualization';   \r\n\t\tthis.initialized = false;\r\n\r\n\r\n\t\t//store screen height and width\r\n\t\tthis.width = window.innerWidth;\r\n\t\tthis.height = window.innerHeight;\r\n\t\tthis.ttime = 45;\r\n\t\t\t\t\r\n\t}\r\n\t\r\n\tinit() {\r\n  \tvar self = this;\r\n  \tthis.data = dm.getData();\r\n    this.focus();\r\n    this.process_data(); \r\n\t\tthis.setup();\r\n\t\tthis.generate();\r\n\t\tthis.intialized = true;\t\t\r\n\t}\r\n\t\r\n\tfocus() {\r\n    d3.select('body').style('position','absolute');\r\n\t\td3.select('body').style('bottom','0');\r\n\t\tthis.width = window.innerWidth;\r\n\t\tthis.height = window.innerHeight;\r\n\t}\r\n\r\n\tprocess_data(){\r\n\t\tvar self = this;\t\t\r\n\t\tself.continents = self.data.continents;\r\n\r\n\t\t// places\r\n\t\t\r\n\t\tdm.buildPlaces();\r\n\t\tself.places = dm.places;\r\n\t\t\r\n\t\t// authors\r\n\t\td3.keys(self.data.author_ids).forEach(function(k){\r\n\t\t\tself.authors[self.data.author_ids[k]] = k;\r\n      self.author_names[k] = self.data.author_ids[k];\r\n\t\t});\r\n\t\t\r\n\t\t// itineraries\r\n\t\tself.itineraries = {};\r\n\t\td3.keys(self.authors).forEach(function(d){\r\n\t\t\tif(!self.itineraries[d]){ self.itineraries[d] = []; }\r\n\t\t});\r\n\t\td3.keys(self.data.itineraries).forEach(function(d){\r\n\t\t\tself.data.itineraries[d].forEach(function(_d){\r\n  \t\t\t// Places Hack: Replaces dashes with underscores to enforce consistency\r\n  \t\t\t_d.PlaceID = _d.PlaceID.replaceAll('-','_');\r\n\t\t\t\tself.itineraries[_d.AuthorID].push(_d);\r\n\t\t\t});\r\n\t\t});\r\n    \r\n    // intersections\r\n    \r\n\t\tself.intersections = {};\r\n\t\t\r\n\t\t// Places Hack: Replaces dashes with underscores to enforce consistency\r\n    // Original code was simply:\r\n    // self.intersections = self.data.intersections\r\n\t\t\r\n\t\td3.keys(this.data.intersections).forEach(function(key) {\r\n  \t\tself.intersections[key] = {};\r\n  \t\td3.keys(self.data.intersections[key]).forEach(function(_key) {\r\n        self.intersections[key][_key.replaceAll('-','_')] = self.data.intersections[key][_key];\r\n      });\r\n    });\r\n\t\t\r\n\t}\r\n\r\n\tsetup(){\r\n\t\tvar self = this;\r\n\t}\r\n\r\n\tgenerate(){\r\n    this.tear_down();\r\n\t}\r\n\t\r\n\ttear_down(){\r\n\t}\r\n}\r\n\r\n/* !DATEMAPCONTROLLER CLASS */\r\n\r\n/* Refactoring note: This controller class should handle the map and date slider functionality. \r\n   Right now it does nothing except establish a common date range (which itself should be configurable).\r\n   \r\n   The structure of the current map and slider code will prove a challenge here. They currently rely on\r\n   localized functions, which themselves are very tied to their individual visualizations and are not\r\n   very portable. This will need to be rethought.\r\n*/\r\n\r\n\r\n\r\nclass DateMapController extends Visualization {\r\n  constructor() {\r\n    super();\r\n    \r\n\t\tthis.range = [\r\n\t\t\tnew Date(1890,0,1),\r\n\t\t\tnew Date(2010,0,1)\r\n\t\t];\r\n\t\t\r\n\t\tthis.date_start = this.range[0];\r\n\t\tthis.date_end = this.range[1];\r\n  }\r\n  \r\n  init() {\r\n    super.init();\r\n  }\r\n  \r\n  setup() {\r\n    super.setup();\r\n  }\r\n  \r\n  process_data() {\r\n    super.process_data(); \r\n  }\r\n  \r\n  generate() {\r\n    super.generate();  \r\n  }\r\n    \r\n  tear_down() {\r\n    super.tear_down();\r\n  }\r\n}\r\n\r\n/* !TRAJECTORIES CLASS */\r\n\r\nclass Trajectories extends DateMapController {\r\n  constructor() {\r\n    super();\r\n    this.intersections = {}\r\n    this.trajectories = {}\r\n    this.mode = 2;         \r\n    this.classkey = 'trajectories';\r\n\t\tthis.active_authors_t = [];\r\n  }\r\n  \r\n  init() {\r\n    super.init();\r\n  }\r\n  \r\n  setup() {\r\n    \r\n\t\tsuper.setup();\r\n\t\t\r\n\t\tvar self = this;\r\n\r\n    // Trajectories setup\r\n    \r\n\t\tthis.trajectories.map = d3.select(ui.dom.trajectories.map.view)\r\n\t\t  .append('svg')\r\n\t\t  .attr('width','100%');\r\n\t\t          \r\n    d3.select(ui.dom.trajectories.authors.list)\r\n      .html(ui.generateAuthorList(this));\r\n  }\r\n  \r\n  process_data() {\r\n    super.process_data();\r\n    \t\t\t\t    \r\n    //trajectories\r\n\t\tthis.trajectories = {};\r\n    \r\n  }\r\n  \r\n  \r\n  /* !-- Trajectory Generate */\r\n\r\n  // Refactoring note: Ideally the slider and map should be generated here using common code.\r\n\r\n  generate(){\r\n    super.generate();\r\n    \r\n\t\tvar self = this;\r\n\t\tvar focus = false;\r\n\r\n\t\tthis[this.classkey].map.attr('height',this.height);\r\n\r\n\t\t//click handlers\r\n\t\tthis[this.classkey].map.on('click',function(){\r\n\t\t\td3.event.stopPropagation();\r\n\t\t\tunfocus();\r\n\t\t\tdisplay_results();\r\n\t\t});\r\n\t\t\r\n\t\t// Manage active trajectory map authors\r\n\t\t\r\n    d3.select(ui.dom[this.classkey].authors.list)\r\n      .selectAll('.author').each(function(){\r\n        d3.select(this).on('click',function(){\r\n          var elem = d3.select(this);          \r\n          if (elem.classed('selected')) { // remove item from active list\r\n            elem.classed('selected',false);\r\n            var index = self.active_authors_t.indexOf(elem.attr('data-key'));\r\n            if (index > -1) {\r\n              self.active_authors_t.splice(index,1);\r\n            }\r\n          } else {\r\n            elem.classed('selected',true);\r\n            self.active_authors_t.push(elem.attr('data-key'));\r\n          }\r\n          \r\n          update();\r\n        });\r\n      });\r\n      \r\n\t\t//slider\r\n\t\t\r\n\t\tvar sliderwidth = ui.dom[this.classkey].dateslider.offsetWidth;\r\n\t\t\t\t\t\t\r\n\t\tvar scale = d3.time.scale()\r\n\t\t\t.domain(this.range);\r\n\t\t\t\t\t\r\n\t\tvar scale_axis = d3.svg.axis()\r\n\t\t\t.orient('right')\r\n\t\t\t.ticks(10)\r\n\t\t\t.tickSize(sliderwidth - 2) //takes into account a 2px border\r\n\t\t\t.tickPadding(12);\r\n\t\t\t\r\n\t\tvar slide = d3.slider()\r\n\t\t\t.scale(scale)\r\n\t\t\t.axis(scale_axis)\r\n\t\t\t.value([\r\n\t\t\t\tscale_value_converter(this.range[1]),\r\n\t\t\t\tscale_value_converter(this.range[0])\r\n\t\t\t])\r\n\t\t\t.orientation('vertical')\r\n\t\t\t.margin(0)\r\n\t\t\t.animate(false)\r\n\t\t\t.on('slide',function(evt,value){\r\n\t\t\t\tvar v_1 = value[1] instanceof Date ? value[1] : new Date(value[1]),\r\n\t\t\t\t\t\tv_2 = value[0] instanceof Date ? value[0] : new Date(value[0]);\r\n\t\t\t\t\r\n\t\t\t\tself.date_start = scale_value_converter(v_1);\r\n\t\t\t\tself.date_end = scale_value_converter(v_2);\r\n\r\n\t\t\t\t// unfocus();\r\n\t\t\t\tupdate_datebar();\r\n\t\t\t\tupdate();\r\n\t\t\t})\r\n\t\t\t.on('slideend',function(evt,value){\r\n\t\t\t\tupdate();\r\n\t\t\t});\r\n\t\t\t\r\n\r\n\t\t//the slider library, though lightweight, is flawed\r\n\t\t//use this to convert the date values properly\r\n\t\tfunction scale_value_converter(_val){\r\n\t\t\tvar s = d3.time.scale()\r\n\t\t\t\t.domain(scale.domain())\r\n\t\t\t\t.range([0,self.height])\r\n\t\t\t\t.nice(d3.time.month)\r\n\t\t\t\t;\r\n\t\t\treturn s.invert(self.height -s(_val));\r\n\t\t}    \r\n\r\n\t\tvar slider = d3.select(ui.dom[this.classkey].dateslider).call(slide);\r\n\t\t\r\n\t\td3.select(ui.dom[this.classkey].dateslider).selectAll('text').attr(\"transform\", \"translate(-\" + sliderwidth + \",20)\");\r\n\t\t\r\n\t\tupdate_datebar();\r\n\r\n\t\t//map\r\n\t\tvar projection = d3.geo.mercator()\r\n\t\t\t.scale(160)\r\n\t\t\t.translate([ui.dom[this.classkey].map.view.offsetWidth * 0.5,ui.dom[this.classkey].map.view.offsetHeight * 0.5]);\r\n\t\t\r\n\t\tvar path = d3.geo.path().projection(projection);\r\n\r\n\t\tvar features = topojson.feature(self.continents,self.continents.objects.continents);\r\n\t\tvar intersections,\r\n\t\t\t\tintersections_unique,\r\n\t\t\t\ttrajectories,\r\n\t\t\t\ttrajectories_unique;\r\n\t\tvar points_target,\r\n\t\t\t\tpoints_g,\r\n\t\t\t\tpoints_backs,\r\n\t\t\t\tpoints_03,\r\n\t\t\t\tpoints_02,\r\n\t\t\t\tpoints_01,\r\n\r\n\t\t\t\tlines_target,\r\n\t\t\t\tlines_g,\r\n\t\t\t\tlines;\r\n\r\n\t\t//draw vector map\r\n\t\tvar map;\r\n\t\tmap = self[this.classkey].map.selectAll('path.map')\r\n\t\t\t.data([features]);\r\n\t\tmap.enter().append ('path')\r\n\t\t\t.classed('map',true);\r\n\t\tmap\r\n\t\t\t.attr('d',path);\r\n\t\tmap.exit().remove();\r\n\r\n\t\tfunction filter_data(){\r\n  \t\t  \t\t\r\n\t\t\t//clear objects\r\n\t\t\tintersections = {};\r\n\t\t\tintersections_unique = {};\r\n\t\t\ttrajectories = {};\r\n\t\t\ttrajectories_unique = {};\r\n\t\t\t\r\n\t\t\t//INTERSECTIONS\r\n\t\t\t//filter by date range\r\n\r\n\t\t\tvar holder = d3.entries(self.intersections).filter(function(d){  \t\t\t\r\n\t\t\t\tvar n = new Date(d.key);\r\n\t\t\t\treturn n >= self.date_start && n <=self.date_end;\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t//get distinct places\r\n\t\t\t//slot author IDs into place\r\n\t\t\t//highest likelihood score wins\r\n\t\t\tholder.forEach(function(d){\r\n\t\t\t\tif(d3.keys(d.value).length >0){\r\n\t\t\t\t\td3.keys(d.value).forEach(function(_d){  // _d is city key\r\n  \t\t\t\t\t\r\n  \t\t\t\t\t// Check to see if there is at least 1 valid author\r\n  \t\t\t\t\tvar b = 0;\r\n  \t\t\t\t\t\r\n            d.value[_d].forEach(function(__d){\r\n              if (self.active_authors_t.indexOf(__d.AuthorID) > -1) {\r\n                b++;\r\n              }\r\n            });\r\n                        \r\n            if (b==0) { return; }\r\n  \t\t\t\t\t\r\n  \t\t\t\t\t// Create entry\r\n  \t\t\t\t\t\r\n\t\t\t\t\t\tif(!intersections[_d]){ \r\n\t\t\t\t\t\t\tintersections[_d] = {}; \r\n\t\t\t\t\t\t\tintersections[_d].figures = {}; \r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t    // Only add valid authors\r\n\t\t\t\t    \t\t\r\n\t\t\t\t\t\td.value[_d].forEach(function(__d){\r\n\t\t\t\t\t\t\tif((!intersections[_d].figures[__d.AuthorID] || intersections[_d].figures[__d.AuthorID] >__d.Likelihood) && self.active_authors_t.indexOf(__d.AuthorID) > -1){\r\n\t\t\t\t\t\t\t\tintersections[_d].figures[__d.AuthorID] = __d.Likelihood;\r\n\t\t\t\t\t\t\t\tintersections[_d].info = d.value[_d];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t//tally up totals\r\n\t\t\t\r\n\t\t\t// Assigns intersections lists dynamically\r\n\t\t\t\r\n\t\t\td3.keys(intersections).forEach(function(d){\r\n\t\t\t\tintersections[d].lists = {};\r\n\t\t\t  for(var i=1;i <= Object.keys(self.authors).length; i++) {\r\n  \t\t\t\tvar key = \"_0\" + i.toString();\r\n  \t\t\t\tintersections[d].lists[key] = d3.values(intersections[d].figures).filter(function(_d){ return _d === i; });\r\n        }\r\n\t\t\t});\r\n\r\n\t\t\t//make list of unique intersections per place\r\n\t\t\tholder.forEach(function(d){\r\n\t\t\t\td3.keys(d.value).forEach(function(_d){\r\n\t\t\t\t\tif(!intersections_unique[_d]){ intersections_unique[_d] = []; }\r\n\t\t\t\t\td.value[_d].forEach(function(__d){\r\n\t\t\t\t\t\tif(intersections_unique[_d].filter(function(t){ return t.AuthorID === __d.AuthorID && t.EndDate === __d.EndDate; }).length === 0){\r\n\t\t\t\t\t\t\tintersections_unique[_d].push(__d);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t//TRAJECTORIES\r\n\t\t\t\r\n\t\t\tholder.forEach(function(d){\r\n\t\t\t\td3.keys(d.value).forEach(function(_d){\r\n\t\t\t\t\td.value[_d].forEach(function(__d){\r\n\t\t\t\t\t\tif(!trajectories[__d.AuthorID]){ trajectories[__d.AuthorID] = []; }\r\n\t\t\t\t\t\tif(trajectories[__d.AuthorID].filter(function(t){ return t.PlaceID === __d.PlaceID && t.EndDate === __d.EndDate; }).length === 0){\r\n\t\t\t\t\t\t\ttrajectories[__d.AuthorID].push(__d);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\r\n      for (var author in trajectories) {\r\n       if (self.active_authors_t.indexOf(author) == -1) {\r\n         delete trajectories[author];\r\n       } \r\n      }\r\n      \r\n      // Places Hack: Replaces dashes with underscores to enforce consistency\r\n      \r\n      d3.keys(trajectories).forEach(function(key) {\r\n        d3.keys(trajectories[key]).forEach(function(__key) {\r\n          trajectories[key][__key].PlaceID = trajectories[key][__key].PlaceID.replaceAll('-','_');\r\n        });\r\n      });\r\n                              \r\n\t\t\t//pair up start and end points\r\n\t\t\tvar tier = 0;\r\n\t\t\tfor(var i=0; i<d3.keys(trajectories).length; i++){\r\n\t\t\t\tfor(var j=0; j<trajectories[d3.keys(trajectories)[i]].length -1; j++){\r\n\t\t\t\t\ttrajectories[d3.keys(trajectories)[i]][j].PlaceID_End = trajectories[d3.keys(trajectories)[i]][j+1].PlaceID;\r\n\t\t\t\t\ttrajectories[d3.keys(trajectories)[i]][j].Likelihood_End = trajectories[d3.keys(trajectories)[i]][j+1].Likelihood;\r\n\t\t\t\t\ttrajectories[d3.keys(trajectories)[i]][j].tier = tier;\r\n\t\t\t\t\ttier=(j%2)*10;\r\n\t\t\t\t} \r\n\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t//make list of unique trajectories per place\r\n\t\t\td3.keys(intersections).forEach(function(d){\r\n\t\t\t\tif(!trajectories_unique[d]){ trajectories_unique[d] = []; }\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\td3.values(trajectories).forEach(function(d){\r\n\t\t\t\td.forEach(function(_d){ \r\n\t\t\t\t\tif(!trajectories_unique[_d.PlaceID]){ trajectories_unique[_d.PlaceID] = []; }\r\n\t\t\t\t\tif(!trajectories_unique[_d.PlaceID_End]){ trajectories_unique[_d.PlaceID_End] = []; }\r\n\t\t\t\t\ttrajectories_unique[_d.PlaceID].push(_d);\r\n\t\t\t\t\tif(_d.PlaceID_End){ trajectories_unique[_d.PlaceID_End].push(_d); }\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\t\t\t\r\n\t\t}\r\n\r\n\t\tfunction generate_lines(){\r\n  \t\t\r\n\t\t\tlines_target = self[self.classkey].map.selectAll('g.lines_target')\r\n\t\t\t\t.data([self]);\r\n\t\t\tlines_target.enter().append('g')\r\n\t\t\t\t.classed('lines_target',true);\r\n\t\t\tlines_target.exit().remove();\r\n\r\n\t\t\tlines_g = lines_target.selectAll('g.lines_g')\r\n\t\t\t\t.data(d3.entries(trajectories));\r\n\t\t\tlines_g.enter().append('g')\r\n\t\t\t\t.classed('lines_g',true);\r\n\t\t\tlines_g\r\n\t\t\t\t.attr('class',function(d){\r\n\t\t\t\t\treturn 'lines_g id_' +d3.keys(self.authors).indexOf(d.key);\r\n\t\t\t\t});\r\n\t\t\tlines_g.exit().remove();\r\n\r\n\t\t\tlines = lines_g.selectAll('path.line')\r\n\t\t\t\t.data(function(d){ return d.value.filter(function(_d){ return _d.PlaceID_End; }); });\r\n\t\t\tlines.enter().append('path')\r\n\t\t\t\t.classed('line',true);\r\n\t\t\tlines\r\n\t\t\t\t.attr('d',function(d){\r\n\t\t\t\t\tvar source = {},\r\n\t\t\t\t\t\t\ttarget = {};\r\n\t\t\t\t\tvar p_1 = d.PlaceID || d.PlaceID_End,\r\n\t\t\t\t\t\t\tp_2 = d.PlaceID_End || d.PlaceID;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t//isolate x and y start coordinates using projection\r\n\t\t\t\t\t\r\n\t\t\t\t\tsource = projection([\r\n\t\t\t\t\t\tself.places[p_1].Long,\r\n\t\t\t\t\t\tself.places[p_1].Lat\r\n\t\t\t\t\t]);\r\n\t\t\t\t\t// if(!self.places[p_2]){debugger;}\r\n\t\t\t\t\t//isolate x and y end coordinates using projection\r\n\t\t\t\t\ttarget = projection([\r\n\t\t\t\t\t\tself.places[p_2].Long,\r\n\t\t\t\t\t\tself.places[p_2].Lat\r\n\t\t\t\t\t]);\r\n\t\t\t\t\t\r\n\t\t\t\t\t//this is a path builder -- creates a curved line between points\r\n\t\t\t\t\t//src: http://stackoverflow.com/questions/13455510/curved-line-on-d3-force-directed-tree\r\n\t\t\t\t\tvar dx = target[0] -source[0],\r\n\t\t\t\t\t\t\tdy = target[1] -source[1],\r\n\t\t\t\t\t\t\tdr = Math.sqrt((dx +d.tier) * (dx +d.tier) + (dy +d.tier) * (dy +d.tier));\r\n\t\t\t\t\treturn 'M' + source[0] + ',' + source[1] + 'A' + dr + ',' + dr + ' 0 0,1 ' + target[0] + ',' + target[1];\r\n\t\t\t\t});\r\n\t\t\tlines.exit().remove();\r\n\t\t}\r\n\r\n\t\tfunction generate_points(){\r\n  \t\t\r\n\t\t\t//scale for radii\r\n\t\t\tvar r_scale = d3.scale.linear()\r\n\t\t\t\t.domain([0,10])\r\n\t\t\t\t.range([0,36]);\r\n\t\t\t\t\r\n\t\t\tpoints_target = self[self.classkey].map.selectAll('g.points_target')\r\n\t\t\t\t.data([self]);\r\n\t\t\tpoints_target.enter().append('g')\r\n\t\t\t\t.classed('points_target',true);\r\n\t\t\tpoints_target.exit().remove();\r\n\r\n\t\t\tpoints_g = self[self.classkey].map.selectAll('g.points_g')\r\n\t\t\t\t.data(d3.entries(intersections));\r\n\t\t\tpoints_g.enter().append('g')\r\n\t\t\t\t.classed('points_g',true);\r\n\t\t\tpoints_g\r\n\t\t\t\t.attr('transform',function(d){\r\n\t\t\t\t\tvar p  = projection([\r\n\t\t\t\t\t\t\t\tself.places[d.key].Long,\r\n\t\t\t\t\t\t\t\tself.places[d.key].Lat\r\n\t\t\t\t\t\t\t]),\r\n\t\t\t\t\t\t\tpx = p[0],\r\n\t\t\t\t\t\t\tpy = p[1];\r\n\t\t\t\t\treturn 'translate(' +px +',' +py +')';\r\n\t\t\t\t})\r\n\t\t\t\t.append('text')\r\n\t\t\t\t.attr(\"class\", \"tip\")\t\t\t\t\r\n\t\t\t\t.text(function(d){\r\n  \t\t\t\tvar tooltip = [];\r\n  \t\t\t\ttooltip.push(self.places[d.key].PlaceName);\r\n  \t\t\t\t\r\n  \t\t\t\t// Add names and citations\r\n  \t\t\t\tfor(var i=0;i< d.value.info.length;i++) {\r\n    \t\t\t\tvar info = []\r\n    \t\t\t\tinfo.push(self.authors[d.value.info[i].AuthorID]);\r\n    \t\t\t\t\r\n    \t\t\t\tif (d.value.info[i].StartDate != \"\") {\r\n      \t\t\t\tinfo.push(\" \\nFrom: \" + d.value.info[i].StartDate.toString());\r\n    \t\t\t\t}\r\n    \t\t\t\t\r\n            if(d.value.info[i].StartCitation != \"\") {\r\n              info.push(\" (\" + d.value.info[i].StartCitation.toString() + \")\")            \r\n            }    \t\t\t\t\r\n    \t\t\t\tif (d.value.info[i].EndDate != '') {\r\n      \t\t\t\tinfo.push(\"\\nUntil: \" + d.value.info[i].EndDate);\r\n    \t\t\t\t}\r\n    \t\t\t\t\r\n    \t\t\t\tif (d.value.info[i].EndDate != '') {\r\n              info.push(\" (\" + d.value.info[i].StartCitation.toString() + \")\");\r\n    \t\t\t\t}\r\n    \t\t\t\t\r\n    \t\t\t\ttooltip.push(info.join(''));\r\n  \t\t\t\t}\r\n  \t\t\t\t\r\n  \t\t\t\treturn tooltip.join(\"<br />\");\r\n\t\t\t\t});\r\n\t\t\tpoints_g\r\n\t\t\t\t.on('mousemove',function(d){\r\n\t\t\t\t\td3.select(this)\r\n\t\t\t\t\t\t.transition()\r\n\t\t\t\t\t\t.duration(self.ttime)\r\n\t\t\t\t\t\t.attr('transform',function(_d){\r\n\t\t\t\t\t\t\tvar p  = projection([\r\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\r\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\r\n\t\t\t\t\t\t\t\t\t]),\r\n\t\t\t\t\t\t\t\t\tpx = p[0],\r\n\t\t\t\t\t\t\t\t\tpy = p[1];\r\n\t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(1.5)';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t})\r\n\t\t\t\t.on('mouseout',function(d){\r\n\t\t\t\t\td3.select(this)\r\n\t\t\t\t\t\t.transition()\r\n\t\t\t\t\t\t.duration(self.ttime/2)\r\n\t\t\t\t\t\t.attr('transform',function(_d){\r\n\t\t\t\t\t\t\tvar p  = projection([\r\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\r\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\r\n\t\t\t\t\t\t\t\t\t]),\r\n\t\t\t\t\t\t\t\t\tpx = p[0],\r\n\t\t\t\t\t\t\t\t\tpy = p[1];\r\n\t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(1)';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t})\r\n\t\t\t\t.on('click',function(d){\r\n\t\t\t\t\td3.event.stopPropagation();\r\n\t\t\t\t\tunfocus();\r\n\t\t\t\t\tif(d.key !== focus.key){\r\n\t\t\t\t\t\tfocus = d;\r\n\t\t\t\t\t\td3.select(this).classed('focus_point',true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t// Tooltip code.\r\n\t\t\t\t\t// Leverages CSS3 Animations instead of D3.\r\n\t\t\t\t\t// Fade out and removal of tooltips needs a new methodlogy. \r\n\t\t\t\t\t\r\n\t\t\t\t\tvar g = d3.select(this);\r\n\t\t\t\t\tvar t = d3.select(this).select('text').text();\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Get bounding rectangle size for general positioning.\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar rect = this.getBoundingClientRect();\r\n\t\t\t\t\tvar top = rect.top + window.pageYOffset + 20;\r\n\t\t\t\t\tvar left = rect.left + window.pageXOffset + 20;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Remove existing tooltips\r\n\t\t\t\t\t\r\n\t\t\t\t  d3.select('.tooltip').remove();\r\n\t\t\t\t  \r\n\t\t\t\t  // Add an absolutely positioned tooltip to the viz frame\r\n\r\n\t\t\t\t\td3.select(ui.dom.trajectories.elem)\r\n\t\t\t\t\t  .append('div')\r\n\t\t\t\t\t  .attr('class','tooltip')\r\n            .style({\r\n  \t\t\t\t\t  'top': top + \"px\",\r\n  \t\t\t\t\t  'left': left + \"px\",\r\n  \t\t\t\t\t  'bottom' : 'auto',\r\n  \t\t\t\t\t  'right' : 'auto'\r\n\t\t\t\t\t  })\r\n\t\t\t\t\t  .html(t)\r\n\t\t\t\t\t  .on('click',function() {\r\n  \t\t\t\t\t  // Click event behaviour for tooltip itself.\r\n  \t\t\t\t\t    \r\n  \t\t\t\t\t  // Animation is controlled through CSS.\r\n  \t\t\t\t\t  // Not working as expected.\r\n  \t\t\t\t\t  // Prefered behaviour: on click, the tooltip reverses the CSS animation and fades. Once the animation is complete\r\n  \t\t\t\t\t  // the tooltip is removed from the DOM.\r\n  \t\t\t\t\t  // Trickier than it sounds: d3 doesn’t offer an effective way of running a callback when animations are complete,\r\n  \t\t\t\t\t  // and this CSS based implementation is not working as expected.\r\n  \t\t\t\t\t  // Left here for future consideration.\r\n  \t\t\t\t\t  \r\n  \t\t\t\t\t  d3.select(this)\r\n  \t\t\t\t      .style({\r\n    \t\t\t\t      'animation-direction':'reverse',\r\n    \t\t\t\t      'animaiton-play-state': 'running',\r\n    \t\t\t\t      'animation-fill-mode': 'backwards'\r\n    \t\t\t\t      })\r\n    \t\t\t\t    .transition()\r\n    \t\t\t\t    .delay(800)\r\n  \t\t\t\t      .remove();\r\n  \t\t\t\t  });\r\n  \t\t\t\t  \r\n\t\t\t\t\tdisplay_results();\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\tpoints_g.exit().remove();\r\n\r\n\t\t\t//circlebacks (most certain size)\r\n\t\t\tpoints_backs = points_g.selectAll('circle.point_back')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\r\n\t\t\tpoints_backs.enter().append('circle')\r\n\t\t\t\t.classed('point_back',true);\r\n\t\t\tpoints_backs\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){\r\n\t\t\t\t\treturn r_scale(1);\r\n\t\t\t\t});\r\n\t\t\tpoints_backs.exit().remove();\r\n\r\n\t\t\t//least certain\r\n\t\t\tpoints_01 = points_g.selectAll('circle.point_01')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\r\n\t\t\tpoints_01.enter().append('circle')\r\n\t\t\t\t.classed('point_01',true);\r\n\t\t\tpoints_01\r\n\t\t\t\t.classed('point',true)\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){\r\n\t\t\t\t\treturn r_scale(1);\r\n\t\t\t\t});\r\n\t\t\tpoints_01.exit().remove();\r\n\t\t\t\t\r\n\t\t\t//certain\r\n\t\t\tpoints_02 = points_g.selectAll('circle.point_02')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._02]; });\r\n\t\t\tpoints_02.enter().append('circle')\r\n\t\t\t\t.classed('point_02',true);\r\n\t\t\tpoints_02\r\n\t\t\t\t.classed('point',true)\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){ \r\n\t\t\t\t\treturn r_scale(1);\r\n\t\t\t\t});\r\n\t\t\tpoints_02.exit().remove();\r\n\t\t\t\t\r\n\t\t\t//most certain\r\n\t\t\tpoints_03 = points_g.selectAll('circle.point_03')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._03]; });\r\n\t\t\tpoints_03.enter().append('circle')\r\n\t\t\t\t.classed('point_03',true);\r\n\t\t\tpoints_03\r\n\t\t\t\t.classed('point',true)\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){\r\n\t\t\t\t\tvar r_tot = d.length;\r\n\t\t\t\t\treturn r_scale(r_tot);\r\n\t\t\t\t});\r\n\t\t\tpoints_03.exit().remove();\r\n\t\t}\r\n\r\n\t\tfunction display_results(){\r\n\t\t\tvar o_scale = d3.scale.linear()\r\n\t\t\t\t.domain([0,3])\r\n\t\t\t\t.range([0.5,1]);\r\n\r\n\t\t\tif(focus){\r\n\t\t\t\td3.select(ui.dom.intersections.results.title).html(self.places[focus.key].PlaceName);\r\n\r\n\t\t\t\t//var data = sidebar_mode === 1 ? (intersections_unique[focus.key] || []) : (trajectories_unique[focus.key]);\r\n\t\t\t\tvar data = intersections_unique[focus.key] || [];\r\n\t\t\t\tvar items_target = d3.select(ui.dom.intersections.results.view);\r\n\t\t\t\tvar items,\r\n\t\t\t\t\t\titems_date;\r\n\r\n\t\t\t\titems = items_target.selectAll('.item')\r\n\t\t\t\t\t.data(data);\r\n\t\t\t\titems.enter().append('div')\r\n\t\t\t\t\t.classed('item',true);\r\n\t\t\t\titems\r\n\t\t\t\t\t.attr('class',function(d){\r\n\t\t\t\t\t\tvar idx = d3.keys(self.authors).indexOf(d.AuthorID);\r\n\t\t\t\t\t\treturn 'item id_' +idx;\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.style('opacity',function(d){\r\n\t\t\t\t\t\treturn o_scale(d.Likelihood);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.html(function(d){\r\n\t\t\t\t\t\treturn self.authors[d.AuthorID];\r\n\t\t\t\t\t});\r\n\t\t\t\titems.exit().remove();\r\n\r\n\t\t\t\titems_date = items.selectAll('div.item_date')\r\n\t\t\t\t\t.data(function(d){ return [d]; });\r\n\t\t\t\titems_date.enter().append('div')\r\n\t\t\t\t\t.classed('item_date',true);\r\n\t\t\t\titems_date\r\n\t\t\t\t\t.html(function(d){\r\n\t\t\t\t\t\tvar str;\r\n\t\t\t\t\t\tstr = d.StartDate && d.EndDate ? d.StartDate +'&nbsp;&ndash;&nbsp;' +d.EndDate : d.StartDate ? d.StartDate +'&nbsp;&ndash;' : d.EndDate ? '&nbsp;&ndash;' +d.EndDate : '';\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/* // Trajectory code\r\n\t\t\t\t\t\t\tvar a1 = d.PlaceID === focus.key ? 'accent' : '',\r\n\t\t\t\t\t\t\t\t\ta2 = d.PlaceID_End && d.PlaceID_End === focus.key ? 'accent' : '';\r\n\t\t\t\t\t\t\tvar p1 = '<span class=\"_' +d.Likelihood +' ' +a1 +'\">' +self.places[d.PlaceID].PlaceName +'</span>',\r\n\t\t\t\t\t\t\t\t\tp2 = '<span class=\"_' +d.Likelihood_End +' ' +a2 +'\">' +(d.PlaceID_End ? self.places[d.PlaceID_End].PlaceName : '') +'</span>';\r\n\t\t\t\t\t\t\tstr = '<div class=\"b\">' +(d.EndDate || '') +'</div><div>' +p1 +'&nbsp;&rarr;&nbsp;' +p2 +'</div>';\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\treturn str;\r\n\t\t\t\t\t});\r\n\t\t\t\titems_date.exit().remove();\r\n\r\n\t\t\t} else{\r\n\t\t\t\td3.select('#sidebar_title').html('');\r\n\t\t\t\td3.select('#sidebar_items').html('');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction update_datebar(){\r\n\t\t\tvar f = d3.time.format('%b %Y');\r\n\t\t\td3.select(ui.dom[self.classkey].datestart).html(f(self.date_start));\r\n\t\t\td3.select(ui.dom[self.classkey].dateend).html(f(self.date_end));\r\n\t\t}\r\n\r\n\t\tfunction update(){\r\n\t\t\tfilter_data();\r\n\t\t\tgenerate_lines();\r\n\t\t\tgenerate_points();\r\n\t\t\tdisplay_results();\r\n\t\t}\r\n\r\n\t\tfunction unfocus(){\r\n\t\t\tfocus = false;\r\n\t\t\td3.selectAll('.focus_point').classed('focus_point',false);\r\n\t\t}\r\n\r\n\t\tfilter_data();\r\n\t\tgenerate_lines();\r\n\t\tgenerate_points();\r\n\t\tdisplay_results();\r\n\t}\r\n  \r\n  tear_down() {\r\n  \tsuper.tear_down();\r\n    var opp = this.mode === 1 ? 2 : 1;\r\n\t\t\r\n\t\td3.select(ui.dom[this.classkey].dateslider).selectAll('*').remove();\r\n\t\t\r\n\t\td3.selectAll('.sidebar_tab.selected').classed('selected',false);\r\n\t\td3.select('.sidebar_tab#sidebar_01').classed('selected',true);\r\n\r\n\t\td3.selectAll('._0' +opp).style('display','none');\r\n\t\td3.selectAll('._0' +this.mode).style('display','block');\r\n\r\n\t\tthis.date_start = this.range[0];\r\n\t\tthis.date_end = this.range[1];\r\n\r\n\t}}\r\n\r\n/*! INTERSECTIONS CLASS */\r\n\r\nclass Intersections extends DateMapController {\r\n  constructor() {\r\n    super();\r\n    this.mode = 1; \r\n    this.classkey = 'intersections';   \r\n    this.intersections = {}\r\n    this.trajectories = {}\r\n  }\r\n  \r\n  init() {\r\n    super.init();\r\n  }\r\n  \r\n  setup() {\r\n    \r\n\t\tsuper.setup();\r\n\t\t\r\n\t\tvar self = this;\r\n\t\t\r\n\t\t// Intersections setup\r\n\t\t\r\n\t\tthis[this.classkey].map = d3.select(ui.dom[this.classkey].map.view)\r\n\t\t  .append('svg')\r\n\t\t  .attr('width','100%');\r\n        \r\n\t\tthis.svg = d3.select('#container')\r\n\t\t\t.append('svg')\r\n\t\t\t.attr('width',this.width);\r\n\r\n  }\r\n  \r\n  process_data() {\r\n    super.process_data();\r\n    \t\t\t\t\t\t    \r\n    //trajectories\r\n\t\tthis.trajectories = {};\r\n\r\n  }\r\n  \r\n\t/* !-- Intersections Generate */\r\n\r\n\tgenerate(){\r\n  \tsuper.generate();\r\n  \t\r\n\t\tvar self = this;\r\n\t\tvar focus = false;\r\n    \r\n\t\tthis[this.classkey].map.attr('height',this.height);\r\n\r\n\t\t//click handlers\r\n\t\tthis[this.classkey].map.on('click',function(){\r\n\t\t\td3.event.stopPropagation();\r\n\t\t\tunfocus();\r\n\t\t\tdisplay_results();\r\n\t\t});\r\n\t\t\r\n\t\t//slider\r\n\r\n\t\tvar sliderwidth = ui.dom[this.classkey].dateslider.offsetWidth;\r\n\t\t\r\n\t\tvar scale = d3.time.scale()\r\n\t\t\t.domain(this.range);\r\n\t\t\t\t\t\t\t\r\n\t\tvar scale_axis = d3.svg.axis()\r\n\t\t\t.orient('right')\r\n\t\t\t.ticks(10)\r\n\t\t\t.tickSize(sliderwidth - 2) //takes into account a 2px border\r\n\t\t\t.tickPadding(12);\r\n\t\t\t\r\n\t\tvar slide = d3.slider()\r\n\t\t\t.scale(scale)\r\n\t\t\t.axis(scale_axis)\r\n\t\t\t.value([\r\n\t\t\t\tscale_value_converter(this.range[1]),\r\n\t\t\t\tscale_value_converter(this.range[0])\r\n\t\t\t])\r\n\t\t\t.orientation('vertical')\r\n\t\t\t.margin(0)\r\n\t\t\t.animate(false)\r\n\t\t\t.on('slide',function(evt,value){\r\n\t\t\t\tvar v_1 = value[1] instanceof Date ? value[1] : new Date(value[1]),\r\n\t\t\t\t\t\tv_2 = value[0] instanceof Date ? value[0] : new Date(value[0]);\r\n\t\t\t\t\r\n\t\t\t\tself.date_start = scale_value_converter(v_1);\r\n\t\t\t\tself.date_end = scale_value_converter(v_2);\r\n\r\n\t\t\t\t// unfocus();\r\n\t\t\t\tupdate_datebar();\r\n\t\t\t\tupdate();\r\n\t\t\t})\r\n\t\t\t.on('slideend',function(evt,value){\r\n\t\t\t\tupdate();\r\n\t\t\t});\r\n\t\t\t\r\n\r\n\t\t//the slider library, though lightweight, is flawed\r\n\t\t//use this to convert the date values properly\r\n\t\tfunction scale_value_converter(_val){\r\n\t\t\tvar s = d3.time.scale()\r\n\t\t\t\t.domain(scale.domain())\r\n\t\t\t\t.range([0,self.height])\r\n\t\t\t\t.nice(d3.time.month);\r\n\t\t\treturn s.invert(self.height -s(_val));\r\n\t\t}    \r\n\r\n\t\tvar slider = d3.select(ui.dom[this.classkey].dateslider).call(slide);\r\n\t\t\r\n\t\td3.select(ui.dom[this.classkey].dateslider).selectAll('text').attr(\"transform\", \"translate(-\" + sliderwidth + \",20)\").text(function(d){\r\n  \t\treturn d3.select(this).text() + \"s\";\r\n\t\t});\r\n\t\t\r\n\t\tupdate_datebar();\r\n\t\t\t\t\r\n\t\t//map\r\n\t\t\r\n\t\tvar projection = d3.geo.mercator()\r\n\t\t\t.scale(160)\r\n\t\t\t.translate([ui.dom[this.classkey].map.view.offsetWidth * 0.5,ui.dom[this.classkey].map.view.offsetHeight * 0.5]);\r\n\t\t\t\r\n\t\tvar path = d3.geo.path().projection(projection);\r\n\r\n\t\tvar features = topojson.feature(self.continents,self.continents.objects.continents);\r\n\t\tvar intersections,\r\n\t\t\t\tintersections_unique;\r\n\t\tvar points_target,\r\n\t\t\t\tpoints_g,\r\n\t\t\t\tpoints_backs,\r\n\t\t\t\tpoints_03,\r\n\t\t\t\tpoints_02,\r\n\t\t\t\tpoints_01;\r\n\r\n\t\t//draw vector map\r\n\t\tvar map;\r\n\t\tmap = self[self.classkey].map.selectAll('path.map')\r\n\t\t\t.data([features]);\r\n\t\tmap.enter().append ('path')\r\n\t\t\t.classed('map',true);\r\n\t\tmap\r\n\t\t\t.attr('d',path);\r\n\t\tmap.exit().remove();\r\n\r\n\t\tfunction filter_data(){\r\n\r\n\t\t\t//clear objects\r\n\t\t\tintersections = {};\r\n\t\t\tintersections_unique = {};\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t//INTERSECTIONS\r\n\t\t\t//filter by date range\r\n\t\t\tvar holder = d3.entries(self.intersections).filter(function(d){\r\n\t\t\t\tvar n = new Date(d.key);\r\n\t\t\t\treturn n >=self.date_start && n <=self.date_end;\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t//get distinct places\r\n\t\t\t//slot author IDs into place\r\n\t\t\t//highest likelihood score wins\r\n\t\t\tholder.forEach(function(d){\r\n\t\t\t\tif(d3.keys(d.value).length >0){\r\n\t\t\t\t\td3.keys(d.value).forEach(function(_d){\r\n\t\t\t\t\t\tif(!intersections[_d]){ \r\n\t\t\t\t\t\t\tintersections[_d] = {}; \r\n\t\t\t\t\t\t\tintersections[_d].figures = {}; \r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\td.value[_d].forEach(function(__d){\r\n\t\t\t\t\t\t\tif(!intersections[_d].figures[__d.AuthorID] || intersections[_d].figures[__d.AuthorID] >__d.Likelihood){\r\n\t\t\t\t\t\t\t\tintersections[_d].figures[__d.AuthorID] = __d.Likelihood;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t//tally up totals\r\n\t\t\t\r\n\t\t\t// Assigns intersections lists dynamically\r\n\t\t\t\r\n\t\t\td3.keys(intersections).forEach(function(d){\r\n\t\t\t\tintersections[d].lists = {};\r\n\t\t\t  for(var i=1;i <= Object.keys(self.authors).length; i++) {\r\n  \t\t\t\tvar key = \"_0\" + i.toString();\r\n  \t\t\t\tintersections[d].lists[key] = d3.values(intersections[d].figures).filter(function(_d){ return _d === i; });\r\n        }\r\n\t\t\t});\r\n\t\t\t\t\t\t\r\n\t\t\t//make list of unique intersections per place\r\n\t\t\tholder.forEach(function(d){\r\n\t\t\t\td3.keys(d.value).forEach(function(_d){\r\n\t\t\t\t\tif(!intersections_unique[_d]){ intersections_unique[_d] = []; }\r\n\t\t\t\t\td.value[_d].forEach(function(__d){\r\n\t\t\t\t\t\tif(intersections_unique[_d].filter(function(t){ return t.AuthorID === __d.AuthorID && t.EndDate === __d.EndDate; }).length === 0){\r\n\t\t\t\t\t\t\tintersections_unique[_d].push(__d);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t// vet places with only one figure\r\n\t\t\t\r\n\t\t\tvar vetted = [];\r\n\t\t\t\r\n\t\t\tfor(var city in intersections) {\r\n  \t\t\tif(Object.keys(intersections[city].figures).length < 2) {\r\n    \t\t\tvetted.push(city);\r\n          delete intersections[city];\r\n  \t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor(var iucity in intersections_unique) {\r\n  \t\t\tif(vetted.indexOf(iucity) > -1) {\r\n    \t\t\tdelete intersections_unique[iucity];\r\n  \t\t\t}\r\n  \t\t}\r\n\r\n\t\t}\r\n\r\n\t\tfunction generate_points(){\r\n  \t\t\r\n\t\t\t//scale for radii\r\n\t\t\tvar r_scale = d3.scale.linear()\r\n\t\t\t\t.domain([0,10])\r\n\t\t\t\t.range([0,36]);\r\n\t\t\t\t\r\n\t\t\tpoints_target = self.intersections.map.selectAll('g.points_target')\r\n\t\t\t\t.data([self]);\r\n\t\t\tpoints_target.enter().append('g')\r\n\t\t\t\t.classed('points_target',true);\r\n\t\t\tpoints_target.exit().remove();\r\n\r\n\t\t\tpoints_g = self.intersections.map.selectAll('g.points_g')\r\n\t\t\t\t.data(d3.entries(intersections));\r\n\t\t\tpoints_g.enter().append('g')\r\n\t\t\t\t.classed('points_g',true);\r\n\t\t\tpoints_g\r\n\t\t\t\t.attr('transform',function(d){\r\n  \t\t\t\t\r\n\t\t\t\t\tvar p  = projection([\r\n\t\t\t\t\t\t\t\tself.places[d.key].Long,\r\n\t\t\t\t\t\t\t\tself.places[d.key].Lat\r\n\t\t\t\t\t\t\t]),\r\n\t\t\t\t\t\t\tpx = p[0],\r\n\t\t\t\t\t\t\tpy = p[1];\r\n\t\t\t\t\treturn 'translate(' +px +',' +py +')';\r\n\t\t\t\t})\r\n\t\t\t\t.append('title')\r\n\t\t\t\t.text(function(d){\r\n  \t\t\t\treturn self.places[d.key].PlaceName;\r\n\t\t\t\t});\r\n\t\t\tpoints_g\r\n\t\t\t\t.on('click',function(d){\r\n\t\t\t\t\td3.event.stopPropagation();\r\n\t\t\t\t\t\r\n  \t\t\t\tvar point = d3.select(this);\r\n  \t\t\t\t  \t\t\t\t\r\n  \t\t\t\t// Scale point\r\n  \t\t\t\t\r\n  \t\t\t\tvar scale = 1.5;\r\n  \t\t\t\t\r\n  \t\t\t\t// reset all points\r\n  \t\t\t\tpoints_g.forEach(function(d){\r\n    \t\t\t\td3.select(this)\r\n    \t\t\t\t  .classed('selected',false)\r\n  \t\t\t\t\t\t.transition()\r\n  \t\t\t\t\t\t.duration(self.ttime)\r\n  \t\t\t\t\t\t.attr('transform',function(_d){\r\n  \t\t\t\t\t\t\tvar p  = projection([\r\n  \t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\r\n  \t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\r\n  \t\t\t\t\t\t\t\t\t]),\r\n  \t\t\t\t\t\t\t\t\tpx = p[0],\r\n  \t\t\t\t\t\t\t\t\tpy = p[1];\r\n  \t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(1)';\r\n  \t\t\t\t\t\t});\r\n  \t\t\t\t});\r\n  \t\t\t\t  \t\t\t\t\r\n\t\t\t\t\tpoint\r\n\t\t\t\t\t  .classed('selected',true)\r\n\t\t\t\t\t\t.transition()\r\n\t\t\t\t\t\t.duration(self.ttime)\r\n\t\t\t\t\t\t.attr('transform',function(_d){\r\n\t\t\t\t\t\t\tvar p  = projection([\r\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\r\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\r\n\t\t\t\t\t\t\t\t\t]),\r\n\t\t\t\t\t\t\t\t\tpx = p[0],\r\n\t\t\t\t\t\t\t\t\tpy = p[1];\r\n\t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(' + scale + ')';\r\n\t\t\t\t\t\t});\r\n  \t\t\t\t\r\n  \t\t\t\t// display results\r\n  \t\t\t\t\r\n\t\t\t\t\tunfocus();\r\n\t\t\t\t\tif(d.key !== focus.key){\r\n\t\t\t\t\t\tfocus = d;\r\n\t\t\t\t\t\td3.select(this).classed('focus_point',true);\r\n\t\t\t\t\t}\r\n  \t\t\t\t\tdisplay_results();\r\n\t\t\t\t});\r\n\t\t\tpoints_g.exit().remove();\r\n\r\n\t\t\t//circlebacks (most certain size)\r\n\t\t\tpoints_backs = points_g.selectAll('circle.point_back')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\r\n\t\t\tpoints_backs.enter().append('circle')\r\n\t\t\t\t.classed('point_back',true);\r\n\t\t\tpoints_backs\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){\r\n\t\t\t\t\tvar r_tot = d.length +this.parentNode.__data__.value.lists._02.length +this.parentNode.__data__.value.lists._03.length;\r\n\t\t\t\t\treturn r_scale(r_tot);\r\n\t\t\t\t});\r\n\t\t\tpoints_backs.exit().remove();\r\n\r\n\t\t\t//least certain\r\n\t\t\tpoints_01 = points_g.selectAll('circle.point_01')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\r\n\t\t\tpoints_01.enter().append('circle')\r\n\t\t\t\t.classed('point_01',true);\r\n\t\t\tpoints_01\r\n\t\t\t\t.classed('point',true)\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){\r\n\t\t\t\t\tvar r_tot = d.length +this.parentNode.__data__.value.lists._02.length +this.parentNode.__data__.value.lists._03.length;\r\n\t\t\t\t\treturn r_scale(r_tot);\r\n\t\t\t\t});\r\n\t\t\tpoints_01.exit().remove();\r\n\t\t\t\t\r\n\t\t\t//certain\r\n\t\t\tpoints_02 = points_g.selectAll('circle.point_02')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._02]; });\r\n\t\t\tpoints_02.enter().append('circle')\r\n\t\t\t\t.classed('point_02',true);\r\n\t\t\tpoints_02\r\n\t\t\t\t.classed('point',true)\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){ \r\n\t\t\t\t\tvar r_tot = d.length +this.parentNode.__data__.value.lists._03.length;\r\n\t\t\t\t\treturn r_scale(r_tot);\r\n\t\t\t\t});\r\n\t\t\tpoints_02.exit().remove();\r\n\t\t\t\t\r\n\t\t\t//most certain\r\n\t\t\tpoints_03 = points_g.selectAll('circle.point_03')\r\n\t\t\t\t.data(function(d){ return [d.value.lists._03]; });\r\n\t\t\tpoints_03.enter().append('circle')\r\n\t\t\t\t.classed('point_03',true);\r\n\t\t\tpoints_03\r\n\t\t\t\t.classed('point',true)\r\n\t\t\t\t.attr('cx',0)\r\n\t\t\t\t.attr('cy',0)\r\n\t\t\t\t.attr('r',function(d){\r\n\t\t\t\t\tvar r_tot = d.length;\r\n\t\t\t\t\treturn r_scale(r_tot);\r\n\t\t\t\t});\r\n\t\t\tpoints_03.exit().remove();\r\n\t\t}\r\n\r\n\t\tfunction display_results(){\r\n\t\t\tvar o_scale = d3.scale.linear()\r\n\t\t\t\t.domain([0,3])\r\n\t\t\t\t.range([0.5,1]);\r\n\r\n\t\t\tif(focus){\r\n\t\t\t\td3.select(ui.dom[self.classkey].results.title).html(self.places[focus.key].PlaceName);\r\n\r\n\t\t\t\t//var data = sidebar_mode === 1 ? (intersections_unique[focus.key] || []) : (trajectories_unique[focus.key]);\r\n\t\t\t\tvar data = intersections_unique[focus.key] || [];\r\n\t\t\t\tvar items_target = d3.select(ui.dom[self.classkey].results.view);\r\n\t\t\t\tvar items,\r\n\t\t\t\t\t\titems_date;\r\n\r\n\t\t\t\titems = items_target.selectAll('.item')\r\n\t\t\t\t\t.data(data);\r\n\t\t\t\titems.enter().append('div')\r\n\t\t\t\t\t.classed('item',true);\r\n\t\t\t\titems\r\n\t\t\t\t\t.attr('class',function(d){\r\n\t\t\t\t\t\tvar idx = d3.keys(self.authors).indexOf(d.AuthorID);\r\n\t\t\t\t\t\treturn 'item id_' +idx;\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.style('opacity',function(d){\r\n\t\t\t\t\t\treturn o_scale(d.Likelihood);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.html(function(d){\r\n\t\t\t\t\t\treturn self.authors[d.AuthorID];\r\n\t\t\t\t\t});\r\n\t\t\t\titems.exit().remove();\r\n\r\n\t\t\t\titems_date = items.selectAll('div.item_date')\r\n\t\t\t\t\t.data(function(d){ return [d]; });\r\n\t\t\t\titems_date.enter().append('div')\r\n\t\t\t\t\t.classed('item_date',true);\r\n\t\t\t\titems_date\r\n\t\t\t\t\t.html(function(d){\r\n\t\t\t\t\t\tvar str;\r\n\t\t\t\t\t\tstr = d.StartDate && d.EndDate ? d.StartDate +'&nbsp;&ndash;&nbsp;' +d.EndDate : d.StartDate ? d.StartDate +'&nbsp;&ndash;' : d.EndDate ? '&nbsp;&ndash;' +d.EndDate : '';\r\n\t\t\t\t\t\treturn str;\r\n\t\t\t\t\t});\r\n\t\t\t\titems_date.exit().remove();\r\n\t\t\t} else{\r\n\t\t\t\td3.select('#sidebar_title').html('');\r\n\t\t\t\td3.select('#sidebar_items').html('');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction update_datebar(){\r\n\t\t\tvar f = d3.time.format('%b %Y');\r\n\t\t\td3.select(ui.dom[self.classkey].datestart).html(f(self.date_start));\r\n\t\t\td3.select(ui.dom[self.classkey].dateend).html(f(self.date_end));\r\n\t\t}\r\n\r\n\t\tfunction update(){\r\n\t\t\tfilter_data();\r\n\t\t\tgenerate_points();\r\n\t\t\tdisplay_results();\r\n\t\t}\r\n\r\n\t\tfunction unfocus(){\r\n\t\t\tfocus = false;\r\n\t\t\td3.selectAll('.focus_point').classed('focus_point',false);\r\n\t\t}\r\n\r\n\t\tfilter_data();\r\n\t\tgenerate_points();\r\n\t\tdisplay_results();\r\n\t}\r\n\t\r\n  tear_down() {\r\n  \tsuper.tear_down();\r\n    var opp = this.mode === 1 ? 2 : 1;\r\n\t\t\r\n\t\tthis.intersections.map.selectAll(\"*\").remove();\r\n\t\td3.select(ui.dom[this.classkey].dateslider).selectAll('*').remove();\r\n\t\t\r\n\t\td3.selectAll('.sidebar_tab.selected').classed('selected',false);\r\n\t\td3.select('.sidebar_tab#sidebar_01').classed('selected',true);\r\n\r\n\t\td3.selectAll('._0' +opp).style('display','none');\r\n\t\td3.selectAll('._0' +this.mode).style('display','block');\r\n\r\n\t\tthis.date_start = this.range[0];\r\n\t\tthis.date_end = this.range[1];\r\n\r\n\t}  \r\n}\r\n\r\n/* !ITINERARIES CLASS */\r\n\r\nclass Itineraries extends Visualization {\r\n  constructor() {\r\n    super();\r\n    this.classkey = 'itineraries';   \r\n    this.selectedauthors = [null,null];\r\n    this.routes = [];\r\n    this.visHeight = this.height * 4;\r\n    this.selectionsw = d3.select(ui.dom.itineraries.authors.selections).node().getBoundingClientRect().width;\r\n    console.log('init height: ' + this.visHeight)\r\n  }\r\n  \r\n  init() {\r\n    super.init();\r\n  }\r\n  \r\n  focus() {\r\n    d3.select('body').style('position','inherit');\r\n    d3.select('body').style('bottom','auto');\r\n  }\r\n  \r\n  setup() {\r\n    var self = this;\r\n    \r\n    // Set up author selection UI\r\n    \r\n    d3.select(ui.dom[this.classkey].authors.list)\r\n      .html(ui.generateAuthorList(this));\r\n\t\t\t\t\r\n    d3.select(ui.dom[this.classkey].authors.list)\r\n      .selectAll('.author').each(function(){\r\n        d3.select(this).on('click',function(){\r\n          var elem = d3.select(this);  \r\n          var akey = elem.attr('data-key');\r\n          var max = d3.select(ui.dom[self.classkey].authors.list).selectAll('a.selected')[0].length == self.selectedauthors.length;\r\n                              \r\n          if(elem.classed('selected')) {\r\n            elem.classed('selected',false);\r\n            self.selectedauthors[self.selectedauthors.indexOf(akey)] = null;\r\n          } else {\r\n            if (!max) {\r\n              elem.classed('selected',true);\r\n              self.selectedauthors[self.selectedauthors.indexOf(null)] = akey;\r\n            } \r\n          }\r\n          \r\n          self.generate();  \r\n        });\r\n      });\r\n  }\r\n  \r\n  /* !--Itineraries Generate */\r\n  \r\n  generate() {\r\n    super.generate();\r\n    \r\n    var self = this;\r\n    \r\n    this.tear_down();\r\n    \r\n    // Checks to see if at least one author is selected\r\n    \r\n    if (d3.select(ui.dom[self.classkey].authors.list).selectAll('a.selected')[0].length == 0) {\r\n      return;\r\n    }\r\n    \r\n    var merge = [];\r\n        \r\n    for(var i=0; i<this.selectedauthors.length; i++) {\r\n      var slot = i;\r\n      var akey = this.selectedauthors[i];\r\n      var header = ui.dom[this.classkey].selections[i].header;\r\n      var view = ui.dom[this.classkey].selections[i].view;\r\n      \r\n      if (akey != null) {\r\n        d3.select(header).html(this.authors[akey]);\r\n        this.routes[i] = this.itineraries[akey];\r\n        merge = merge.concat(this.itineraries[akey]);\r\n        d3.select(ui.dom[this.classkey].selections[i].view).append('svg')        \r\n      } else {\r\n        d3.select(header).html(\"Select an author\");\r\n        this.routes[i] = null;\r\n      }\r\n    }\r\n                        \r\n    // Find the earliest and latest itinerary dates\r\n    var starts = [], ends = [];\r\n    d3.keys(self.itineraries).forEach(\r\n      function(d){\r\n        starts.push(d3.min(self.itineraries[d], function(_d){ return new Date(_d.StartDate); }));\r\n        ends.push(d3.max(self.itineraries[d], function(_d){ return new Date(_d.EndDate); }));\r\n    });\r\n      \r\n    var earliest_date = d3.min(starts);\r\n    var latest_date = d3.max(ends);\r\n    \r\n    console.log(\"Generate height: \" + this.visHeight)\r\n            \r\n    // Set up containers\r\n        \r\n    var cheight = this.visHeight \r\n                    + 16 \r\n                    + d3.select(ui.dom[this.classkey].authors.header).node().getBoundingClientRect().height \r\n                    + d3.select(ui.dom[this.classkey].selections[0].header).node().getBoundingClientRect().height ;\r\n                    \r\n    console.log(\"Container Height: \" + cheight);\r\n    \r\n    d3.select(ui.dom[this.classkey].authors.selections).style('height',cheight + 'px');\r\n    d3.select(ui.dom[this.classkey].elem).style('height',cheight + 'px');\r\n    d3.select(ui.dom[this.classkey].authors.list).style('height',cheight + 'px');\r\n\r\n    //Translate days to distance\r\n    \r\n    var route_scale = d3.time.scale().domain([earliest_date, latest_date]).range([0, this.visHeight]);\r\n    \r\n    // Create Axis\r\n        \r\n    var axisScale = d3.time.scale().domain([earliest_date, latest_date]).range([0,this.visHeight]);\r\n    var yAxis = d3.svg.axis()\r\n                  .scale(axisScale)\r\n                  .orient('left')\r\n                  .tickSize(this.selectionsw * .95, 0)\r\n                  .tickPadding(-25)\r\n                  .tickFormat(d3.time.format(\"%Y\"));\r\n    \r\n    \r\n    for(var j=0; j<this.selectedauthors.length; j++) {\r\n      this.generate_route(j,route_scale,yAxis);\r\n    } \r\n        \r\n  }\r\n  \r\n  generate_route(index,route_scale,yAxis) {\r\n    var self = this;\r\n    var author_id = this.selectedauthors[index];\r\n    var route = this.routes[index];\r\n    var view = ui.dom[this.classkey].selections[index].view;\r\n            \r\n    if (route == null) {\r\n      return;\r\n    }\r\n    \r\n    var svg = d3.select(view).select('svg');\r\n    \r\n    svg.attr('height', this.visHeight);\r\n    d3.select(view).style('height',this.visHeight);\r\n    \r\n    // add axis to first visualization\r\n    var w = this.selectionsw *.95 * .8 -10;\r\n\r\n    if (index==0) {\r\n      svg.append('g')\r\n        .attr('id','itinerary-axis')\r\n        .call(yAxis)\r\n        .call(function(l){\r\n          l.style('transform','translateX(' + w + 'px)'); // moves lines into position\r\n          l.selectAll('text').attr('y',15); // moves labels below lines\r\n        });\r\n\r\n    }\r\n        \r\n    //Create route container\r\n    var route_g = svg.selectAll('g.route_g').data([author_id]);\r\n    \r\n    route_g.enter().append('g').classed('route_g',true);\r\n\r\n    route_g\r\n        .attr('class', 'route_g author_' + index)\r\n        .attr('transform', function(d,i){\r\n            var x = 0,\r\n                y = 0;\r\n            return 'translate(' + x +',' + y +')';\r\n        });\r\n        \r\n    route_g.exit().remove();\r\n    \r\n    //Stops\r\n    var route_rad = 4;\r\n    var route_stops = route_g.selectAll('circle.route_stops').data(route);\r\n    route_stops.enter().append('circle').classed('route_stops',true);\r\n    route_stops\r\n        .attr('cx',30)\r\n        .attr('cy',function(d,i){\r\n            return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\r\n        })\r\n        .attr('r',route_rad)\r\n        .append(\"text\")\r\n          .attr('class','tip')\r\n          .text(function(d) {\r\n    \t\t\t\tvar tooltip = [];\r\n    \t\t\t\t\r\n    \t\t\t\tif(typeof self.places[d.PlaceID] == 'undefined') {\r\n      \t\t\t\treturn;\r\n    \t\t\t\t}\r\n    \t\t\t\ttooltip.push(self.places[d.PlaceID].PlaceName);\r\n    \t\t\t\t// Add names and citations\r\n    \t\t\t\tvar info = []\r\n    \t\t\t\t\r\n    \t\t\t\tif (d.StartDate != \"\") {\r\n      \t\t\t\tinfo.push(\" \\nFrom: \" + d.StartDate.toString());\r\n    \t\t\t\t}\r\n    \t\t\t\t\r\n            if(d.StartCitation != \"\") {\r\n              info.push(\" (\" + d.StartCitation.toString() + \")\")            \r\n            }    \t\t\t\t\r\n    \t\t\t\tif (d.EndDate != '') {\r\n      \t\t\t\tinfo.push(\"\\nUntil: \" + d.EndDate);\r\n    \t\t\t\t}\r\n    \t\t\t\t\r\n    \t\t\t\tif (d.EndDate != '') {\r\n              info.push(\" (\" + d.StartCitation.toString() + \")\");\r\n    \t\t\t\t}\r\n    \t\t\t\t\r\n    \t\t\t\ttooltip.push(info.join(''));\r\n      \t\t  \r\n      \t\t  return tooltip.join(\"<br />\");\r\n          });\r\n        route_stops\r\n          .on('click',function() {\r\n                        \r\n  \t\t\t\t\t// Tooltip code.\r\n  \t\t\t\t\t// Leverages CSS3 Animations instead of D3.\r\n  \t\t\t\t\t// Fade out and removal of tooltips needs a new methodlogy. \r\n  \t\t\t\t\t\r\n  \t\t\t\t\tvar g = d3.select(this);\r\n  \t\t\t\t\tvar t = d3.select(this).select('text').text();\r\n  \t\t\t\t\t\r\n  \t\t\t\t\tvar rect = this.getBoundingClientRect();\r\n  \t\t\t\t\tvar top = rect.top + window.pageYOffset - 10;\r\n  \t\t\t\t\tvar left = rect.left + window.pageXOffset + 50;\r\n  \t\t\t\t\t\r\n  \t\t\t\t  d3.select('.tooltip').remove();\r\n  \r\n\t\t\t\t\td3.select(ui.dom.itineraries.elem)\r\n\t\t\t\t\t  .append('div')\r\n\t\t\t\t\t  .attr('class','tooltip')\r\n            .style({\r\n  \t\t\t\t\t  'top': top + \"px\",\r\n  \t\t\t\t\t  'left': left + \"px\",\r\n  \t\t\t\t\t  'bottom' : 'auto',\r\n  \t\t\t\t\t  'right' : 'auto'\r\n\t\t\t\t\t  })\r\n\t\t\t\t\t  .html(t)\r\n\t\t\t\t\t  .on('click',function() {\r\n  \t\t\t\t\t  // Click event behaviour for tooltip itself.\r\n  \t\t\t\t\t  // See notes in “trajectories” above.\r\n  \t\t\t\t\t  \r\n  \t\t\t\t\t  d3.select(this)\r\n  \t\t\t\t      .style({\r\n    \t\t\t\t      'animation-direction':'reverse',\r\n    \t\t\t\t      'animaiton-play-state': 'running',\r\n    \t\t\t\t      'animation-fill-mode': 'backwards'\r\n    \t\t\t\t      })\r\n    \t\t\t\t    .transition()\r\n    \t\t\t\t    .delay(800)\r\n  \t\t\t\t      .remove();\r\n  \t\t\t\t  });\r\n          });\r\n          \r\n  \r\n    route_stops.exit().remove();\r\n    \r\n  }\r\n  \r\n  \r\n  \r\n  route_change(_side){\r\n      var author_name = d3.select('#'+_side+'_select').property('value');\r\n      var author_id = this.author_names[author_name];\r\n            \r\n      var curr_svg;\r\n      if(_side == 'left'){ curr_svg = this.left_svg; }\r\n      else { curr_svg = this.right_svg; }\r\n\r\n      var self = this;\r\n      var visH = this.height*30;\r\n      curr_svg.attr('height', visH);\r\n\r\n      // Find the earliest and latest itinerary dates\r\n      var starts = [], ends = [];\r\n      d3.keys(self.itineraries).forEach(\r\n          function(d){\r\n              starts.push(d3.min(self.itineraries[d], function(_d){ return new Date(_d.StartDate); }));\r\n              ends.push(d3.max(self.itineraries[d], function(_d){ return new Date(_d.EndDate); }));\r\n      });\r\n\r\n      var earliest_date = d3.min(starts);\r\n      var latest_date = d3.max(ends);\r\n\r\n      //Translate days to distance\r\n      var route_scale = d3.time.scale().domain([earliest_date, latest_date]).range([0, visH -150 -60]);\r\n\r\n      //Create route container\r\n      var route_g = curr_svg.selectAll('g.route_g').data(author_id);\r\n      route_g.enter().append('g').classed('route_g',true);\r\n      route_g\r\n          .attr('class', 'route_g author_' + _side)\r\n          .attr('transform', function(d,i){\r\n              var x = i*(self.width/2),\r\n                  y = 75;\r\n              return 'translate(' + x +',' + y +')';\r\n          });\r\n      route_g.exit().remove();\r\n      \r\n      //Add background line\r\n      var route_line_background = route_g.selectAll('line.route_line_background')\r\n          .data(self.itineraries[author_id]);\r\n      route_line_background.enter().append('line').classed('route_line_background',true);\r\n      route_line_background\r\n          .attr('x1',self.width/4)\r\n          .attr('y1',function(d,i){ return route_scale(route_scale.domain()[0]); })\r\n          .attr('x2',self.width/4)\r\n          .attr('y2',function(d,i){ return route_scale(route_scale.domain()[1]); });\r\n      route_line_background.exit().remove();\r\n\r\n      //Add figure name\r\n      var route_labels = route_g.selectAll('text.route_label').data(author_id);\r\n      route_labels.enter().append('text').classed('route_label',true);\r\n      route_labels\r\n          .attr('x',self.width/4)\r\n          .attr('y',-30)\r\n          .text(author_name);\r\n      route_labels.exit().remove();\r\n\r\n      //Lines\r\n      var route_line = route_g.selectAll('line.route_line').data(self.itineraries[author_id]);\r\n      route_line.enter().append('line').classed('route_line',true);\r\n      route_line\r\n          .attr('class', 'route_line author_' + _side)\r\n          .attr('x1',self.width/4)\r\n          .attr('y1',function(d, i){\r\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\r\n          })\r\n          .attr('x2',self.width/4)\r\n          .attr('y2',function(d, i){\r\n              return d.EndDate ? route_scale(new Date(d.EndDate)) : route_scale(new Date(d.StartDate));\r\n          });\r\n      route_line.exit().remove();\r\n\r\n      //Points\r\n      var route_points = route_g.selectAll('line.route_points').data(self.itineraries[author_id]);\r\n      route_points.enter().append('line').classed('route_points',true);\r\n      route_points\r\n          .attr('x1',self.width/4 -15)\r\n          .attr('y1',function(d,i){\r\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\r\n          })\r\n          .attr('x2',self.width/4 +45)\r\n          .attr('y2',function(d,i){\r\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\r\n          });\r\n      route_points.exit().remove();\r\n\r\n      //Stops\r\n      var route_rad = 3;\r\n      var route_stops = route_g.selectAll('circle.route_stops').data(self.itineraries[author_id]);\r\n      route_stops.enter().append('circle').classed('route_stops',true);\r\n      route_stops\r\n          .attr('cx',self.width/4 +45)\r\n          .attr('cy',function(d,i){\r\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\r\n          })\r\n          .attr('r',route_rad);\r\n      route_stops.exit().remove();\r\n\r\n      //Point labels\r\n      var route_point_labels = route_g.selectAll('text.route_point_labels').data(self.itineraries[author_id]);\r\n      route_point_labels.enter().append('text').classed('route_point_labels',true);\r\n      route_point_labels\r\n          .attr('x',self.width/4 +60)\r\n          .attr('y',function(d,i){\r\n              return (d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate))) +4;\r\n          })\r\n          .text(function(d){\r\n              var t1 = d.StartDate || 'Unknown',\r\n                  t2 = d.EndDate || 'Unknown';\r\n              return self.places[d.PlaceID].PlaceName + ' (' +t1 +' to ' +t2 +')';\r\n          });\r\n      route_point_labels.exit().remove();\r\n\r\n  }\r\n\r\n  generate_routes(){\r\n      var visH = this.height*6;\r\n      this.svg.attr('height', visH);\r\n  }  \r\n  \r\n  /* !--Itineraries Tear Down */\r\n  \r\n  tear_down() {\r\n    super.tear_down();\r\n    for(var i=0;i<this.selectedauthors.length;i++) {\r\n      d3.select(ui.dom[this.classkey].selections[i].view).selectAll('*').remove();       \r\n    } \r\n  }\r\n}\r\n\r\n/* !INITIALIZATION */\r\n\r\n/*\r\n  Note for refactoring: this should be rethought once a proper MVC structure is in place.\r\n  \r\n  Notes for the current structure:\r\n  \r\n  - The DataManager class is designed to load JSON data once (on initial load).\r\n  - It the function passed to it once the dataset is loaded completely.\r\n\r\n*/\r\n\r\nvar intersections = new Object;\r\nvar trajectories = new Object;\r\nvar itineraries = new Object;\r\n\r\nd3.select('body').style('opacity',0.3);\r\n\r\n// Intersections are initialized immediately. The second argument is a function to handle data-reliant functionality.\r\n\r\nvar dm = new DataManager(function(){\r\n    \r\n  d3.selectAll(ui.dom.tabs).each(function() {\r\n  \td3.select(this).on('click',function() {\t\r\n    \t\t\r\n  \t\t// Remove active tooltips from the DOM\r\n  \t\td3.select('.tooltip').remove();\r\n  \t\t  \t\t    \t\r\n    \tswitch(d3.select(this).attr('data-mode')) {\r\n      \tcase '0':\r\n          d3.select('body').style('position','inherit');\r\n      \t\td3.select('body').style('bottom','auto');\r\n      \tbreak;\r\n      \tcase '1':\r\n          if (!intersections.hasOwnProperty('initialized')) {\r\n            intersections = new Intersections;\r\n            intersections.init();\r\n          } else {\r\n            intersections.focus();\r\n          }\r\n          break;\r\n        case '2':      \r\n          // only initialize once. perhaps should be handled in the init() function itself.\r\n                  \r\n          if (!trajectories.hasOwnProperty('initialized')) {\r\n            trajectories = new Trajectories;\r\n            trajectories.init();\r\n          } else {\r\n            trajectories.focus();\r\n          }\r\n\r\n      \t  break;\r\n      \tcase '3':\r\n          if (!itineraries.hasOwnProperty('initialized')) {\r\n            itineraries = new Itineraries;\r\n            itineraries.init();\r\n          } else {\r\n            itineraries.focus();\r\n          }\r\n\r\n      \t  break;  \r\n      \t case '4':\r\n      \t\t// Index when Search tab is clicked.\r\n      \t\t\r\n      \t\tdm.indexData();\r\n      \t\t\r\n      \t\t// Bind Search Field\r\n          \t\t\r\n      \t\td3.select(ui.dom.searchfield).on('input',function(){\r\n        \t\tif(this.value.length>2) {\r\n          \t  d3.select(ui.dom.searchresults).html(dm.DisplaySearchResults(this.value));\r\n        \t\t}\r\n      \t\t});\r\n      \t  break;\r\n    \t}\r\n  \t});\r\n  });\r\n  \r\n  // console.log(performance.now() / 1000);\r\n  \r\n  d3.select('body').transition(200).style('opacity',1);\r\n  \r\n  \r\n});\r\n\r\n//custom sub-selections\r\nd3.selection.prototype.first = function() {\r\n  return d3.select(this[0][0]);\r\n};\r\nd3.selection.prototype.last = function() {\r\n  var last = this.size() - 1;\r\n  return d3.select(this[0][last]);\r\n};"]}