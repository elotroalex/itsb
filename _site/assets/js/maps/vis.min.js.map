{"version":3,"sources":["vis.js"],"names":["String","prototype","replaceAll","search","replacement","this","replace","RegExp","DataManager","[object Object]","loading","data","idx","compiled","authors","author_names","places","datasets","func","self","q","d3","queue","forEach","d","filepath","defer","xhr","await","error","i","arguments","length","darg","JSON","parse","responseText","invoke","call","keys","author_ids","k","buildAuthors","buildPlaces","date","itineraries","entry","place","PlaceID","placename","PlaceName","ID","Author","AuthorID","Place","StartCitation","StartDate","EndCitation","EndDate","Notes","FullEntry","lunr","id","ref","field","add","term","results","Search","html","result","push","join","Visualization","mode","continents","classkey","initialized","dm","load","init","width","window","innerWidth","height","innerHeight","ttime","getData","focus","process_data","setup","generate","intialized","select","style","_d","intersections","key","_key","tear_down","DateMapController","super","range","Date","date_start","date_end","Trajectories","trajectories","active_authors_t","ui","TrajectoriesUI","map","dom","view","append","attr","list","generateAuthorList","addListSizeClass","on","event","stopPropagation","unfocus","display_results","selectAll","each","elem","classed","index","indexOf","splice","update","sliderwidth","dateslider","offsetWidth","scale","time","domain","scale_axis","svg","axis","orient","ticks","tickSize","tickFormat","getUTCFullYear","tickPadding","slide","slider","value","scale_value_converter","orientation","margin","animate","evt","v_1","v_2","update_datebar","_val","s","nice","month","invert","intersections_unique","trajectories_unique","points_target","points_g","points_backs","points_03","points_02","points_01","lines_target","lines_g","lines","projection","geo","mercator","translate","offsetHeight","path","features","topojson","feature","objects","filter_data","holder","entries","filter","n","author","b","__d","figures","Likelihood","info","lists","Object","toString","values","t","__key","tier","j","PlaceID_End","Likelihood_End","generate_lines","enter","exit","remove","source","target","p_1","p_2","console","log","Long","Lat","dx","dy","dr","Math","sqrt","e","generate_points","r_scale","linear","p","text","tooltip","transition","duration","rect","getBoundingClientRect","top","pageYOffset","left","pageXOffset","bottom","right","animation-direction","animaiton-play-state","animation-fill-mode","delay","_01","_02","_03","r_tot","o_scale","title","items","items_date","f","format","datestart","dateend","opp","Intersections","IntersectionsUI","vetted","city","iucity","point","parentNode","__data__","dateproc","Itineraries","selectedauthors","routes","visHeight","ItinerariesUI","selectionsw","selections","node","akey","merge","header","concat","starts","ends","min","max","earliest_date","latest_date","cheight","route_scale","axisScale","yAxis","generate_route","author_id","route","w","l","route_g","route_stops","_side","curr_svg","author_name","property","left_svg","right_svg","visH","route_line_background","route_labels","route_line","route_points","route_point_labels","t1","t2","SearchUI","indexData","searchfield","searchresults","DisplaySearchResults","selection","first","last","size"],"mappings":"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","file":"../vis.min.js","sourcesContent":["/* global d3 */\n/* global topojson */\n/* global lunr */\n\n// Used in some instances for String.replace()\n\nString.prototype.replaceAll = function(search, replacement) {\n    var target = this;\n    return target.replace(new RegExp(search, 'g'), replacement);\n};\n\n\n/* !DATA MANAGER */\n\n\n// The DataManager object is designed to load JSON files once then make the data available to all visualizations.\n// Special handling is required to compensate for asynchronous load (the d3.json method does not have a\n// synchronous loading method). We could consider jQuery’s ajax method here, but the queue.js library\n// is more lightweight.\n\nclass DataManager {\n  constructor() {\n    var self = this;\n    this.loading = [];\n    this.data = {};\n    this.idx;\n    this.compiled = {};\n    \n    this.authors = {};\n    this.author_names = {};\n    this.places = {};\n    this.datasets = ['author_ids','intersections','itineraries','places','continents'];    \n  }\n  \n  // Loads the Datasets\n  // d3-queue.js manages deferred processing\n  \n  load(func) {\n\t\tvar self = this;\n\t\tvar q = d3.queue();\n\t\t\n\t\t/* \n  \t\tpartial (non-deferred) jQuery implementation \n  \t\t\n  \t\t\t\t  var i = 0;\n\t\t\n  \t\tself.datasets.forEach(function(d){\n    \t\tvar filepath = '/data/sixty_' + d +'.json.gz';\n    \t\tjQuery.ajax({\n      \t\turl: filepath,\n      \t\tsuccess: function(data) {\n        \t\tself.data[i] = JSON.parse(data);\n        \t\ti++;\n        \t\tconsole.log(self.data)\n      \t\t}\n    \t\t});\n  \t\t});\t\n\n    */\n\t\t\t\t\n\t\tthis.datasets.forEach(function(d){\n  \t\tvar filepath = '/data/' + d +'.json.gz';\n  \t\tq.defer(d3.xhr,filepath);\n\t\t});\t\n\t\t\n\t\tq.await(function(error){\n  \t\tif (error) throw error;\n  \t\t\n  \t\t// the first argument is an error object, the subsequent ones correspond to the json datasets\n  \t\tfor(var i=1;i < arguments.length; i++) {\n    \t\tvar darg = i-1;\n    \t//\tconsole.log(arguments[i].responseText);\n    \t\tself.data[self.datasets[darg]] = JSON.parse(arguments[i].responseText);\n  \t\t}\n  \t\t\n  \t\tvar invoke = func.call(invoke);\n  \t\t\n\t\t});\n  }\n  \n  buildAuthors() {\n    var self = this;\n\t\t//authors\n\t\td3.keys(self.data.author_ids).forEach(function(k){\n\t\t\tself.authors[self.data.author_ids[k]] = k;\n      self.author_names[k] = self.data.author_ids[k];\n\t\t});\n  }\n  \n  \n  buildPlaces() {\n    var self = this;\n    self.places = self.data.places;      // Place JSON no longer requires processing.\n\n    /*\n    // Places Hack: Replaces dashes with underscores to enforce consistency\n\t\td3.keys(self.data.places).forEach(function(d){\n\t\t\tvar k = d.split(',');\n\t\t\tk[0] = k[0].trim().split(' ').join('_');\n\t\t\tk[1] = k[1].trim().split(' ').join('_');\n\t\t\tk = k.join('_').toLowerCase().replaceAll('-','_');\n\t\t\tself.places[k] = self.data.places[d];\n\t\t\tself.places[k].PlaceName = d;\n\t\t});\n\t\t\n\t\t*/\n\t\t\n  }\n  \n  \n  indexData() {\n    \n    var self = this;\n    \n    this.buildAuthors();\n    this.buildPlaces();\n    var i=0;\n    \n    for(var date in this.data.itineraries) { \n      this.data.itineraries[date].forEach(function(entry){\n                \n        var place = self.places[entry.PlaceID]; \n        var placename = '';\n        \n        \n        if (typeof place != 'undefined') {\n          placename = place.PlaceName;\n        }\n        \n        self.compiled[i] = {\n          'ID' : i,\n          'Author' : self.author_names[entry.AuthorID],\n          'AuthorID' : entry.AuthorID,\n          'Place' : placename,\n          'StartCitation' :  entry.StartCitation,\n          'StartDate' :  entry.StartDate,\n          'EndCitation' :  entry.EndCitation,\n          'EndDate' : entry.EndDate,\n          'Notes' : entry.Notes,\n          'FullEntry' : entry\n        };\n        \n        i++;\n      });     \n    }\n\n    this.idx = lunr(function(){\n      var thislunr = this;\n      \n      this.ref('ID'); \n            \n      this.field('Author');\n      this.field('Place');\n      this.field('StartCitation');\n      this.field('EndCitation');\n      this.field('Notes');\n      \n      for (var id in self.compiled) {\n        thislunr.add(self.compiled[id]);\n      }\n    });    \n  }\n  \n  Search(term) {\n    return this.idx.search(term);\n  }\n  \n  DisplaySearchResults(term) {\n    var results = this.Search(term);\n    \n    if (results.length == 0) {\n      return \"<p>No search results found.</p>\";\n    }\n    \n    var html = [];\n    \n    for(var i=0;i<results.length;i++) {\n      var result = this.compiled[results[i].ref];\n      \n      var date = [];\n      \n      if (result.StartDate != '') {\n        date.push(result.StartDate);\n      }\n      \n      if (result.EndDate != '') {\n        date.push(result.EndDate);\n      }\n      \n      html.push(\n        \"<div class='search-result'>\" +\n          \"<div class='term'>\" + result.Author + \"</div>\" +\n          \"<div class='subhead'>\" + result.Place + \" (\" + date.join(' – ') + \")</div>\" +\n          (result.Notes != '' ? \"<div class='description'>\" + result.Notes + \"</div>\" : '') + \n        \"</div>\"\n      );\n    }\n    \n    return html.join(\"\\n\");\n  }\n  \n  getData() {\n    return this.data;\n  }\n}\n\n/* !VISUALIZATION CLASS */\n\nclass Visualization {\n\t\n\tconstructor(){\n  \tvar self = this;\n  \tthis.data = {};\n\t\tthis.mode = 0;\n\t\tthis.places = {};\n\t\tthis.authors = {};  // {author_id: author_name}\n    this.author_names = {}; // {author_name: author_id}\n\t\tthis.continents = {};\n\t\tthis.classkey = 'visualization';   \n\t\tthis.initialized = false;\n\t\t\n\t\tvar self = this;\n\t\t\n\t\tthis.dm = new DataManager();\n\t\tthis.dm.load(function() {\n  \t\tself.init();\n\t\t});\n\n\n\t\t//store screen height and width\n\t\tthis.width = window.innerWidth;\n\t\tthis.height = window.innerHeight;\n\t\tthis.ttime = 45;\n\t\t\t\t\n\t}\n\t\n\tinit() {\n  \tvar self = this;\n  \tthis.data = this.dm.getData();\n    this.focus();\n    this.process_data(); \n\t\tthis.setup();\n\t\tthis.generate();\n\t\tthis.intialized = true;\t\t\n\t}\n\t\n\tfocus() {\n    d3.select('body').style('position','absolute');\n\t\td3.select('body').style('bottom','0');\n\t\tthis.width = window.innerWidth;\n\t\tthis.height = window.innerHeight;\n\t}\n\n\tprocess_data(){\n\t\tvar self = this;\t\t\n\t\tself.continents = self.data.continents;\n\t\t// places\n\t\t\n\t\tself.dm.buildPlaces();\n\t\tself.places = self.dm.places;\n\t\t\n\t\t\t\t\n\t\t// authors\n\t\t// self.authors lists authors by key\n\t\t// self.author_names is inverted, listing author ids by name\n\t\t// TO DO: this.author_names is deprecated and should be removed from code\n\t\t\n\t\tself.authors = self.data.author_ids;\n\t\t\n\t\td3.keys(self.data.author_ids).forEach(function(k){\n      self.author_names[self.data.author_ids[k]] = k;\n\t\t});\n\t\t\t\t\n\t\t// itineraries\n\t\tself.itineraries = {};\n\t\td3.keys(self.authors).forEach(function(d){\n\t\t\tif(!self.itineraries[d]){ self.itineraries[d] = []; }\n\t\t});\n\t\t\n\t\td3.keys(self.data.itineraries).forEach(function(d){\n\t\t\tself.data.itineraries[d].forEach(function(_d){\n\t\t\t\tself.itineraries[_d.AuthorID].push(_d);\n\t\t\t});\n\t\t});\n\t\t    \n    // intersections\n    \n\t\tself.intersections = {};\n\t\t\n\t\t// Places Hack: Replaces dashes with underscores to enforce consistency\n    // Original code was simply:\n    // self.intersections = self.data.intersections\n\t\t\n\t\td3.keys(this.data.intersections).forEach(function(key) {\n  \t\tself.intersections[key] = {};\n  \t\td3.keys(self.data.intersections[key]).forEach(function(_key) {\n        self.intersections[key][_key.replaceAll('-','_')] = self.data.intersections[key][_key];\n      });\n    });\n\t\t\n\t}\n\n\tsetup(){\n\t\tvar self = this;\n\t}\n\n\tgenerate(){\n    this.tear_down();\n\t}\n\t\n\ttear_down(){\n\t}\n}\n\n/* !DATEMAPCONTROLLER CLASS */\n\n/* Refactoring note: This controller class should handle the map and date slider functionality. \n   Right now it does nothing except establish a common date range (which itself should be configurable).\n   \n   The structure of the current map and slider code will prove a challenge here. They currently rely on\n   localized functions, which themselves are very tied to their individual visualizations and are not\n   very portable. This will need to be rethought.\n*/\n\n\n\nclass DateMapController extends Visualization {\n  constructor() {\n    super();\n    \n\t\tthis.range = [\n\t\t\tnew Date(1890,0,1),\n\t\t\tnew Date(2010,0,1)\n\t\t];\n\t\t\n\t\tthis.date_start = this.range[0];\n\t\tthis.date_end = this.range[1];\n  }\n  \n  init() {\n    super.init();\n  }\n  \n  setup() {\n    super.setup();\n  }\n  \n  process_data() {\n    super.process_data(); \n  }\n  \n  generate() {\n    super.generate();  \n  }\n    \n  tear_down() {\n    super.tear_down();\n  }\n}\n\n/* !TRAJECTORIES CLASS */\n\nclass Trajectories extends DateMapController {\n  constructor() {\n    super();\n    this.intersections = {}\n    this.trajectories = {}\n    this.mode = 2;         \n    this.classkey = 'trajectories';\n\t\tthis.active_authors_t = [];\n\t\tthis.ui = new TrajectoriesUI();\n  }\n  \n  init() {\n    super.init();\n  }\n  \n  setup() {\n    \n\t\tsuper.setup();\n\t\t\n\t\tvar self = this;\n\n    // Trajectories setup\n    \n\t\tthis.trajectories.map = d3.select(self.ui.dom.trajectories.map.view)\n\t\t  .append('svg')\n\t\t  .attr('width','100%');\n\t\t          \n    d3.select(self.ui.dom.trajectories.authors.list)\n      .html(self.ui.generateAuthorList(this));\n            \n    self.ui.addListSizeClass(self.authors,self.ui.dom.trajectories.authors.list);\n\n  }\n  \n  process_data() {\n    super.process_data();\n    \t\t\t\t    \n    //trajectories\n\t\tthis.trajectories = {};\n    \n  }\n  \n  \n  /* !-- Trajectory Generate */\n\n  // Refactoring note: Ideally the slider and map should be generated here using common code.\n\n  generate(){\n    super.generate();\n    \n\t\tvar self = this;\n\t\tvar focus = false;\n\n\t\tthis[this.classkey].map.attr('height',this.height);\n\n\t\t//click handlers\n\t\tthis[this.classkey].map.on('click',function(){\n\t\t\td3.event.stopPropagation();\n\t\t\tunfocus();\n\t\t\tdisplay_results();\n\t\t});\n\t\t\n\t\t// Manage active trajectory map authors\n\t\t\n    d3.select(self.ui.dom[this.classkey].authors.list)\n      .selectAll('.author').each(function(){\n        d3.select(this).on('click',function(){\n          var elem = d3.select(this);          \n          if (elem.classed('selected')) { // remove item from active list\n            elem.classed('selected',false);\n            var index = self.active_authors_t.indexOf(elem.attr('data-key'));\n            if (index > -1) {\n              self.active_authors_t.splice(index,1);\n            }\n          } else {\n            elem.classed('selected',true);\n            self.active_authors_t.push(elem.attr('data-key'));\n          }\n          \n          update();\n        });\n      });\n      \n\t\t// !--Slider\n\t\t\n\t\tvar sliderwidth = self.ui.dom[this.classkey].dateslider.offsetWidth;\n\t\t\t\t\t\t\n\t\tvar scale = d3.time.scale()\n\t\t\t.domain(this.range);\n\t\t\t\t\t\t\t\n\t\tvar scale_axis = d3.svg.axis()\n\t\t\t.orient('right')\n\t\t\t.ticks(10)\n\t\t\t.tickSize(sliderwidth - 2) //takes into account a 2px border\n\t\t\t.tickFormat(function(date){\n  \t\t\tvar dateObj = new Date(date);\n  \t\t\treturn dateObj.getUTCFullYear(); // Corrects issue introduced in Chrome 68\n\t\t\t})\n\t\t\t.tickPadding(12);\n\t\t\t\n\t\tvar slide = d3.slider()\n\t\t\t.scale(scale)\n\t\t\t.axis(scale_axis)\n\t\t\t.value([\n\t\t\t\tscale_value_converter(this.range[1]),\n\t\t\t\tscale_value_converter(this.range[0])\n\t\t\t])\n\t\t\t.orientation('vertical')\n\t\t\t.margin(0)\n\t\t\t.animate(false)\n\t\t\t.on('slide',function(evt,value){\n\t\t\t\tvar v_1 = value[1] instanceof Date ? value[1] : new Date(value[1]),\n\t\t\t\t\t\tv_2 = value[0] instanceof Date ? value[0] : new Date(value[0]);\n\t\t\t\t\n\t\t\t\tself.date_start = scale_value_converter(v_1);\n\t\t\t\tself.date_end = scale_value_converter(v_2);\n\n\t\t\t\t// unfocus();\n\t\t\t\tupdate_datebar();\n\t\t\t\tupdate();\n\t\t\t})\n\t\t\t.on('slideend',function(evt,value){\n\t\t\t\tupdate();\n\t\t\t});\n\t\t\t\n\n\t\t//the slider library, though lightweight, is flawed\n\t\t//use this to convert the date values properly\n\t\tfunction scale_value_converter(_val){\n\t\t\tvar s = d3.time.scale()\n\t\t\t\t.domain(scale.domain())\n\t\t\t\t.range([0,self.height])\n\t\t\t\t.nice(d3.time.month)\n\t\t\t\t;\n\t\t\treturn s.invert(self.height -s(_val));\n\t\t}    \n\t\t\n\t\tvar slider = d3.select(self.ui.dom[this.classkey].dateslider).call(slide);\n\t\t\n\t\td3.select(self.ui.dom[this.classkey].dateslider).selectAll('text').attr(\"transform\", \"translate(-\" + sliderwidth + \",20)\");\n\t\t\n\t\tupdate_datebar();\n\n\t\t// !--Map\n\t\tvar projection = d3.geo.mercator()\n\t\t\t.scale(160)\n\t\t\t.translate([self.ui.dom[this.classkey].map.view.offsetWidth * 0.5,self.ui.dom[this.classkey].map.view.offsetHeight * 0.5]);\n\t\t\n\t\tvar path = d3.geo.path().projection(projection);\n\n\t\tvar features = topojson.feature(self.continents,self.continents.objects.continents);\n\t\tvar intersections,\n\t\t\t\tintersections_unique,\n\t\t\t\ttrajectories,\n\t\t\t\ttrajectories_unique;\n\t\tvar points_target,\n\t\t\t\tpoints_g,\n\t\t\t\tpoints_backs,\n\t\t\t\tpoints_03,\n\t\t\t\tpoints_02,\n\t\t\t\tpoints_01,\n\n\t\t\t\tlines_target,\n\t\t\t\tlines_g,\n\t\t\t\tlines;\n\n\t\t//draw vector map\n\t\tvar map;\n\t\tmap = self[this.classkey].map.selectAll('path.map')\n\t\t\t.data([features]);\n\t\tmap.enter().append ('path')\n\t\t\t.classed('map',true);\n\t\tmap\n\t\t\t.attr('d',path);\n\t\tmap.exit().remove();\n\n\t\tfunction filter_data(){\n  \t\t  \t\t\n\t\t\t//clear objects\n\t\t\tintersections = {};\n\t\t\tintersections_unique = {};\n\t\t\ttrajectories = {};\n\t\t\ttrajectories_unique = {};\n\t\t\t\n\t\t\t//INTERSECTIONS\n\t\t\t//filter by date range\n\n\t\t\tvar holder = d3.entries(self.intersections).filter(function(d){  \t\t\t\n\t\t\t\tvar n = new Date(d.key);\n\t\t\t\treturn n >= self.date_start && n <=self.date_end;\n\t\t\t});\n\t\t\t\n\t\t\t//get distinct places\n\t\t\t//slot author IDs into place\n\t\t\t//highest likelihood score wins\n\t\t\tholder.forEach(function(d){\n\t\t\t\tif(d3.keys(d.value).length >0){\n\t\t\t\t\td3.keys(d.value).forEach(function(_d){  // _d is city key\n  \t\t\t\t\t\n  \t\t\t\t\t// Check to see if there is at least 1 valid author\n  \t\t\t\t\tvar b = 0;\n  \t\t\t\t\t\n            d.value[_d].forEach(function(__d){\n              if (self.active_authors_t.indexOf(__d.AuthorID) > -1) {\n                b++;\n              }\n            });\n                        \n            if (b==0) { return; }\n  \t\t\t\t\t\n  \t\t\t\t\t// Create entry\n  \t\t\t\t\t\n\t\t\t\t\t\tif(!intersections[_d]){ \n\t\t\t\t\t\t\tintersections[_d] = {}; \n\t\t\t\t\t\t\tintersections[_d].figures = {}; \n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t    // Only add valid authors\n\t\t\t\t    \t\t\n\t\t\t\t\t\td.value[_d].forEach(function(__d){\n\t\t\t\t\t\t\tif((!intersections[_d].figures[__d.AuthorID] || intersections[_d].figures[__d.AuthorID] >__d.Likelihood) && self.active_authors_t.indexOf(__d.AuthorID) > -1){\n\t\t\t\t\t\t\t\tintersections[_d].figures[__d.AuthorID] = __d.Likelihood;\n\t\t\t\t\t\t\t\tintersections[_d].info = d.value[_d];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\t//tally up totals\n\t\t\t\n\t\t\t// Assigns intersections lists dynamically\n\t\t\t\n\t\t\td3.keys(intersections).forEach(function(d){\n\t\t\t\tintersections[d].lists = {};\n\t\t\t  for(var i=1;i <= Object.keys(self.authors).length; i++) {\n  \t\t\t\tvar key = \"_0\" + i.toString();\n  \t\t\t\tintersections[d].lists[key] = d3.values(intersections[d].figures).filter(function(_d){ return _d === i; });\n        }\n\t\t\t});\n\n\t\t\t//make list of unique intersections per place\n\t\t\tholder.forEach(function(d){\n\t\t\t\td3.keys(d.value).forEach(function(_d){\n\t\t\t\t\tif(!intersections_unique[_d]){ intersections_unique[_d] = []; }\n\t\t\t\t\td.value[_d].forEach(function(__d){\n\t\t\t\t\t\tif(intersections_unique[_d].filter(function(t){ return t.AuthorID === __d.AuthorID && t.EndDate === __d.EndDate; }).length === 0){\n\t\t\t\t\t\t\tintersections_unique[_d].push(__d);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t\t//TRAJECTORIES\n\t\t\t\n\t\t\tholder.forEach(function(d){\n\t\t\t\td3.keys(d.value).forEach(function(_d){\n\t\t\t\t\td.value[_d].forEach(function(__d){\n\t\t\t\t\t\tif(!trajectories[__d.AuthorID]){ trajectories[__d.AuthorID] = []; }\n\t\t\t\t\t\tif(trajectories[__d.AuthorID].filter(function(t){ return t.PlaceID === __d.PlaceID && t.EndDate === __d.EndDate; }).length === 0){\n\t\t\t\t\t\t\ttrajectories[__d.AuthorID].push(__d);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\t\t\t\t\t\t\t\n      for (var author in trajectories) {\n       if (self.active_authors_t.indexOf(author) == -1) {\n         delete trajectories[author];\n       } \n      }\n      \n      // Places Hack: Replaces dashes with underscores to enforce consistency\n      \n      d3.keys(trajectories).forEach(function(key) {\n        d3.keys(trajectories[key]).forEach(function(__key) {\n          trajectories[key][__key].PlaceID = trajectories[key][__key].PlaceID.replaceAll('-','_');\n        });\n      });\n                              \n\t\t\t//pair up start and end points\n\t\t\tvar tier = 0;\n\t\t\tfor(var i=0; i<d3.keys(trajectories).length; i++){\n\t\t\t\tfor(var j=0; j<trajectories[d3.keys(trajectories)[i]].length -1; j++){\n\t\t\t\t\ttrajectories[d3.keys(trajectories)[i]][j].PlaceID_End = trajectories[d3.keys(trajectories)[i]][j+1].PlaceID;\n\t\t\t\t\ttrajectories[d3.keys(trajectories)[i]][j].Likelihood_End = trajectories[d3.keys(trajectories)[i]][j+1].Likelihood;\n\t\t\t\t\ttrajectories[d3.keys(trajectories)[i]][j].tier = tier;\n\t\t\t\t\ttier=(j%2)*10;\n\t\t\t\t} \n\t\t\t}\n\t\t\t\t\t\t\n\t\t\t//make list of unique trajectories per place\n\t\t\td3.keys(intersections).forEach(function(d){\n\t\t\t\tif(!trajectories_unique[d]){ trajectories_unique[d] = []; }\n\t\t\t});\n\t\t\t\n\t\t\td3.values(trajectories).forEach(function(d){\n\t\t\t\td.forEach(function(_d){ \n\t\t\t\t\tif(!trajectories_unique[_d.PlaceID]){ trajectories_unique[_d.PlaceID] = []; }\n\t\t\t\t\tif(!trajectories_unique[_d.PlaceID_End]){ trajectories_unique[_d.PlaceID_End] = []; }\n\t\t\t\t\ttrajectories_unique[_d.PlaceID].push(_d);\n\t\t\t\t\tif(_d.PlaceID_End){ trajectories_unique[_d.PlaceID_End].push(_d); }\n\t\t\t\t});\n\t\t\t});\n\t\t\t\t\t\t\n\t\t}\n\n\t\tfunction generate_lines(){\n  \t\t\n\t\t\tlines_target = self[self.classkey].map.selectAll('g.lines_target')\n\t\t\t\t.data([self]);\n\t\t\tlines_target.enter().append('g')\n\t\t\t\t.classed('lines_target',true);\n\t\t\tlines_target.exit().remove();\n\n\t\t\tlines_g = lines_target.selectAll('g.lines_g')\n\t\t\t\t.data(d3.entries(trajectories));\n\t\t\tlines_g.enter().append('g')\n\t\t\t\t.classed('lines_g',true);\n\t\t\tlines_g\n\t\t\t\t.attr('class',function(d){\n\t\t\t\t\treturn 'lines_g id_' +d3.keys(self.authors).indexOf(d.key);\n\t\t\t\t});\n\t\t\tlines_g.exit().remove();\n\n\t\t\tlines = lines_g.selectAll('path.line')\n\t\t\t\t.data(function(d){ return d.value.filter(function(_d){ return _d.PlaceID_End; }); });\n\t\t\tlines.enter().append('path')\n\t\t\t\t.classed('line',true);\n\t\t\t\t\n      try {\n\t\t\tlines\n  \t\t\t\t.attr('d',function(d){\n  \t\t\t\t\tvar source = {},\n  \t\t\t\t\t\t\ttarget = {};\n  \t\t\t\t\tvar p_1 = d.PlaceID || d.PlaceID_End,\n  \t\t\t\t\t\t\tp_2 = d.PlaceID_End || d.PlaceID;\n  \t\t\t\t\t\t\t\n  \t\t\t\t\t//isolate x and y start coordinates using projection\n  \t\t\t\t\t\n  \t\t\t\t\tif (typeof self.places[p_1] == \"undefined\" || typeof self.places[p_2] == \"undefined\") {\n    \t\t\t\t\tconsole.log(\"There was a problem with the PlaceID \" + d.PlaceID);\n  \t\t\t\t\t}\n  \t\t\t\t\t\n  \t\t\t\t\tsource = projection([\n  \t\t\t\t\t\tself.places[p_1].Long,\n  \t\t\t\t\t\tself.places[p_1].Lat\n  \t\t\t\t\t]);\n  \t\t\t\t\t// if(!self.places[p_2]){debugger;}\n  \t\t\t\t\t//isolate x and y end coordinates using projection\n  \t\t\t\t\ttarget = projection([\n  \t\t\t\t\t\tself.places[p_2].Long,\n  \t\t\t\t\t\tself.places[p_2].Lat\n  \t\t\t\t\t]);\n  \t\t\t\t\t\n  \t\t\t\t\t//this is a path builder -- creates a curved line between points\n  \t\t\t\t\t//src: http://stackoverflow.com/questions/13455510/curved-line-on-d3-force-directed-tree\n  \t\t\t\t\tvar dx = target[0] -source[0],\n  \t\t\t\t\t\t\tdy = target[1] -source[1],\n  \t\t\t\t\t\t\tdr = Math.sqrt((dx +d.tier) * (dx +d.tier) + (dy +d.tier) * (dy +d.tier));\n  \t\t\t\t\treturn 'M' + source[0] + ',' + source[1] + 'A' + dr + ',' + dr + ' 0 0,1 ' + target[0] + ',' + target[1];\n  \t\t\t\t});\n  \t\t\tlines.exit().remove();\n\t\t\t} catch(e) {\n  \t\t\tconsole.log(e);\n\t\t\t}\n\t\t}\n\n\t\tfunction generate_points(){\n  \t\t  \t\t\n\t\t\t//scale for radii\n\t\t\tvar r_scale = d3.scale.linear()\n\t\t\t\t.domain([0,10])\n\t\t\t\t.range([0,36]);\n\t\t\t\t\n\t\t\tpoints_target = self[self.classkey].map.selectAll('g.points_target')\n\t\t\t\t.data([self]);\n\t\t\tpoints_target.enter().append('g')\n\t\t\t\t.classed('points_target',true);\n\t\t\tpoints_target.exit().remove();\n\n\t\t\tpoints_g = self[self.classkey].map.selectAll('g.points_g')\n\t\t\t\t.data(d3.entries(intersections));\n\t\t\tpoints_g.enter().append('g')\n\t\t\t\t.classed('points_g',true);\n\t\t\t\t\n\t\t\ttry {\t\n  \t\t\tpoints_g\n  \t\t\t\t.attr('transform',function(d){\n    \t\t\t\t\n    \t\t\t\tif (typeof self.places[d.key] === \"undefined\") {\n      \t\t\t\tconsole.log(\"There was a problem with the PlaceID \" + d.key);\n    \t\t\t\t}\n    \t\t\t\t\n  \t\t\t\t\tvar p  = projection([\n  \t\t\t\t\t\t\t\tself.places[d.key].Long,\n  \t\t\t\t\t\t\t\tself.places[d.key].Lat\n  \t\t\t\t\t\t\t]),\n  \t\t\t\t\t\t\tpx = p[0],\n  \t\t\t\t\t\t\tpy = p[1];\n  \t\t\t\t\treturn 'translate(' +px +',' +py +')';\n  \t\t\t\t})\n  \t\t\t\t.append('text')\n  \t\t\t\t.attr(\"class\", \"tip\")\t\t\t\t\n  \t\t\t\t.text(function(d){\n    \t\t\t\tvar tooltip = [];\n    \t\t\t\ttooltip.push(self.places[d.key].PlaceName);\n    \t\t\t\t\n    \t\t\t\t// Add names and citations\n    \t\t\t\tfor(var i=0;i< d.value.info.length;i++) {\n      \t\t\t\tvar info = []\n      \t\t\t\tinfo.push(self.authors[d.value.info[i].AuthorID]);\n      \t\t\t\t\n      \t\t\t\tif (d.value.info[i].StartDate != \"\") {\n        \t\t\t\tinfo.push(\" \\nFrom: \" + d.value.info[i].StartDate.toString());\n      \t\t\t\t}\n      \t\t\t\t\n              if(d.value.info[i].StartCitation != \"\") {\n                info.push(\" (\" + d.value.info[i].StartCitation.toString() + \")\")            \n              }    \t\t\t\t\n      \t\t\t\tif (d.value.info[i].EndDate != '') {\n        \t\t\t\tinfo.push(\"\\nUntil: \" + d.value.info[i].EndDate);\n      \t\t\t\t}\n      \t\t\t\t\n      \t\t\t\tif (d.value.info[i].EndDate != '') {\n                info.push(\" (\" + d.value.info[i].StartCitation.toString() + \")\");\n      \t\t\t\t}\n      \t\t\t\t\n      \t\t\t\ttooltip.push(info.join(''));\n    \t\t\t\t}\n    \t\t\t\t\n    \t\t\t\treturn tooltip.join(\"<br />\");\n  \t\t\t\t});\n      } catch(e) {\n        console.log(e);\n      }\n\t\t\tpoints_g\n\t\t\t\t.on('mousemove',function(d){\n\t\t\t\t\td3.select(this)\n\t\t\t\t\t\t.transition()\n\t\t\t\t\t\t.duration(self.ttime)\n\t\t\t\t\t\t.attr('transform',function(_d){\n\t\t\t\t\t\t\tvar p  = projection([\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\n\t\t\t\t\t\t\t\t\t]),\n\t\t\t\t\t\t\t\t\tpx = p[0],\n\t\t\t\t\t\t\t\t\tpy = p[1];\n\t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(1.5)';\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.on('mouseout',function(d){\n\t\t\t\t\td3.select(this)\n\t\t\t\t\t\t.transition()\n\t\t\t\t\t\t.duration(self.ttime/2)\n\t\t\t\t\t\t.attr('transform',function(_d){\n\t\t\t\t\t\t\tvar p  = projection([\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\n\t\t\t\t\t\t\t\t\t]),\n\t\t\t\t\t\t\t\t\tpx = p[0],\n\t\t\t\t\t\t\t\t\tpy = p[1];\n\t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(1)';\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.on('click',function(d){\n\t\t\t\t\td3.event.stopPropagation();\n\t\t\t\t\tunfocus();\n\t\t\t\t\tif(d.key !== focus.key){\n\t\t\t\t\t\tfocus = d;\n\t\t\t\t\t\td3.select(this).classed('focus_point',true);\n\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t// Tooltip code.\n\t\t\t\t\t// Leverages CSS3 Animations instead of D3.\n\t\t\t\t\t// Fade out and removal of tooltips needs a new methodlogy. \n\t\t\t\t\t\n\t\t\t\t\tvar g = d3.select(this);\n\t\t\t\t\tvar t = d3.select(this).select('text').text();\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t// Get bounding rectangle size for general positioning.\n\t\t\t\t\t\n\t\t\t\t\tvar rect = this.getBoundingClientRect();\n\t\t\t\t\tvar top = rect.top + window.pageYOffset + 20;\n\t\t\t\t\tvar left = rect.left + window.pageXOffset + 20;\n\t\t\t\t\t\n\t\t\t\t\t// Remove existing tooltips\n\t\t\t\t\t\n\t\t\t\t  d3.select('.tooltip').remove();\n\t\t\t\t  \n\t\t\t\t  // Add an absolutely positioned tooltip to the viz frame\n\n\t\t\t\t\td3.select(self.ui.dom.trajectories.elem)\n\t\t\t\t\t  .append('div')\n\t\t\t\t\t  .attr('class','tooltip')\n            .style({\n  \t\t\t\t\t  'top': top + \"px\",\n  \t\t\t\t\t  'left': left + \"px\",\n  \t\t\t\t\t  'bottom' : 'auto',\n  \t\t\t\t\t  'right' : 'auto'\n\t\t\t\t\t  })\n\t\t\t\t\t  .html(t)\n\t\t\t\t\t  .on('click',function() {\n  \t\t\t\t\t  // Click event behaviour for tooltip itself.\n  \t\t\t\t\t    \n  \t\t\t\t\t  // Animation is controlled through CSS.\n  \t\t\t\t\t  // Not working as expected.\n  \t\t\t\t\t  // Prefered behaviour: on click, the tooltip reverses the CSS animation and fades. Once the animation is complete\n  \t\t\t\t\t  // the tooltip is removed from the DOM.\n  \t\t\t\t\t  // Trickier than it sounds: d3 doesn’t offer an effective way of running a callback when animations are complete,\n  \t\t\t\t\t  // and this CSS based implementation is not working as expected.\n  \t\t\t\t\t  // Left here for future consideration.\n  \t\t\t\t\t  \n  \t\t\t\t\t  d3.select(this)\n  \t\t\t\t      .style({\n    \t\t\t\t      'animation-direction':'reverse',\n    \t\t\t\t      'animaiton-play-state': 'running',\n    \t\t\t\t      'animation-fill-mode': 'backwards'\n    \t\t\t\t      })\n    \t\t\t\t    .transition()\n    \t\t\t\t    .delay(800)\n  \t\t\t\t      .remove();\n  \t\t\t\t  });\n  \t\t\t\t  \n\t\t\t\t\tdisplay_results();\n\t\t\t\t});\n\t\t\t\t\n\t\t\tpoints_g.exit().remove();\n\n\t\t\t//circlebacks (most certain size)\n\t\t\tpoints_backs = points_g.selectAll('circle.point_back')\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\n\t\t\tpoints_backs.enter().append('circle')\n\t\t\t\t.classed('point_back',true);\n\t\t\tpoints_backs\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){\n\t\t\t\t\treturn r_scale(1);\n\t\t\t\t});\n\t\t\tpoints_backs.exit().remove();\n\n\t\t\t//least certain\n\t\t\tpoints_01 = points_g.selectAll('circle.point_01')\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\n\t\t\tpoints_01.enter().append('circle')\n\t\t\t\t.classed('point_01',true);\n\t\t\tpoints_01\n\t\t\t\t.classed('point',true)\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){\n\t\t\t\t\treturn r_scale(1);\n\t\t\t\t});\n\t\t\tpoints_01.exit().remove();\n\t\t\t\t\n\t\t\t//certain\n\t\t\tpoints_02 = points_g.selectAll('circle.point_02')\n\t\t\t\t.data(function(d){ return [d.value.lists._02]; });\n\t\t\tpoints_02.enter().append('circle')\n\t\t\t\t.classed('point_02',true);\n\t\t\tpoints_02\n\t\t\t\t.classed('point',true)\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){ \n\t\t\t\t\treturn r_scale(1);\n\t\t\t\t});\n\t\t\tpoints_02.exit().remove();\n\t\t\t\t\n\t\t\t//most certain\n\t\t\tpoints_03 = points_g.selectAll('circle.point_03')\n\t\t\t\t.data(function(d){ return [d.value.lists._03]; });\n\t\t\tpoints_03.enter().append('circle')\n\t\t\t\t.classed('point_03',true);\n\t\t\tpoints_03\n\t\t\t\t.classed('point',true)\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){\n\t\t\t\t\tvar r_tot = d.length;\n\t\t\t\t\treturn r_scale(r_tot);\n\t\t\t\t});\n\t\t\tpoints_03.exit().remove();\n\t\t}\n\n\t\tfunction display_results(){\n  \t\tvar self = this;\n  \t\t\n\t\t\tvar o_scale = d3.scale.linear()\n\t\t\t\t.domain([0,3])\n\t\t\t\t.range([0.5,1]);\n\n\t\t\tif(focus){\n\t\t\t\td3.select(self.ui.dom.intersections.results.title).html(self.places[focus.key].PlaceName);\n\n\t\t\t\t//var data = sidebar_mode === 1 ? (intersections_unique[focus.key] || []) : (trajectories_unique[focus.key]);\n\t\t\t\tvar data = intersections_unique[focus.key] || [];\n\t\t\t\tvar items_target = d3.select(self.ui.dom.intersections.results.view);\n\t\t\t\tvar items,\n\t\t\t\t\t\titems_date;\n\n\t\t\t\titems = items_target.selectAll('.item')\n\t\t\t\t\t.data(data);\n\t\t\t\titems.enter().append('div')\n\t\t\t\t\t.classed('item',true);\n\t\t\t\titems\n\t\t\t\t\t.attr('class',function(d){\n\t\t\t\t\t\tvar idx = d3.keys(self.authors).indexOf(d.AuthorID);\n\t\t\t\t\t\treturn 'item id_' +idx;\n\t\t\t\t\t})\n\t\t\t\t\t.style('opacity',function(d){\n\t\t\t\t\t\treturn o_scale(d.Likelihood);\n\t\t\t\t\t})\n\t\t\t\t\t.html(function(d){\n\t\t\t\t\t\treturn self.authors[d.AuthorID];\n\t\t\t\t\t});\n\t\t\t\titems.exit().remove();\n\n\t\t\t\titems_date = items.selectAll('div.item_date')\n\t\t\t\t\t.data(function(d){ return [d]; });\n\t\t\t\titems_date.enter().append('div')\n\t\t\t\t\t.classed('item_date',true);\n\t\t\t\titems_date\n\t\t\t\t\t.html(function(d){\n\t\t\t\t\t\tvar str;\n\t\t\t\t\t\tstr = d.StartDate && d.EndDate ? d.StartDate +'&nbsp;&ndash;&nbsp;' +d.EndDate : d.StartDate ? d.StartDate +'&nbsp;&ndash;' : d.EndDate ? '&nbsp;&ndash;' +d.EndDate : '';\n\t\t\t\t\t\t\n\t\t\t\t\t\t/* // Trajectory code\n\t\t\t\t\t\t\tvar a1 = d.PlaceID === focus.key ? 'accent' : '',\n\t\t\t\t\t\t\t\t\ta2 = d.PlaceID_End && d.PlaceID_End === focus.key ? 'accent' : '';\n\t\t\t\t\t\t\tvar p1 = '<span class=\"_' +d.Likelihood +' ' +a1 +'\">' +self.places[d.PlaceID].PlaceName +'</span>',\n\t\t\t\t\t\t\t\t\tp2 = '<span class=\"_' +d.Likelihood_End +' ' +a2 +'\">' +(d.PlaceID_End ? self.places[d.PlaceID_End].PlaceName : '') +'</span>';\n\t\t\t\t\t\t\tstr = '<div class=\"b\">' +(d.EndDate || '') +'</div><div>' +p1 +'&nbsp;&rarr;&nbsp;' +p2 +'</div>';\n\t\t\t\t\t\t*/\n\t\t\t\t\t\treturn str;\n\t\t\t\t\t});\n\t\t\t\titems_date.exit().remove();\n\n\t\t\t} else{\n\t\t\t\td3.select('#sidebar_title').html('');\n\t\t\t\td3.select('#sidebar_items').html('');\n\t\t\t}\n\t\t}\n\n\t\tfunction update_datebar(){\n\t\t\tvar f = d3.time.format('%b %Y');\n\t\t\td3.select(self.ui.dom[self.classkey].datestart).html(f(self.date_start));\n\t\t\td3.select(self.ui.dom[self.classkey].dateend).html(f(self.date_end));\n\t\t}\n\n\t\tfunction update(){\n\t\t\tfilter_data();\n\t\t\tgenerate_lines();\n\t\t\tgenerate_points();\n\t\t\tdisplay_results();\n\t\t}\n\n\t\tfunction unfocus(){\n\t\t\tfocus = false;\n\t\t\td3.selectAll('.focus_point').classed('focus_point',false);\n\t\t}\n\n\t\tfilter_data();\n\t\tgenerate_lines();\n\t\tgenerate_points();\n\t\tdisplay_results();\n\t}\n  \n  tear_down() {\n  \tsuper.tear_down();\n  \tvar self = this;\n    var opp = this.mode === 1 ? 2 : 1;\n\t\t\n\t\td3.select(self.ui.dom[this.classkey].dateslider).selectAll('*').remove();\n\t\t\n\t\td3.selectAll('.sidebar_tab.selected').classed('selected',false);\n\t\td3.select('.sidebar_tab#sidebar_01').classed('selected',true);\n\n\t\td3.selectAll('._0' +opp).style('display','none');\n\t\td3.selectAll('._0' +this.mode).style('display','block');\n\n\t\tthis.date_start = this.range[0];\n\t\tthis.date_end = this.range[1];\n\n\t}}\n\n/*! INTERSECTIONS CLASS */\n\nclass Intersections extends DateMapController {\n  constructor() {\n    super();\n    this.mode = 1; \n    this.classkey = 'intersections';   \n    this.intersections = {}\n    this.trajectories = {}\n    this.ui = new IntersectionsUI();\n\n  }\n  \n  init() {\n    super.init();\n  }\n  \n  setup() {\n    \n\t\tsuper.setup();\n\t\t\n\t\tvar self = this;\n\t\t\n\t\t// Intersections setup\n\t\t\n\t\tthis[this.classkey].map = d3.select(self.ui.dom[this.classkey].map.view)\n\t\t  .append('svg')\n\t\t  .attr('width','100%');\n        \n\t\tthis.svg = d3.select('#container')\n\t\t\t.append('svg')\n\t\t\t.attr('width',this.width);\n\n  }\n  \n  process_data() {\n    super.process_data();\n    \t\t\t\t\t\t    \n    //trajectories\n\t\tthis.trajectories = {};\n\n  }\n  \n\t/* !-- Intersections Generate */\n\n\tgenerate(){\n  \tsuper.generate();\n  \t\n\t\tvar self = this;\n\t\tvar focus = false;\n    \n\t\tthis[this.classkey].map.attr('height',this.height);\n\n\t\t//click handlers\n\t\tthis[this.classkey].map.on('click',function(){\n\t\t\td3.event.stopPropagation();\n\t\t\tunfocus();\n\t\t\tdisplay_results();\n\t\t});\n\t\t\n\t\t// !--Slider\n\n\t\tvar sliderwidth = self.ui.dom[this.classkey].dateslider.offsetWidth;\n\t\t\n\t\tvar scale = d3.time.scale()\n\t\t\t.domain(this.range);\n\t\t\t\t\t\t\t\t\t\t\n\t\tvar scale_axis = d3.svg.axis()\n\t\t\t.orient('right')\n\t\t\t.ticks(10)\n\t\t\t.tickSize(sliderwidth - 2) //takes into account a 2px border\n\t\t\t.tickFormat(function(date){\n  \t\t\tvar dateObj = new Date(date);\n  \t\t\treturn dateObj.getUTCFullYear(); // Corrects issue introduced in Chrome 68\n\t\t\t})\n\t\t\t.tickPadding(12);\n\t\t\t\n\t\tvar slide = d3.slider()\n\t\t\t.scale(scale)\n\t\t\t.axis(scale_axis)\n\t\t\t.value([\n\t\t\t\tscale_value_converter(this.range[1]),\n\t\t\t\tscale_value_converter(this.range[0])\n\t\t\t])\n\t\t\t.orientation('vertical')\n\t\t\t.margin(0)\n\t\t\t.animate(false)\n\t\t\t.on('slide',function(evt,value){\n\t\t\t\tvar v_1 = value[1] instanceof Date ? value[1] : new Date(value[1]),\n\t\t\t\t\t\tv_2 = value[0] instanceof Date ? value[0] : new Date(value[0]);\n\t\t\t\t\n\t\t\t\tself.date_start = scale_value_converter(v_1);\n\t\t\t\tself.date_end = scale_value_converter(v_2);\n\n\t\t\t\t// unfocus();\n\t\t\t\tupdate_datebar();\n\t\t\t\tupdate();\n\t\t\t})\n\t\t\t.on('slideend',function(evt,value){\n\t\t\t\tupdate();\n\t\t\t});\n\t\t\t\n\n\t\t//the slider library, though lightweight, is flawed\n\t\t//use this to convert the date values properly\n\t\tfunction scale_value_converter(_val){\n\t\t\tvar s = d3.time.scale()\n\t\t\t\t.domain(scale.domain())\n\t\t\t\t.range([0,self.height])\n\t\t\t\t.nice(d3.time.month);\n\t\t\treturn s.invert(self.height -s(_val));\n\t\t}    \n\n\t\tvar slider = d3.select(self.ui.dom[this.classkey].dateslider).call(slide);\n\t\t\n\t\td3.select(self.ui.dom[this.classkey].dateslider).selectAll('text').attr(\"transform\", \"translate(-\" + sliderwidth + \",20)\");\n\t\t\n\t\tupdate_datebar();\n\t\t\t\t\n\t\t//map\n\t\t\n\t\tvar projection = d3.geo.mercator()\n\t\t\t.scale(160)\n\t\t\t.translate([self.ui.dom[this.classkey].map.view.offsetWidth * 0.5,self.ui.dom[this.classkey].map.view.offsetHeight * 0.5]);\n\t\t\t\n\t\tvar path = d3.geo.path().projection(projection);\n\n\t\tvar features = topojson.feature(self.continents,self.continents.objects.continents);\n\t\tvar intersections,\n\t\t\t\tintersections_unique;\n\t\tvar points_target,\n\t\t\t\tpoints_g,\n\t\t\t\tpoints_backs,\n\t\t\t\tpoints_03,\n\t\t\t\tpoints_02,\n\t\t\t\tpoints_01;\n\n\t\t//draw vector map\n\t\tvar map;\n\t\tmap = self[self.classkey].map.selectAll('path.map')\n\t\t\t.data([features]);\n\t\tmap.enter().append ('path')\n\t\t\t.classed('map',true);\n\t\tmap\n\t\t\t.attr('d',path);\n\t\tmap.exit().remove();\n\n\t\tfunction filter_data(){\n\n\t\t\t//clear objects\n\t\t\tintersections = {};\n\t\t\tintersections_unique = {};\n\t\t\t\t\t\t\t\t\t\n\t\t\t//INTERSECTIONS\n\t\t\t//filter by date range\n\t\t\tvar holder = d3.entries(self.intersections).filter(function(d){\n\t\t\t\tvar n = new Date(d.key);\n\t\t\t\treturn n >=self.date_start && n <=self.date_end;\n\t\t\t});\n\t\t\t\n\t\t\t//get distinct places\n\t\t\t//slot author IDs into place\n\t\t\t//highest likelihood score wins\n\t\t\tholder.forEach(function(d){\n\t\t\t\tif(d3.keys(d.value).length >0){\n\t\t\t\t\td3.keys(d.value).forEach(function(_d){\n\t\t\t\t\t\tif(!intersections[_d]){ \n\t\t\t\t\t\t\tintersections[_d] = {}; \n\t\t\t\t\t\t\tintersections[_d].figures = {}; \n\t\t\t\t\t\t}\n\t\t\t\t\t\td.value[_d].forEach(function(__d){\n\t\t\t\t\t\t\tif(!intersections[_d].figures[__d.AuthorID] || intersections[_d].figures[__d.AuthorID] >__d.Likelihood){\n\t\t\t\t\t\t\t\tintersections[_d].figures[__d.AuthorID] = __d.Likelihood;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\t//tally up totals\n\t\t\t\n\t\t\t// Assigns intersections lists dynamically\n\t\t\t\n\t\t\td3.keys(intersections).forEach(function(d){\n\t\t\t\tintersections[d].lists = {};\n\t\t\t  for(var i=1;i <= Object.keys(self.authors).length; i++) {\n  \t\t\t\tvar key = \"_0\" + i.toString();\n  \t\t\t\tintersections[d].lists[key] = d3.values(intersections[d].figures).filter(function(_d){ return _d === i; });\n        }\n\t\t\t});\n\t\t\t\t\t\t\n\t\t\t//make list of unique intersections per place\n\t\t\tholder.forEach(function(d){\n\t\t\t\td3.keys(d.value).forEach(function(_d){\n\t\t\t\t\tif(!intersections_unique[_d]){ intersections_unique[_d] = []; }\n\t\t\t\t\td.value[_d].forEach(function(__d){\n\t\t\t\t\t\tif(intersections_unique[_d].filter(function(t){ return t.AuthorID === __d.AuthorID && t.EndDate === __d.EndDate; }).length === 0){\n\t\t\t\t\t\t\tintersections_unique[_d].push(__d);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t\t\n\t\t\t// vet places with only one figure\n\t\t\t\n\t\t\tvar vetted = [];\n\t\t\t\n\t\t\tfor(var city in intersections) {\n  \t\t\tif(Object.keys(intersections[city].figures).length < 2) {\n    \t\t\tvetted.push(city);\n          delete intersections[city];\n  \t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tfor(var iucity in intersections_unique) {\n  \t\t\tif(vetted.indexOf(iucity) > -1) {\n    \t\t\tdelete intersections_unique[iucity];\n  \t\t\t}\n  \t\t}\n\n\t\t}\n\n\t\tfunction generate_points(){\n  \t\t\n\t\t\t//scale for radii\n\t\t\tvar r_scale = d3.scale.linear()\n\t\t\t\t.domain([0,10])\n\t\t\t\t.range([0,36]);\n\t\t\t\t\n\t\t\tpoints_target = self.intersections.map.selectAll('g.points_target')\n\t\t\t\t.data([self]);\n\t\t\tpoints_target.enter().append('g')\n\t\t\t\t.classed('points_target',true);\n\t\t\tpoints_target.exit().remove();\n\n\t\t\tpoints_g = self.intersections.map.selectAll('g.points_g')\n\t\t\t\t.data(d3.entries(intersections));\n\t\t\tpoints_g.enter().append('g')\n\t\t\t\t.classed('points_g',true);\n\t\t\t\t\n      try {\n  \t\t\tpoints_g\n  \t\t\t\t.attr('transform',function(d){\n    \t\t\t\t\n    \t\t\t\tif (typeof self.places[d.key] == \"undefined\") {\n      \t\t\t\tconsole.log(\"There was a problem with the PlaceID: \" + d.key); \n    \t\t\t\t}\n    \t\t\t\t\n  \t\t\t\t\tvar p  = projection([\n  \t\t\t\t\t\t\t\tself.places[d.key].Long,\n  \t\t\t\t\t\t\t\tself.places[d.key].Lat\n  \t\t\t\t\t\t\t]),\n  \t\t\t\t\t\t\tpx = p[0],\n  \t\t\t\t\t\t\tpy = p[1];\n  \t\t\t\t\treturn 'translate(' +px +',' +py +')';\n  \t\t\t\t})\n  \t\t\t\t.append('title')\n  \t\t\t\t.text(function(d){\n    \t\t\t\treturn self.places[d.key].PlaceName;\n  \t\t\t\t});\n      } catch (e) {\n        console.log(e);\n      }\n\t\t\tpoints_g\n\t\t\t\t.on('click',function(d){\n\t\t\t\t\td3.event.stopPropagation();\n\t\t\t\t\t\n  \t\t\t\tvar point = d3.select(this);\n  \t\t\t\t  \t\t\t\t\n  \t\t\t\t// Scale point\n  \t\t\t\t\n  \t\t\t\tvar scale = 1.5;\n  \t\t\t\t\n  \t\t\t\t// reset all points\n  \t\t\t\tpoints_g.forEach(function(d){\n    \t\t\t\td3.select(this)\n    \t\t\t\t  .classed('selected',false)\n  \t\t\t\t\t\t.transition()\n  \t\t\t\t\t\t.duration(self.ttime)\n  \t\t\t\t\t\t.attr('transform',function(_d){\n  \t\t\t\t\t\t\tvar p  = projection([\n  \t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\n  \t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\n  \t\t\t\t\t\t\t\t\t]),\n  \t\t\t\t\t\t\t\t\tpx = p[0],\n  \t\t\t\t\t\t\t\t\tpy = p[1];\n  \t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(1)';\n  \t\t\t\t\t\t});\n  \t\t\t\t});\n  \t\t\t\t  \t\t\t\t\n\t\t\t\t\tpoint\n\t\t\t\t\t  .classed('selected',true)\n\t\t\t\t\t\t.transition()\n\t\t\t\t\t\t.duration(self.ttime)\n\t\t\t\t\t\t.attr('transform',function(_d){\n\t\t\t\t\t\t\tvar p  = projection([\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Long,\n\t\t\t\t\t\t\t\t\t\tself.places[_d.key].Lat\n\t\t\t\t\t\t\t\t\t]),\n\t\t\t\t\t\t\t\t\tpx = p[0],\n\t\t\t\t\t\t\t\t\tpy = p[1];\n\t\t\t\t\t\t\treturn 'translate(' +px +',' +py +')scale(' + scale + ')';\n\t\t\t\t\t\t});\n  \t\t\t\t\n  \t\t\t\t// display results\n  \t\t\t\t\n\t\t\t\t\tunfocus();\n\t\t\t\t\tif(d.key !== focus.key){\n\t\t\t\t\t\tfocus = d;\n\t\t\t\t\t\td3.select(this).classed('focus_point',true);\n\t\t\t\t\t}\n  \t\t\t\t\tdisplay_results();\n\t\t\t\t});\n\t\t\tpoints_g.exit().remove();\n\n\t\t\t//circlebacks (most certain size)\n\t\t\tpoints_backs = points_g.selectAll('circle.point_back')\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\n\t\t\tpoints_backs.enter().append('circle')\n\t\t\t\t.classed('point_back',true);\n\t\t\tpoints_backs\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){\n\t\t\t\t\tvar r_tot = d.length +this.parentNode.__data__.value.lists._02.length +this.parentNode.__data__.value.lists._03.length;\n\t\t\t\t\treturn r_scale(r_tot);\n\t\t\t\t});\n\t\t\tpoints_backs.exit().remove();\n\n\t\t\t//least certain\n\t\t\tpoints_01 = points_g.selectAll('circle.point_01')\n\t\t\t\t.data(function(d){ return [d.value.lists._01]; });\n\t\t\tpoints_01.enter().append('circle')\n\t\t\t\t.classed('point_01',true);\n\t\t\tpoints_01\n\t\t\t\t.classed('point',true)\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){\n\t\t\t\t\tvar r_tot = d.length +this.parentNode.__data__.value.lists._02.length +this.parentNode.__data__.value.lists._03.length;\n\t\t\t\t\treturn r_scale(r_tot);\n\t\t\t\t});\n\t\t\tpoints_01.exit().remove();\n\t\t\t\t\n\t\t\t//certain\n\t\t\tpoints_02 = points_g.selectAll('circle.point_02')\n\t\t\t\t.data(function(d){ return [d.value.lists._02]; });\n\t\t\tpoints_02.enter().append('circle')\n\t\t\t\t.classed('point_02',true);\n\t\t\tpoints_02\n\t\t\t\t.classed('point',true)\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){ \n\t\t\t\t\tvar r_tot = d.length +this.parentNode.__data__.value.lists._03.length;\n\t\t\t\t\treturn r_scale(r_tot);\n\t\t\t\t});\n\t\t\tpoints_02.exit().remove();\n\t\t\t\t\n\t\t\t//most certain\n\t\t\tpoints_03 = points_g.selectAll('circle.point_03')\n\t\t\t\t.data(function(d){ return [d.value.lists._03]; });\n\t\t\tpoints_03.enter().append('circle')\n\t\t\t\t.classed('point_03',true);\n\t\t\tpoints_03\n\t\t\t\t.classed('point',true)\n\t\t\t\t.attr('cx',0)\n\t\t\t\t.attr('cy',0)\n\t\t\t\t.attr('r',function(d){\n\t\t\t\t\tvar r_tot = d.length;\n\t\t\t\t\treturn r_scale(r_tot);\n\t\t\t\t});\n\t\t\tpoints_03.exit().remove();\n\t\t}\n\n\t\tfunction display_results(){\n\t\t\tvar o_scale = d3.scale.linear()\n\t\t\t\t.domain([0,3])\n\t\t\t\t.range([0.5,1]);\n\n\t\t\tif(focus){\n\t\t\t\td3.select(self.ui.dom[self.classkey].results.title).html(self.places[focus.key].PlaceName);\n\n\t\t\t\t//var data = sidebar_mode === 1 ? (intersections_unique[focus.key] || []) : (trajectories_unique[focus.key]);\n\t\t\t\tvar data = intersections_unique[focus.key] || [];\n\t\t\t\tvar items_target = d3.select(self.ui.dom[self.classkey].results.view);\n\t\t\t\tvar items,\n\t\t\t\t\t\titems_date;\n\n\t\t\t\titems = items_target.selectAll('.item')\n\t\t\t\t\t.data(data);\n\t\t\t\titems.enter().append('div')\n\t\t\t\t\t.classed('item',true);\n\t\t\t\titems\n\t\t\t\t\t.attr('class',function(d){\n\t\t\t\t\t\tvar idx = d3.keys(self.authors).indexOf(d.AuthorID);\n\t\t\t\t\t\treturn 'item id_' +idx;\n\t\t\t\t\t})\n\t\t\t\t\t.style('opacity',function(d){\n\t\t\t\t\t\treturn o_scale(d.Likelihood);\n\t\t\t\t\t})\n\t\t\t\t\t.html(function(d){\n\t\t\t\t\t\treturn self.authors[d.AuthorID];\n\t\t\t\t\t});\n\t\t\t\titems.exit().remove();\n\n\t\t\t\titems_date = items.selectAll('div.item_date')\n\t\t\t\t\t.data(function(d){ return [d]; });\n\t\t\t\titems_date.enter().append('div')\n\t\t\t\t\t.classed('item_date',true);\n\t\t\t\titems_date\n\t\t\t\t\t.html(function(d){\n\t\t\t\t\t\tvar dateproc = [];\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (d.StartDate) {\n  \t\t\t\t\t\tdateproc.push(d.StartDate);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (d.EndDate) {\n  \t\t\t\t\t\tdateproc.push(d.EndDate);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\treturn  dateproc.length > 0 ? dateproc.join('&nbsp;–&nbsp;') : '';\n\t\t\t\t\t\t\n\t\t\t\t\t\t//str = d.StartDate && d.EndDate ? d.StartDate +'&nbsp;&ndash;&nbsp;' + d.EndDate : d.StartDate ? d.StartDate +'&nbsp;&ndash;' : d.EndDate ? '&nbsp;&ndash;' +d.EndDate : '';\n\t\t\t\t\t\t//return str;\n\t\t\t\t\t});\n\t\t\t\titems_date.exit().remove();\n\t\t\t\t\n\t\t\t\tself.ui.addListSizeClass(data,self.ui.dom[self.classkey].results.view);\n\n\t\t\t} else{\n\t\t\t\td3.select('#sidebar_title').html('');\n\t\t\t\td3.select('#sidebar_items').html('');\n\t\t\t\tself.ui.addListSizeClass([],self.ui.dom[self.classkey].results.view);\n\t\t\t}\n\t\t}\n\n\t\tfunction update_datebar(){\n\t\t\tvar f = d3.time.format('%b %Y');\n\t\t\td3.select(self.ui.dom[self.classkey].datestart).html(f(self.date_start));\n\t\t\td3.select(self.ui.dom[self.classkey].dateend).html(f(self.date_end));\n\t\t}\n\n\t\tfunction update(){\n\t\t\tfilter_data();\n\t\t\tgenerate_points();\n\t\t\tdisplay_results();\n\t\t}\n\n\t\tfunction unfocus(){\n\t\t\tfocus = false;\n\t\t\td3.selectAll('.focus_point').classed('focus_point',false);\n\t\t}\n\n\t\tfilter_data();\n\t\tgenerate_points();\n\t\tdisplay_results();\n\t}\n\t\n  tear_down() {\n  \tsuper.tear_down();\n  \tvar self = this;\n    var opp = this.mode === 1 ? 2 : 1;\n\t\t\n\t\tthis.intersections.map.selectAll(\"*\").remove();\n\t\td3.select(self.ui.dom[this.classkey].dateslider).selectAll('*').remove();\n\t\t\n\t\td3.selectAll('.sidebar_tab.selected').classed('selected',false);\n\t\td3.select('.sidebar_tab#sidebar_01').classed('selected',true);\n\n\t\td3.selectAll('._0' +opp).style('display','none');\n\t\td3.selectAll('._0' +this.mode).style('display','block');\n\n\t\tthis.date_start = this.range[0];\n\t\tthis.date_end = this.range[1];\n\n\t}  \n}\n\n/* !ITINERARIES CLASS */\n\nclass Itineraries extends Visualization {\n  constructor() {\n    super();\n    this.classkey = 'itineraries';   \n    this.selectedauthors = [];\n    this.routes = [];\n    this.visHeight = this.height * 4;\n    this.ui = new ItinerariesUI();\n    this.selectionsw = d3.select(this.ui.dom.itineraries.authors.selections).node().getBoundingClientRect().width;\n  }\n  \n  init() {\n    super.init();\n  }\n  \n  focus() {\n    d3.select('body').style('position','inherit');\n    d3.select('body').style('bottom','auto');\n  }\n  \n  setup() {\n    var self = this;\n    \n    // Set up author selection UI\n        \n    d3.select(self.ui.dom[this.classkey].authors.list)\n      .html(self.ui.generateAuthorList(this));\n\t\t\t\t\n    d3.select(self.ui.dom[this.classkey].authors.list)\n      .selectAll('.author').each(function(){\n        d3.select(this).on('click',function(){\n          var elem = d3.select(this);  \n          var akey = elem.attr('data-key');\n                              \n          if(elem.classed('selected')) {\n            elem.classed('selected',false);\n            self.selectedauthors[self.selectedauthors.indexOf(akey)] = null;\n          } else {\n            \n            self.selectedauthors = [];\n            \n            d3.select(self.ui.dom[self.classkey].authors.list)\n              .selectAll('.author').each(function(){\n                 d3.select(this).classed('selected',false);\n              });\n              \n            self.selectedauthors[0] = akey;\n            elem.classed('selected',true);\n          }\n          \n          self.generate();  \n        });\n      });      \n  }\n  \n  /* !--Itineraries Generate */\n  \n  generate() {\n    super.generate();\n    \n    var self = this;\n    \n    this.tear_down();\n    \n    // Checks to see if at least one author is selected\n    \n    if (d3.select(self.ui.dom[self.classkey].authors.list).selectAll('a.selected')[0].length == 0) {\n      d3.select(self.ui.dom[self.classkey].selections[0].header).html(\"Select an author\");\n      return;\n    }\n    \n    var merge = [];\n        \n    for(var i=0; i<this.selectedauthors.length; i++) {\n      var slot = i;\n      var akey = this.selectedauthors[i];\n      var header = self.ui.dom[this.classkey].selections[i].header;\n      var view = self.ui.dom[this.classkey].selections[i].view;\n      \n      if (akey != null) {\n        d3.select(header).html(this.authors[akey]);\n        this.routes[i] = this.itineraries[akey];\n        merge = merge.concat(this.itineraries[akey]);\n        d3.select(self.ui.dom[this.classkey].selections[i].view).append('svg')        \n      } else {\n        d3.select(header).html(\"Select an author\");\n        this.routes[i] = null;\n      }\n    }\n                        \n    // Find the earliest and latest itinerary dates\n    var starts = [], ends = [];\n    d3.keys(self.itineraries).forEach(\n      function(d){\n        starts.push(d3.min(self.itineraries[d], function(_d){ return new Date(_d.StartDate); }));\n        ends.push(d3.max(self.itineraries[d], function(_d){ return new Date(_d.EndDate); }));\n    });\n      \n    var earliest_date = d3.min(starts);\n    var latest_date = d3.max(ends);\n                \n    // Set up containers\n        \n    var cheight = this.visHeight \n                    + 16 \n                    + d3.select(self.ui.dom[this.classkey].authors.header).node().getBoundingClientRect().height \n                    + d3.select(self.ui.dom[this.classkey].selections[0].header).node().getBoundingClientRect().height ;\n                        \n    d3.select(self.ui.dom[this.classkey].authors.selections).style('height',cheight + 'px');\n    d3.select(self.ui.dom[this.classkey].elem).style('height',cheight + 'px');\n    d3.select(self.ui.dom[this.classkey].authors.list).style('height',cheight + 'px');\n\n    //Translate days to distance\n    \n    var route_scale = d3.time.scale().domain([earliest_date, latest_date]).range([0, this.visHeight]);\n    \n    // Create Axis\n        \n    var axisScale = d3.time.scale().domain([earliest_date, latest_date]).range([0,this.visHeight]);\n    var yAxis = d3.svg.axis()\n                  .scale(axisScale)\n                  .orient('left')\n                  .tickSize(this.selectionsw * .95, 0)\n                  .tickPadding(-25)\n                  .tickFormat(d3.time.format(\"%Y\"));\n    \n    \n    for(var j=0; j<this.selectedauthors.length; j++) {\n      this.generate_route(j,route_scale,yAxis);\n    } \n        \n  }\n  \n  generate_route(index,route_scale,yAxis) {\n    var self = this;\n    var author_id = this.selectedauthors[index];\n    var route = this.routes[index];\n    var view = self.ui.dom[this.classkey].selections[index].view;\n            \n    if (route == null) {\n      return;\n    }\n    \n    var svg = d3.select(view).select('svg');\n    \n    svg.attr('height', this.visHeight);\n    d3.select(view).style('height',this.visHeight);\n    \n    // add axis to first visualization\n    // var w = this.selectionsw *.95 * .8 -10;\n    var w = this.selectionsw * 0.5;\n\n    if (index==0) {\n      svg.append('g')\n        .attr('id','itinerary-axis')\n        .call(yAxis)\n        .call(function(l){\n          l.style('transform','translateX(' + w + 'px)'); // moves lines into position\n          l.selectAll('text').attr('y',15); // moves labels below lines\n        });\n\n    }\n        \n    //Create route container\n    var route_g = svg.selectAll('g.route_g').data([author_id]);\n    \n    route_g.enter().append('g').classed('route_g',true);\n\n    route_g\n        .attr('class', 'route_g author_' + index)\n        .attr('transform', function(d,i){\n            var x = 0,\n                y = 0;\n            return 'translate(' + x +',' + y +')';\n        });\n        \n    route_g.exit().remove();\n    \n    //Stops\n    var route_rad = 4;\n    var route_stops = route_g.selectAll('circle.route_stops').data(route);\n    route_stops.enter().append('circle').classed('route_stops',true);\n    route_stops\n        .attr('cx',30)\n        .attr('cy',function(d,i){\n            return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\n        })\n        .attr('r',route_rad)\n        .append(\"text\")\n          .attr('class','tip')\n          .text(function(d) {\n    \t\t\t\tvar tooltip = [];\n    \t\t\t\tvar info = []\n\n    \t\t\t\tconsole.log('generating tooltip');\n    \t\t\t\t\n    \t\t\t\tif(typeof self.places[d.PlaceID] == 'undefined') {\n      \t\t\t\ttooltip.push['Location information unspecified or missing.'];\n    \t\t\t\t} else {\n    \t\t\t\t  tooltip.push(self.places[d.PlaceID].PlaceName);\n    \t\t\t\t}\n    \t\t\t\t// Add names and citations\n    \t\t\t\t\n    \t\t\t\tif (d.StartDate != \"\") {\n      \t\t\t\tinfo.push(\" \\nFrom: \" + d.StartDate.toString());\n    \t\t\t\t}\n    \t\t\t\t\n            if(d.StartCitation != \"\") {\n              info.push(\" (\" + d.StartCitation.toString() + \")\")            \n            }    \t\t\t\t\n    \t\t\t\tif (d.EndDate != '') {\n      \t\t\t\tinfo.push(\"\\nUntil: \" + d.EndDate);\n    \t\t\t\t}\n    \t\t\t\t\n    \t\t\t\tif (d.EndDate != '') {\n              info.push(\" (\" + d.StartCitation.toString() + \")\");\n    \t\t\t\t}\n    \t\t\t\t\n\n    \t\t\t\ttooltip.push(info.join(''));\n    \t\t\t\tconsole.log(tooltip);\n      \t\t  \n      \t\t  return tooltip.join(\"<br />\");\n          });\n        route_stops\n          .on('click',function() {\n                        \n  \t\t\t\t\t// Tooltip code.\n  \t\t\t\t\t// Leverages CSS3 Animations instead of D3.\n  \t\t\t\t\t// Fade out and removal of tooltips needs a new methodlogy. \n  \t\t\t\t\t\n  \t\t\t\t\tvar g = d3.select(this);\n  \t\t\t\t\tvar t = d3.select(this).select('text').text();\n  \t\t\t\t\t\n  \t\t\t\t\tvar rect = this.getBoundingClientRect();\n  \t\t\t\t\tvar top = rect.top + window.pageYOffset - 10;\n  \t\t\t\t\tvar left = rect.left + window.pageXOffset + 50;\n  \t\t\t\t\t\n  \t\t\t\t  d3.select('.tooltip').remove();\n  \n\t\t\t\t\td3.select(self.ui.dom.itineraries.elem)\n\t\t\t\t\t  .append('div')\n\t\t\t\t\t  .attr('class','tooltip')\n            .style({\n  \t\t\t\t\t  'top': top + \"px\",\n  \t\t\t\t\t  'left': left + \"px\",\n  \t\t\t\t\t  'bottom' : 'auto',\n  \t\t\t\t\t  'right' : 'auto'\n\t\t\t\t\t  })\n\t\t\t\t\t  .html(t)\n\t\t\t\t\t  .on('click',function() {\n  \t\t\t\t\t  // Click event behaviour for tooltip itself.\n  \t\t\t\t\t  // See notes in “trajectories” above.\n  \t\t\t\t\t  \n  \t\t\t\t\t  d3.select(this)\n  \t\t\t\t      .style({\n    \t\t\t\t      'animation-direction':'reverse',\n    \t\t\t\t      'animaiton-play-state': 'running',\n    \t\t\t\t      'animation-fill-mode': 'backwards'\n    \t\t\t\t      })\n    \t\t\t\t    .transition()\n    \t\t\t\t    .delay(800)\n  \t\t\t\t      .remove();\n  \t\t\t\t  });\n          });\n          \n  \n    route_stops.exit().remove();\n    \n  }\n  \n  \n  \n  route_change(_side){\n      var author_name = d3.select('#'+_side+'_select').property('value');\n      var author_id = this.author_names[author_name];\n            \n      var curr_svg;\n      if(_side == 'left'){ curr_svg = this.left_svg; }\n      else { curr_svg = this.right_svg; }\n\n      var self = this;\n      var visH = this.height*30;\n      curr_svg.attr('height', visH);\n\n      // Find the earliest and latest itinerary dates\n      var starts = [], ends = [];\n      d3.keys(self.itineraries).forEach(\n          function(d){\n              starts.push(d3.min(self.itineraries[d], function(_d){ return new Date(_d.StartDate); }));\n              ends.push(d3.max(self.itineraries[d], function(_d){ return new Date(_d.EndDate); }));\n      });\n\n      var earliest_date = d3.min(starts);\n      var latest_date = d3.max(ends);\n\n      //Translate days to distance\n      var route_scale = d3.time.scale().domain([earliest_date, latest_date]).range([0, visH -150 -60]);\n\n      //Create route container\n      var route_g = curr_svg.selectAll('g.route_g').data(author_id);\n      route_g.enter().append('g').classed('route_g',true);\n      route_g\n          .attr('class', 'route_g author_' + _side)\n          .attr('transform', function(d,i){\n              var x = i*(self.width/2),\n                  y = 75;\n              return 'translate(' + x +',' + y +')';\n          });\n      route_g.exit().remove();\n      \n      //Add background line\n      var route_line_background = route_g.selectAll('line.route_line_background')\n          .data(self.itineraries[author_id]);\n      route_line_background.enter().append('line').classed('route_line_background',true);\n      route_line_background\n          .attr('x1',self.width/4)\n          .attr('y1',function(d,i){ return route_scale(route_scale.domain()[0]); })\n          .attr('x2',self.width/4)\n          .attr('y2',function(d,i){ return route_scale(route_scale.domain()[1]); });\n      route_line_background.exit().remove();\n\n      //Add figure name\n      var route_labels = route_g.selectAll('text.route_label').data(author_id);\n      route_labels.enter().append('text').classed('route_label',true);\n      route_labels\n          .attr('x',self.width/4)\n          .attr('y',-30)\n          .text(author_name);\n      route_labels.exit().remove();\n\n      //Lines\n      var route_line = route_g.selectAll('line.route_line').data(self.itineraries[author_id]);\n      route_line.enter().append('line').classed('route_line',true);\n      route_line\n          .attr('class', 'route_line author_' + _side)\n          .attr('x1',self.width/4)\n          .attr('y1',function(d, i){\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\n          })\n          .attr('x2',self.width/4)\n          .attr('y2',function(d, i){\n              return d.EndDate ? route_scale(new Date(d.EndDate)) : route_scale(new Date(d.StartDate));\n          });\n      route_line.exit().remove();\n\n      //Points\n      var route_points = route_g.selectAll('line.route_points').data(self.itineraries[author_id]);\n      route_points.enter().append('line').classed('route_points',true);\n      route_points\n          .attr('x1',self.width/4 -15)\n          .attr('y1',function(d,i){\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\n          })\n          .attr('x2',self.width/4 +45)\n          .attr('y2',function(d,i){\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\n          });\n      route_points.exit().remove();\n\n      //Stops\n      var route_rad = 3;\n      var route_stops = route_g.selectAll('circle.route_stops').data(self.itineraries[author_id]);\n      route_stops.enter().append('circle').classed('route_stops',true);\n      route_stops\n          .attr('cx',self.width/4 +45)\n          .attr('cy',function(d,i){\n              return d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate));\n          })\n          .attr('r',route_rad);\n      route_stops.exit().remove();\n\n      //Point labels\n      var route_point_labels = route_g.selectAll('text.route_point_labels').data(self.itineraries[author_id]);\n      route_point_labels.enter().append('text').classed('route_point_labels',true);\n      route_point_labels\n          .attr('x',self.width/4 +60)\n          .attr('y',function(d,i){\n              return (d.StartDate ? route_scale(new Date(d.StartDate)) : route_scale(new Date(d.EndDate))) +4;\n          })\n          .text(function(d){\n              var t1 = d.StartDate || 'Unknown',\n                  t2 = d.EndDate || 'Unknown';\n              return self.places[d.PlaceID].PlaceName + ' (' +t1 +' to ' +t2 +')';\n          });\n      route_point_labels.exit().remove();\n\n  }\n\n  generate_routes(){\n      var visH = this.height*6;\n      this.svg.attr('height', visH);\n  }  \n  \n  /* !--Itineraries Tear Down */\n  \n  tear_down() {\n    super.tear_down();\n    var self = this;\n    for(var i=0;i<this.selectedauthors.length;i++) {\n      d3.select(self.ui.dom[this.classkey].selections[i].view).selectAll('*').remove();       \n    } \n  }\n}\n\n/* !SEARCH  */\n\nclass Search extends Visualization {\n\tconstructor() {\n  \tsuper();\n  \tvar self = this;\n  \tthis.ui = new SearchUI();\t  \n  }\n  \n  init() {\n    super.init();\n    var self = this;\n    \n    this.dm.indexData();\n    \n\t\td3.select(self.ui.dom.searchfield).on('input',function(){\n  \t\tif(this.value.length>2) {\n    \t  d3.select(self.ui.dom.searchresults).html(self.dm.DisplaySearchResults(this.value));\n  \t\t}\n\t\t});\n    \n  }\n}\n\n/* INITIALIZATION */\n\n/*\n  Note for refactoring: this should be rethought once a proper MVC structure is in place.\n  \n  Notes for the current structure:\n  \n  - The DataManager class is designed to load JSON data once (on initial load).\n  - It the function passed to it once the dataset is loaded completely.\n\n*/\n\n/*\n\nvar intersections = new Object;\nvar trajectories = new Object;\nvar itineraries = new Object;\n\nd3.select('body').style('opacity',0.3);\n\n// Intersections are initialized immediately. The second argument is a function to handle data-reliant functionality.\n\nvar dm = new DataManager(function(){\n    \n  d3.selectAll(ui.dom.tabs).each(function() {\n  \td3.select(this).on('click',function() {\t\n    \t\t\n  \t\t// Remove active tooltips from the DOM\n  \t\td3.select('.tooltip').remove();\n  \t\t  \t\t    \t\n    \tswitch(d3.select(this).attr('data-mode')) {\n      \tcase '0':\n          d3.select('body').style('position','inherit');\n      \t\td3.select('body').style('bottom','auto');\n      \tbreak;\n      \tcase '1':\n          if (!intersections.hasOwnProperty('initialized')) {\n            intersections = new Intersections;\n            intersections.init();\n          } else {\n            intersections.focus();\n          }\n          break;\n        case '2':      \n          // only initialize once. perhaps should be handled in the init() function itself.\n                  \n          if (!trajectories.hasOwnProperty('initialized')) {\n            trajectories = new Trajectories;\n            trajectories.init();\n          } else {\n            trajectories.focus();\n          }\n\n      \t  break;\n      \tcase '3':\n          if (!itineraries.hasOwnProperty('initialized')) {\n            itineraries = new Itineraries;\n            itineraries.init();\n          } else {\n            itineraries.focus();\n          }\n\n      \t  break;  \n      \t case '4':\n      \t\t// Index when Search tab is clicked.\n      \t\t\n      \t\tdm.indexData();\n      \t\t\n      \t\t// Bind Search Field\n          \t\t\n      \t\td3.select(ui.dom.searchfield).on('input',function(){\n        \t\tif(this.value.length>2) {\n          \t  d3.select(ui.dom.searchresults).html(dm.DisplaySearchResults(this.value));\n        \t\t}\n      \t\t});\n      \t  break;\n    \t}\n  \t});\n  });\n  \n  // console.log(performance.now() / 1000);\n  \n  d3.select('body').transition(200).style('opacity',1);\n  \n  \n});\n\n*/\n\n//custom sub-selections\nd3.selection.prototype.first = function() {\n  return d3.select(this[0][0]);\n};\nd3.selection.prototype.last = function() {\n  var last = this.size() - 1;\n  return d3.select(this[0][last]);\n};"]}